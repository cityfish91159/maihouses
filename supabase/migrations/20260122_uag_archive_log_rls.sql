-- =============================================================================
-- UAG Archive Log RLS 設定
-- Migration: 20260122_uag_archive_log_rls.sql
-- =============================================================================
--
-- 修復: Supabase Security Advisor 警告
-- "Table public.uag_archive_log is public, but RLS has not been enabled"
--
-- 此表為內部系統日誌，只由 pg_cron 排程寫入，前端用戶無需存取
--
-- =============================================================================

-- ============================================================================
-- 1. 啟用 RLS
-- ============================================================================
ALTER TABLE public.uag_archive_log ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- 2. Policy: service_role 完全存取
-- ============================================================================
-- 後端 API 和 pg_cron 使用 service_role，需要讀寫權限
CREATE POLICY "service_role_full_access"
ON public.uag_archive_log
FOR ALL
TO service_role
USING (true)
WITH CHECK (true);

-- ============================================================================
-- 3. 禁止 anon / authenticated 存取
-- ============================================================================
-- 這是內部日誌表，一般用戶不需要存取
-- RLS 啟用後，沒有 policy 的角色預設無權限

-- ============================================================================
-- 完成
-- ============================================================================
--
-- 驗證指令：
-- SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'uag_archive_log';
-- 預期結果: rowsecurity = true
--
-- =============================================================================
