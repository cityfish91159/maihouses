-- =============================================================================
-- UAG Lead Purchases RLS 設定
-- Migration: 20260122_uag_lead_purchases_rls.sql
-- =============================================================================
--
-- 修復: Supabase Security Advisor 警告
-- "Table public.uag_lead_purchases is public, but RLS has not been enabled"
--
-- =============================================================================

-- ============================================================================
-- 1. 啟用 RLS
-- ============================================================================
ALTER TABLE public.uag_lead_purchases ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- 2. Policy: service_role 完全存取
-- ============================================================================
-- 後端 API 使用 service_role key，需要完整讀寫權限
CREATE POLICY "service_role_full_access"
ON public.uag_lead_purchases
FOR ALL
TO service_role
USING (true)
WITH CHECK (true);

-- ============================================================================
-- 3. Policy: authenticated 用戶只能查看自己的購買紀錄
-- ============================================================================
-- 房仲只能看到自己購買的客戶
CREATE POLICY "agents_view_own_purchases"
ON public.uag_lead_purchases
FOR SELECT
TO authenticated
USING (agent_id = auth.uid()::text);

-- ============================================================================
-- 4. 禁止 anon 存取
-- ============================================================================
-- 匿名用戶完全無法存取購買紀錄
-- RLS 啟用後，沒有 policy 的角色預設無權限，無需額外設定

-- ============================================================================
-- 完成
-- ============================================================================
--
-- 驗證指令：
-- SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'uag_lead_purchases';
-- 預期結果: rowsecurity = true
--
-- =============================================================================
