# .github/workflows/ai-guard.yml
name: AI Guard - é›¶ä¿¡ä»»ç›£å·¥

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ai-guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: TypeScript Check
        run: npm run typecheck
      
      - name: Find AI Tasks
        id: find-tasks
        run: |
          if [ -d "ai-tasks" ]; then
            TASKS=$(ls -d ai-tasks/TASK-* 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "")
            echo "task=$TASKS" >> $GITHUB_OUTPUT
          fi
      
      # 0. è‡ªå‹•è§¸ç™¼
      - name: AI Auto Trigger - Enforce Rules
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-auto-trigger.ts enforce ${{ steps.find-tasks.outputs.task }}
      
      # 3. 80åˆ† HARD GATE
      - name: AI Score Gate
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-score-gate.ts ${{ steps.find-tasks.outputs.task }}
      
      # 4. å·æ‡¶åµæ¸¬
      - name: AI Laziness Detector
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-laziness-detector.ts ${{ steps.find-tasks.outputs.task }}
      
      # 5. å ±å‘Šé »ç‡æª¢æŸ¥
      - name: AI Reporter Check
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-reporter.ts check ${{ steps.find-tasks.outputs.task }}
      
      # 6. å®Œæˆé©—è­‰
      - name: AI Completion Verify
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-completion.ts ${{ steps.find-tasks.outputs.task }}
      
      # 7. Mutation Testing
      - name: AI Mutation Test
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-mutation-test.ts ${{ steps.find-tasks.outputs.task }}
        continue-on-error: true
      
      # 8. Contract Test
      - name: AI Contract Test
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-contract-test.ts ${{ steps.find-tasks.outputs.task }}
      
      # 9. Hermetic Build
      - name: AI Hermetic Build
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-hermetic-build.ts ${{ steps.find-tasks.outputs.task }}
      
      # 10. Diff Complexity Gate
      - name: AI Diff Gate
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-diff-gate.ts ${{ steps.find-tasks.outputs.task }}
      
      # 11. SBOM + ä¾è³´æƒæ
      - name: AI SBOM Scan
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-sbom-scan.ts ${{ steps.find-tasks.outputs.task }}
      
      # 12. è¡Œç‚ºå±¤å°å°
      - name: AI Behavior Seal
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-behavior-seal.ts ${{ steps.find-tasks.outputs.task }}
        continue-on-error: true
      
      # 13. æ•¸å­¸ç´šé©—è­‰
      - name: AI Math Verify
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-math-verify.ts ${{ steps.find-tasks.outputs.task }}
      
      - name: AI Heartbeat Check
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-heartbeat.ts ${{ steps.find-tasks.outputs.task }}
      
      - name: AI Progress Verify
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-progress-verify.ts ${{ steps.find-tasks.outputs.task }}
      
      - name: AI Spec Guard
        if: steps.find-tasks.outputs.task != ''
        run: npx ts-node --project scripts/tsconfig.json scripts/ai-spec-guard.ts ${{ steps.find-tasks.outputs.task }}
      
      - name: Score Gate
        if: failure()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘ ğŸ’€ AI ç›£å·¥åˆ¤å®šï¼šå¤±æ•—                                         â•‘"
          echo "â•‘ åˆ†æ•¸ä½æ–¼ 80 æˆ–è¦æ ¼ä¸ç¬¦                                       â•‘"
          echo "â•‘ PR å°‡è¢«è‡ªå‹•æ‹’çµ•                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
