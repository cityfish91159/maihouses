# ============================================================================
# Hard Gate (ä¸å¯ç¹é) - Server-Side Enforcement
# ============================================================================
# é€™æ˜¯çœŸæ­£çš„ç‰©ç†é˜»æ–·ï¼Œå³ä½¿æœ¬åœ°ç¹é git hooksï¼ŒGitHub ä¹Ÿæœƒæ“‹ä½
# ============================================================================

name: Hard Gate (ä¸å¯ç¹é)

on: [push, pull_request]

jobs:
  gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript æª¢æŸ¥
        run: npm run typecheck

      - name: ESLint æª¢æŸ¥
        run: npm run lint

      - name: G6 å·æ‡¶ä»£ç¢¼æª¢æŸ¥
        run: |
          echo "ğŸ” æª¢æŸ¥å·æ‡¶ä»£ç¢¼..."
          FAIL=0

          # æª¢æŸ¥ `: any` é¡å‹ï¼ˆæ’é™¤è¨»è§£å’Œ catch èªå¥ï¼‰
          # ä½¿ç”¨æ›´ç²¾ç¢ºçš„ pattern é¿å… false positive
          echo "æª¢æŸ¥ any é¡å‹..."
          ANY_COUNT=$(grep -rn ": any\b" --include="*.ts" --include="*.tsx" src/ \
            | grep -v "^\s*//" \
            | grep -v "catch\s*(.*:\s*any)" \
            | grep -v "\.d\.ts:" \
            | wc -l || echo 0)
          if [ "$ANY_COUNT" -gt 0 ]; then
            echo "âš ï¸ ç™¼ç¾ $ANY_COUNT è™•å¯èƒ½çš„ any é¡å‹"
            grep -rn ": any\b" --include="*.ts" --include="*.tsx" src/ \
              | grep -v "^\s*//" \
              | grep -v "catch\s*(.*:\s*any)" \
              | grep -v "\.d\.ts:" \
              | head -10
            # è­¦å‘Šä½†ä¸é˜»æ­¢ï¼ˆESLint æœƒè™•ç†ï¼‰
          else
            echo "âœ“ ç„¡ any é¡å‹"
          fi

          # æª¢æŸ¥ @ts-ignoreï¼ˆåš´æ ¼é˜»æ­¢ï¼‰
          echo "æª¢æŸ¥ @ts-ignore..."
          if grep -rn "@ts-ignore\|@ts-nocheck" --include="*.ts" --include="*.tsx" src/; then
            echo "âŒ ç™¼ç¾ @ts-ignore æˆ– @ts-nocheckï¼"
            FAIL=1
          else
            echo "âœ“ ç„¡ @ts-ignore"
          fi

          # æª¢æŸ¥ eslint-disableï¼ˆåš´æ ¼é˜»æ­¢ï¼‰
          echo "æª¢æŸ¥ eslint-disable..."
          if grep -rn "eslint-disable" --include="*.ts" --include="*.tsx" src/; then
            echo "âŒ ç™¼ç¾ eslint-disableï¼"
            FAIL=1
          else
            echo "âœ“ ç„¡ eslint-disable"
          fi

          # æª¢æŸ¥ console.logï¼ˆåƒ…è­¦å‘Šï¼Œä¸é˜»æ­¢ï¼‰
          echo "æª¢æŸ¥ console.log..."
          CONSOLE_COUNT=$(grep -rn "console\.log(" --include="*.ts" --include="*.tsx" src/ \
            | grep -v "\.test\." \
            | grep -v "__tests__" \
            | wc -l || echo 0)
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "âš ï¸ ç™¼ç¾ $CONSOLE_COUNT è™• console.log (éé˜»æ­¢æ€§è­¦å‘Š)"
          else
            echo "âœ“ ç„¡ console.log"
          fi

          if [ "$FAIL" -eq 1 ]; then
            echo ""
            echo "âŒ å·æ‡¶ä»£ç¢¼æª¢æŸ¥å¤±æ•—"
            exit 1
          fi

          echo "âœ… å·æ‡¶ä»£ç¢¼æª¢æŸ¥é€šé"

      - name: Build æª¢æŸ¥
        run: npm run build
