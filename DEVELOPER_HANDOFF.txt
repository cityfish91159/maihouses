╔═══════════════════════════════════════════════════════════════════════════╗
║            📦 開發者交接包 - 新開發人員快速上手指南                      ║
╚═══════════════════════════════════════════════════════════════════════════╝

親愛的開發者，歡迎接手 AI 顏色回填模組！
這份文件會讓你在 10 分鐘內完全上手。

═══════════════════════════════════════════════════════════════════════════

📋 第一步：環境設定 (5 分鐘)
───────────────────────────────────────────────────────────────────────────

1. Clone 專案並安裝依賴：

   git clone https://github.com/cityfish91159/maihouses.git
   cd maihouses
   npm install

2. 設定環境變數：

   cp .env.example .env
   nano .env

   必填項目：
   ✓ OPENAI_API_KEY=sk-proj-xxxxx (必須)
   ✓ REPLICATE_API_TOKEN=r8_xxxxx (已設定好)
   ✓ REPLICATE_DEPLOYMENT=cityfish91159/maihouses-flux (已設定好)
   ✓ REPLICATE_DEPLOYMENT_DETECT=cityfish91159/maihouses-detect (已設定好)
   
   選填項目 (沒有也能運作)：
   ○ AWS_S3_BUCKET, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
   ○ IMGIX_DOMAIN
   
   💡 只需要填入 OPENAI_API_KEY 就可以開始開發！

3. 啟動開發伺服器：

   npm run dev

4. 開啟瀏覽器測試：

   http://localhost:5173/tools/cake-reveal/ai-color-recolor-m.html

═══════════════════════════════════════════════════════════════════════════

📂 專案結構 (需要知道的核心檔案)
───────────────────────────────────────────────────────────────────────────

maihouses/
│
├── 🎨 前端 (主要工作區)
│   └── public/tools/cake-reveal/
│       └── ai-color-recolor-m.html    ← 前端主檔案 (870 行)
│
├── ⚙️  後端 API (4 個端點)
│   ├── api/openai-proxy.js            ← OpenAI Vision 分析
│   ├── api/replicate-detect.js        ← 物體檢測
│   ├── api/replicate-generate.js      ← 圖像增強
│   └── api/upload-imgix.js            ← 圖片上傳
│
├── 📚 文件 (重要！先讀這些)
│   ├── AI_COLOR_RECOLOR_API_GUIDE.txt ← 完整 API 說明 (必讀)
│   ├── AI_RECOLOR_QUICK_REF.txt       ← 快速參考卡
│   ├── API_FIX_REPORT.txt             ← API 修正報告
│   ├── SETUP_GUIDE.txt                ← 設定指南
│   └── DEVELOPER_HANDOFF.txt          ← 本檔案
│
└── 🧪 測試
    └── test-ai-recolor-apis.sh        ← 自動測試腳本

═══════════════════════════════════════════════════════════════════════════

🔄 資料流程 (理解系統運作)
───────────────────────────────────────────────────────────────────────────

用戶上傳圖片
    ↓
[前端] FileReader 讀取為 base64
    ↓
[後端] POST /api/openai-proxy
    → OpenAI GPT-4 Vision 分析圖片內容
    ← 返回：物體、顏色、光照、建議參數
    ↓
[後端] POST /api/upload-imgix
    → 上傳圖片到 S3 (或降級為 base64)
    ← 返回：imgix URL
    ↓
[後端] POST /api/replicate-detect
    → GroundingDINO 物體檢測
    ← 返回：bounding boxes + labels
    ↓
[後端] POST /api/replicate-generate
    → Flux Pro AI 增強圖片
    ← 返回：增強後的圖片 URL
    ↓
[前端] imgix Blend API
    → 混合原圖與增強圖 (screen mode)
    ← 返回：混合後的圖片
    ↓
[前端] Canvas LAB 色彩空間處理
    → RGB → LAB 轉換
    → 保留原圖色度 (a/b)，使用增強圖亮度 (L)
    → LAB → RGB 轉換
    ← 返回：最終校正圖片
    ↓
顯示結果給用戶

處理時間：17-34 秒 (1024x1024 圖片)

═══════════════════════════════════════════════════════════════════════════

🎯 核心技術棧
───────────────────────────────────────────────────────────────────────────

前端：
• 純 JavaScript (ES6+)
• Canvas API (圖像處理)
• FileReader API (檔案讀取)
• Fetch API (HTTP 請求)
• LAB 色彩空間演算法

後端：
• Vercel Serverless Functions
• Node.js
• AWS SDK v3 (@aws-sdk/client-s3)
• OpenAI API (gpt-4o vision)
• Replicate API (Flux, GroundingDINO)

═══════════════════════════════════════════════════════════════════════════

🧪 測試你的設定
───────────────────────────────────────────────────────────────────────────

1. 快速測試所有 API：
   
   chmod +x test-ai-recolor-apis.sh
   ./test-ai-recolor-apis.sh

2. 測試單一 API：
   
   # OpenAI (必須能通過)
   curl -X POST http://localhost:3000/api/openai-proxy \
     -H "Content-Type: application/json" \
     -d '{"model":"gpt-4o","messages":[{"role":"user","content":"hello"}]}'
   
   # 應該看到 200 回應

3. 前端測試：
   
   a. 開啟頁面
   b. 點擊「選擇圖片」
   c. 上傳測試圖片
   d. 確認「🎨 AI回填」已勾選
   e. 觀察處理進度
   f. 檢查 Console 是否有錯誤

═══════════════════════════════════════════════════════════════════════════

💡 開發建議
───────────────────────────────────────────────────────────────────────────

1. 先閱讀這些文件 (30 分鐘)：
   □ AI_RECOLOR_QUICK_REF.txt (快速了解)
   □ AI_COLOR_RECOLOR_API_GUIDE.txt (深入理解)
   □ API_FIX_REPORT.txt (了解已修正的問題)

2. 理解關鍵函數 (在 ai-color-recolor-m.html 中)：
   □ processWithAI() - 主要處理流程
   □ analyzeImageWithOpenAI() - OpenAI 分析
   □ uploadToImgix() - 圖片上傳
   □ detectObjectsWithReplicate() - 物體檢測
   □ enhanceWithReplicateFlux() - 圖像增強
   □ labColorRestore() - LAB 色彩校正

3. 開發時的最佳實踐：
   • 使用瀏覽器 DevTools 查看網路請求
   • 檢查 Console 的錯誤訊息
   • 測試不同尺寸的圖片
   • 注意 API 配額限制

═══════════════════════════════════════════════════════════════════════════

🚨 常見問題 (FAQ)
───────────────────────────────────────────────────────────────────────────

Q: 我只設定了 OPENAI_API_KEY，系統能運作嗎？
A: 可以！upload-imgix.js 會自動降級為 base64 模式。

Q: 為什麼處理這麼慢？
A: 這是正常的。Replicate Flux 需要 10-20 秒。可以優化：
   - 減少圖片尺寸
   - 使用較快的模型
   - 實作快取機制

Q: CORS 錯誤怎麼辦？
A: 檢查：
   1. API 檔案中的 CORS headers
   2. imgix Dashboard 的 CORS 設定
   3. 瀏覽器的安全政策

Q: 如何修改 AI 參數？
A: 編輯 ai-color-recolor-m.html 中的：
   - analyzeImageWithOpenAI() 的 prompt
   - enhanceWithReplicateFlux() 的 prompt
   - labColorRestore() 的混合比例

Q: 如何添加新的 AI 模型？
A: 參考現有的 replicate-generate.js，新增一個類似的 API 端點。

═══════════════════════════════════════════════════════════════════════════

🔧 修改與擴充指南
───────────────────────────────────────────────────────────────────────────

要修改前端 UI：
→ 編輯 public/tools/cake-reveal/ai-color-recolor-m.html
   (HTML + CSS + JavaScript 都在同一個檔案)

要修改 API 邏輯：
→ 編輯 api/*.js 檔案

要調整 LAB 顏色演算法：
→ 修改 labColorRestore() 函數中的混合比例：
   enhLab[0] * 0.7 + origLab[0] * 0.3  // 亮度混合
   可以改成 0.8/0.2 或其他比例

要添加新功能：
1. 在前端添加 UI 控制
2. 修改 processWithAI() 流程
3. 如需要，新增 API 端點
4. 更新文件

═══════════════════════════════════════════════════════════════════════════

📊 效能指標 (參考)
───────────────────────────────────────────────────────────────────────────

1024x1024 圖片的處理時間：
• OpenAI Vision: 2-4 秒
• imgix 上傳: 1-2 秒
• Replicate 檢測: 3-5 秒
• Replicate Flux: 10-20 秒 ← 最耗時
• imgix 混合: 1-2 秒
• LAB 處理: 1-3 秒
─────────────────────────
總計: 17-34 秒

優化建議：
• 實作圖片快取
• 預先縮放大圖
• 使用更快的 Replicate 模型
• 考慮並行處理某些步驟

═══════════════════════════════════════════════════════════════════════════

💰 API 成本 (重要！)
───────────────────────────────────────────────────────────────────────────

每次處理的成本：
• OpenAI GPT-4 Vision: ~$0.01
• Replicate Detection: ~$0.0005
• Replicate Flux: ~$0.05
• imgix + S3: ~$0.0002
─────────────────────────
每次: ~$0.06

1000 次處理: ~$60

建議：
• 實作使用者配額限制
• 添加快取避免重複處理
• 考慮付費方案

═══════════════════════════════════════════════════════════════════════════

🚀 部署到生產環境
───────────────────────────────────────────────────────────────────────────

1. 在 Vercel Dashboard 設定環境變數：
   
   https://vercel.com/你的帳號/maihouses/settings/environment-variables
   
   必須設定：
   • OPENAI_API_KEY
   • REPLICATE_API_TOKEN
   • REPLICATE_DEPLOYMENT
   • REPLICATE_DEPLOYMENT_DETECT
   
   建議設定 (生產環境)：
   • AWS_S3_BUCKET
   • AWS_S3_REGION
   • AWS_ACCESS_KEY_ID
   • AWS_SECRET_ACCESS_KEY
   • IMGIX_DOMAIN

2. 部署：
   
   vercel --prod

3. 測試生產環境：
   
   curl https://你的網域.vercel.app/api/openai-proxy \
     -X POST -H "Content-Type: application/json" \
     -d '{"model":"gpt-4o","messages":[{"role":"user","content":"test"}]}'

═══════════════════════════════════════════════════════════════════════════

📞 需要幫助？
───────────────────────────────────────────────────────────────────────────

1. 查看完整 API 文件：
   cat AI_COLOR_RECOLOR_API_GUIDE.txt

2. 快速參考：
   cat AI_RECOLOR_QUICK_REF.txt

3. 提出 Issue：
   https://github.com/cityfish91159/maihouses/issues

4. 查看程式碼：
   • 前端主檔案: public/tools/cake-reveal/ai-color-recolor-m.html
   • 後端 API: api/*.js

═══════════════════════════════════════════════════════════════════════════

✅ 檢查清單 (確保你已完成)
───────────────────────────────────────────────────────────────────────────

□ npm install 完成
□ .env 檔案已建立並填入 OPENAI_API_KEY
□ npm run dev 可以正常啟動
□ 可以開啟 http://localhost:5173/tools/cake-reveal/ai-color-recolor-m.html
□ 已閱讀 AI_RECOLOR_QUICK_REF.txt
□ 已測試上傳圖片功能
□ 理解資料流程
□ 知道如何查看 API 文件

完成以上檢查，你就可以開始開發了！🎉

═══════════════════════════════════════════════════════════════════════════

祝開發順利！
有問題隨時查看文件或提出 Issue。

最後更新: 2025-11-12
═══════════════════════════════════════════════════════════════════════════
