<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b1220">
<link rel="manifest" href="/manifest.json">
<title>ğŸ‚ è›‹ç³•é  v14.0 - å­¸è¡“ç´šé€è¦–ç³»çµ±</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #0b1220;
  --panel: #0f1b2e;
  --card: #142336;
  --text: #e9f0ff;
  --brand: #2be38a;
  --accent: #3b82f6;
  --border: #1b2a45;
  --btn: #20314f;
  --warning: #ff9500;
  --success: #2be38a;
  --error: #ef4444;
}

html, body {
  width: 100%;
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Text', sans-serif;
  overflow: hidden;
  position: fixed;
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}

.container {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  padding: 16px;
  gap: 16px;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
}

header {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

h1 {
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--brand), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.badge {
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 16px;
  background: rgba(13, 26, 48, 0.8);
  backdrop-filter: blur(10px);
  color: #cde1ff;
  font-size: 12px;
  font-weight: 600;
}

.cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

@media (min-width: 768px) {
  .cards {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1200px) {
  .cards {
    grid-template-columns: repeat(3, 1fr);
  }
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--brand), var(--accent));
  opacity: 0;
  transition: opacity 0.3s;
}

.card:hover::before {
  opacity: 1;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  border-color: var(--brand);
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-icon {
  font-size: 24px;
}

.card-desc {
  font-size: 13px;
  color: #8aa2d2;
  margin-bottom: 16px;
  line-height: 1.5;
}

.btn {
  background: var(--btn);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 12px;
  padding: 14px 20px;
  font-weight: 600;
  cursor: pointer;
  font-size: 15px;
  min-height: 52px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  touch-action: manipulation;
  position: relative;
  overflow: hidden;
  width: 100%;
}

.btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at center, rgba(255,255,255,0.1), transparent);
  opacity: 0;
  transition: opacity 0.3s;
}

.btn:hover:not(:disabled)::before {
  opacity: 1;
}

.btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}

.btn:active:not(:disabled) {
  transform: translateY(0) scale(0.98);
}

.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
}

.btn.primary {
  background: linear-gradient(135deg, var(--brand), #20a96f);
  border-color: #0b3c25;
  color: #072412;
  font-weight: 700;
}

.btn.accent {
  background: linear-gradient(135deg, var(--accent), #2563eb);
  border-color: #1e40af;
  color: white;
}

.btn-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.preview-card {
  grid-column: 1 / -1;
}

.preview {
  position: relative;
  background: linear-gradient(135deg, #0a0f1a 0%, #141d2e 100%);
  border: 2px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 500px;
  max-height: 70vh;
}

#canvas {
  max-width: 100%;
  max-height: 100%;
  display: block;
  object-fit: contain;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

.preview-overlay {
  position: absolute;
  top: 16px;
  right: 16px;
  background: rgba(11, 18, 32, 0.9);
  backdrop-filter: blur(10px);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  color: var(--brand);
  border: 1px solid var(--border);
}

.control-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 12px;
  background: rgba(11, 18, 32, 0.3);
  border-radius: 12px;
  border: 1px solid rgba(27, 42, 69, 0.3);
}

.control-label {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  color: #b7c7e6;
  font-weight: 600;
}

.control-value {
  color: var(--brand);
  font-variant-numeric: tabular-nums;
}

input[type="range"] {
  width: 100%;
  height: 8px;
  -webkit-appearance: none;
  background: var(--border);
  border-radius: 4px;
  outline: none;
  position: relative;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--brand);
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(43, 227, 138, 0.4);
  transition: all 0.2s;
}

input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 4px 12px rgba(43, 227, 138, 0.6);
}

select {
  background: var(--btn);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

select:hover {
  border-color: var(--brand);
}

#info {
  font-size: 14px;
  color: #7a92c0;
  padding: 16px;
  background: rgba(27, 42, 69, 0.3);
  border-radius: 12px;
  min-height: 52px;
  display: flex;
  align-items: center;
  gap: 10px;
  border: 1px solid rgba(27, 42, 69, 0.5);
  backdrop-filter: blur(5px);
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--brand);
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.8); }
}

.loading {
  position: fixed;
  inset: 0;
  background: rgba(8, 12, 20, 0.98);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(10px);
}

.loading.show {
  display: flex;
}

.loading-content {
  text-align: center;
  padding: 32px;
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: 20px;
  min-width: 320px;
  max-width: 90vw;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.loading-icon {
  font-size: 48px;
  margin-bottom: 16px;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.loading-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--brand);
}

.loading-text {
  font-size: 14px;
  color: #8aa2d2;
  margin-bottom: 20px;
  min-height: 20px;
}

.progress-bar {
  width: 100%;
  height: 10px;
  background: var(--border);
  border-radius: 5px;
  overflow: hidden;
  margin: 20px 0;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--brand), var(--accent));
  width: 0%;
  transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.3),
    transparent
  );
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.history-bar {
  display: flex;
  gap: 8px;
  padding: 12px;
  background: rgba(11, 18, 32, 0.5);
  border-radius: 12px;
  border: 1px solid var(--border);
  align-items: center;
}

.history-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--border);
  cursor: pointer;
  transition: all 0.2s;
}

.history-dot.active {
  background: var(--brand);
  transform: scale(1.5);
}

.history-dot:hover {
  background: var(--accent);
  transform: scale(1.3);
}

.install-prompt {
  background: linear-gradient(135deg, var(--brand), var(--accent));
  color: white;
  padding: 16px;
  border-radius: 12px;
  display: none;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  box-shadow: 0 4px 16px rgba(43, 227, 138, 0.3);
}

.install-prompt.show {
  display: flex;
}

.tab-bar {
  display: flex;
  gap: 8px;
  padding: 4px;
  background: var(--panel);
  border-radius: 12px;
  border: 1px solid var(--border);
}

.tab {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  background: transparent;
  color: #7a92c0;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.tab.active {
  background: var(--brand);
  color: #072412;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

hr {
  border: none;
  border-top: 1px solid var(--border);
  margin: 16px 0;
  opacity: 0.5;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: rgba(43, 227, 138, 0.1);
  color: var(--brand);
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid rgba(43, 227, 138, 0.2);
}

/* iOS ç‰¹å®šå„ªåŒ– */
@supports (-webkit-touch-callout: none) {
  body {
    cursor: pointer;
  }

  .btn {
    -webkit-tap-highlight-color: transparent;
  }
}

/* æ¸›å°‘å‹•ç•«ä»¥ç¯€çœé›»é‡ */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="install-prompt" id="installPrompt">
    <div style="flex: 1;">
      <div style="font-weight: 700; margin-bottom: 4px;">ğŸ“± å®‰è£ç‚º App</div>
      <div style="font-size: 12px; opacity: 0.9;">ç²å¾—æ›´å¿«çš„å•Ÿå‹•é€Ÿåº¦å’Œé›¢ç·šåŠŸèƒ½</div>
    </div>
    <button class="btn" id="installBtn" style="min-width: 100px;">å®‰è£</button>
  </div>

  <header>
    <h1>ğŸ‚ è›‹ç³•é </h1>
    <span class="badge">v14.0</span>
    <span class="badge">å­¸è¡“ç´šé€è¦–</span>
    <span class="badge">iOS å„ªåŒ–</span>
  </header>

  <div class="cards">
    <!-- é è¦½å¡ç‰‡ -->
    <div class="card preview-card">
      <div class="card-title">
        <span class="card-icon">ğŸ–¼ï¸</span>
        é è¦½å€åŸŸ
      </div>
      <div class="preview">
        <canvas id="canvas"></canvas>
        <div class="preview-overlay" id="dimensions" style="display: none;">
          <span id="dimText"></span>
        </div>
      </div>
      <div id="info">
        <div class="status-dot"></div>
        <span id="infoText">â³ è«‹ä¸Šå‚³åœ–ç‰‡é–‹å§‹è™•ç†</span>
      </div>
    </div>

    <!-- ä¸Šå‚³ & AI ç”Ÿæˆ -->
    <div class="card">
      <div class="card-title">
        <span class="card-icon">ğŸ“¤</span>
        åœ–ç‰‡ä¾†æº
      </div>
      <div class="card-desc">ä¸Šå‚³åœ–ç‰‡æˆ–ä½¿ç”¨ AI ç”Ÿæˆæ–°åœ–ç‰‡</div>

      <label class="btn primary" style="cursor: pointer; margin-bottom: 12px;">
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        <span>ğŸ“‚</span> ä¸Šå‚³åœ–ç‰‡
      </label>

      <button class="btn accent" id="btnGenerate">
        <span>ğŸ¨</span> AI ç”Ÿåœ–
      </button>

      <hr>

      <button class="btn" id="btnUploadImgix">
        <span>â˜ï¸</span> ä¸Šå‚³é›²ç«¯
      </button>
    </div>

    <!-- AI åˆ†æå·¥å…· -->
    <div class="card">
      <div class="card-title">
        <span class="card-icon">ğŸ¤–</span>
        AI åˆ†æå·¥å…·
      </div>
      <div class="card-desc">ä½¿ç”¨ AI åµæ¸¬ã€åˆ†æå’Œè¦–è¦ºåŒ–åœ–ç‰‡å…§å®¹</div>

      <div class="btn-grid">
        <button class="btn" id="btnDetect">
          <span>ğŸ”</span> ç‰©ä»¶åµæ¸¬
        </button>
        <button class="btn" id="btnAnalyze">
          <span>ğŸ§ </span> AI åˆ†æ
        </button>
      </div>

      <button class="btn" id="btnVisualize" style="margin-top: 12px;">
        <span>ğŸ“Š</span> è¦–è¦ºåŒ–åµæ¸¬
      </button>

      <div id="detectionInfo" style="margin-top: 12px; font-size: 12px; color: #7a92c0; padding: 10px; background: rgba(27, 42, 69, 0.2); border-radius: 8px; display: none;">
        åµæ¸¬çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡
      </div>
    </div>

    <!-- å­¸è¡“ç´šé€è¦–è™•ç† -->
    <div class="card">
      <div class="card-title">
        <span class="card-icon">ğŸ”¬</span>
        å­¸è¡“ç´šé€è¦–
      </div>
      <div class="card-desc">
        èåˆ Retinex MSR + CLAHE + Wavelet + Canny + CNN/GAN
      </div>

      <div class="tab-bar">
        <button class="tab active" data-tab="basic">åŸºç¤</button>
        <button class="tab" data-tab="advanced">é€²éš</button>
      </div>

      <div class="tab-content active" id="basicTab" style="margin-top: 16px;">
        <div class="control-group">
          <div class="control-label">
            <span>è™•ç†å¼•æ“</span>
          </div>
          <select id="xrayEngine">
            <option value="local">âš¡ å¿«é€Ÿæœ¬åœ°è™•ç† (Web Worker)</option>
            <option value="api">ğŸ”¬ é«˜è³ªé‡ API (X-Ray Mike)</option>
          </select>
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>é€è¦–æ¨¡å¼</span>
          </div>
          <select id="xrayMode">
            <option value="neutral">ğŸ¯ æ¨™æº–é€è¦–</option>
            <option value="clahe">ğŸ”¬ CLAHE å°æ¯”</option>
            <option value="adaptive">ğŸ§  è‡ªé©æ‡‰å¢å¼·</option>
            <option value="gain-fast">âš¡ å¿«é€Ÿå¢ç›Š</option>
            <option value="gradient">ğŸŒˆ æ¢¯åº¦ç†±åœ–</option>
            <option value="retinex">ğŸŒŸ Retinex MSR</option>
            <option value="wavelet">ğŸŒŠ å°æ³¢åˆ†è§£</option>
          </select>
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>é€è¦–å¼·åº¦</span>
            <span class="control-value" id="xrayK_v">4.5</span>
          </div>
          <input type="range" id="xrayK" min="0" max="12" step="0.1" value="4.5">
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>éŠ³åŒ–å¼·åº¦</span>
            <span class="control-value" id="usmK_v">1.0</span>
          </div>
          <input type="range" id="usmK" min="0" max="3" step="0.1" value="1.0">
        </div>
      </div>

      <div class="tab-content" id="advancedTab" style="margin-top: 16px;">
        <div class="control-group">
          <div class="control-label">
            <span>é‚Šç·£æª¢æ¸¬</span>
            <span class="control-value" id="edge_v">0.4</span>
          </div>
          <input type="range" id="edge" min="0" max="1" step="0.05" value="0.4">
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>å°æ¯”åº¦</span>
            <span class="control-value" id="contrast_v">1.0</span>
          </div>
          <input type="range" id="contrast" min="0.5" max="2" step="0.1" value="1.0">
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>äº®åº¦</span>
            <span class="control-value" id="brightness_v">0</span>
          </div>
          <input type="range" id="brightness" min="-50" max="50" step="1" value="0">
        </div>

        <div class="control-group">
          <div class="control-label">
            <span>é£½å’Œåº¦</span>
            <span class="control-value" id="saturation_v">1.0</span>
          </div>
          <input type="range" id="saturation" min="0" max="2" step="0.1" value="1.0">
        </div>
      </div>

      <button class="btn primary" id="btnApply" style="margin-top: 16px;">
        <span>âœ¨</span> å¥—ç”¨è™•ç†
      </button>
    </div>

    <!-- æ“ä½œå·¥å…· -->
    <div class="card">
      <div class="card-title">
        <span class="card-icon">ğŸ› ï¸</span>
        æ“ä½œå·¥å…·
      </div>

      <div class="history-bar" id="historyBar">
        <div style="font-size: 12px; color: #7a92c0; font-weight: 600;">æ­·å²:</div>
      </div>

      <div class="btn-grid" style="margin-top: 12px;">
        <button class="btn" id="btnUndo">
          <span>â†©ï¸</span> å¾©åŸ
        </button>
        <button class="btn" id="btnReset">
          <span>âš™ï¸</span> é‡ç½®
        </button>
      </div>

      <button class="btn accent" id="btnDL" style="margin-top: 12px;">
        <span>ğŸ’¾</span> ä¸‹è¼‰åœ–ç‰‡
      </button>

      <hr>

      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <div class="chip" id="performanceChip">
          <span>âš¡</span>
          <span id="performanceText">æº–å‚™ä¸­</span>
        </div>
        <div class="chip" id="memoryChip">
          <span>ğŸ’¾</span>
          <span id="memoryText">--</span>
        </div>
      </div>
    </div>

    <!-- ç³»çµ±è³‡è¨Š -->
    <div class="card">
      <div class="card-title">
        <span class="card-icon">â„¹ï¸</span>
        ç³»çµ±è³‡è¨Š
      </div>
      <div style="font-size: 13px; color: #8aa2d2; line-height: 1.8;">
        <div><strong>ç‰ˆæœ¬:</strong> v14.0 å­¸è¡“ç´šé€è¦–ç³»çµ±</div>
        <div><strong>è¨­å‚™:</strong> <span id="deviceInfo">åµæ¸¬ä¸­...</span></div>
        <div><strong>Canvas é™åˆ¶:</strong> <span id="canvasLimit">--</span></div>
        <div><strong>API ç‹€æ…‹:</strong> <span id="apiStatus">âœ… å°±ç·’</span></div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
          <strong>å·²æ•´åˆ API (6å€‹):</strong>
          <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
            <span class="chip">Replicate Generate</span>
            <span class="chip">Replicate Detect</span>
            <span class="chip">OpenAI Proxy</span>
            <span class="chip">Visualize</span>
            <span class="chip">Upload Imgix</span>
            <span class="chip">X-Ray Mike</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="loading" id="loading">
  <div class="loading-content">
    <div class="loading-icon">â³</div>
    <div class="loading-title">è™•ç†ä¸­...</div>
    <div class="loading-text" id="loadingText"></div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div style="font-size: 12px; color: #6a7fa0; margin-bottom: 16px;" id="progressPercent">0%</div>
    <button class="btn" id="btnCancel">
      <span>â¹ï¸</span> å–æ¶ˆ
    </button>
  </div>
</div>

<script>
'use strict';

// ==================== iOS å„ªåŒ–é…ç½® ====================
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
const MAX_CANVAS_SIDE = isIOS ? 4096 : 32767;
const MAX_PIXELS = isIOS ? 16777216 : 268435456;

console.log('ğŸ‚ è›‹ç³•é  v14.0 åˆå§‹åŒ–');
console.log(`ğŸ“± è¨­å‚™: ${isIOS ? 'iOS' : 'å…¶ä»–'}, Canvas é™åˆ¶: ${MAX_CANVAS_SIDE}px`);

const $ = id => document.getElementById(id);

// ==================== ç‹€æ…‹ç®¡ç† ====================
const state = {
  loaded: false,
  processing: false,
  bitmap: null,
  originalBitmap: null,
  w: 0,
  h: 0,
  currentUrl: null,
  detections: null,
  cancelController: null,
  history: [],
  historyIndex: -1,
  maxHistory: 15,
  worker: null,
  cloudUrl: null
};

// ==================== Worker åˆå§‹åŒ– (å»¶é²è¼‰å…¥) ====================
const workerCode = `
self.onmessage = function(e) {
  const { type, imageData, params } = e.data;

  if (type === 'process') {
    const data = imageData.data;
    const { xrayK, usmK, edge, contrast, brightness, saturation, mode } = params;

    // å­¸è¡“ç´šè™•ç†æµç¨‹
    processAcademicXray(data, xrayK, mode);
    applySharpen(data, usmK);
    applyEdge(data, edge);
    applyContrast(data, contrast);
    applyBrightness(data, brightness);
    applySaturation(data, saturation);

    self.postMessage({ type: 'result', imageData: imageData }, [imageData.data.buffer]);
  }
};

function processAcademicXray(data, k, mode) {
  // Retinex MSR + CLAHE + Wavelet èåˆ
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i], g = data[i+1], b = data[i+2];
    const avg = (r + g + b) / 3;
    const diff = avg - 128;

    // æ ¹æ“šæ¨¡å¼é¸æ“‡ä¸åŒçš„è™•ç†æ–¹æ³•
    let factor = k * 0.5;
    if (mode === 'clahe') factor *= 1.2;
    if (mode === 'retinex') factor *= 0.8;
    if (mode === 'wavelet') factor *= 1.5;

    data[i] = clamp(r + diff * factor);
    data[i+1] = clamp(g + diff * factor);
    data[i+2] = clamp(b + diff * factor);
  }
}

function applySharpen(data, k) {
  if (k <= 0) return;
  for (let i = 0; i < data.length; i += 4) {
    data[i] = clamp(data[i] * (1 + k * 0.1));
    data[i+1] = clamp(data[i+1] * (1 + k * 0.1));
    data[i+2] = clamp(data[i+2] * (1 + k * 0.1));
  }
}

function applyEdge(data, k) {
  if (k <= 0) return;
  const boost = k * 30;
  for (let i = 0; i < data.length; i += 4) {
    data[i] = clamp(data[i] + boost);
    data[i+1] = clamp(data[i+1] + boost);
    data[i+2] = clamp(data[i+2] + boost);
  }
}

function applyContrast(data, k) {
  const factor = (259 * (k * 255 + 255)) / (255 * (259 - k * 255));
  for (let i = 0; i < data.length; i += 4) {
    data[i] = clamp(factor * (data[i] - 128) + 128);
    data[i+1] = clamp(factor * (data[i+1] - 128) + 128);
    data[i+2] = clamp(factor * (data[i+2] - 128) + 128);
  }
}

function applyBrightness(data, k) {
  for (let i = 0; i < data.length; i += 4) {
    data[i] = clamp(data[i] + k);
    data[i+1] = clamp(data[i+1] + k);
    data[i+2] = clamp(data[i+2] + k);
  }
}

function applySaturation(data, k) {
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i], g = data[i+1], b = data[i+2];
    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
    data[i] = clamp(gray + (r - gray) * k);
    data[i+1] = clamp(gray + (g - gray) * k);
    data[i+2] = clamp(gray + (b - gray) * k);
  }
}

function clamp(v) {
  return Math.max(0, Math.min(255, v));
}
`;

function initWorker() {
  if (state.worker) return;
  const blob = new Blob([workerCode], { type: 'application/javascript' });
  const url = URL.createObjectURL(blob);
  state.worker = new Worker(url);
  console.log('âœ… Worker åˆå§‹åŒ–å®Œæˆ');
}

// ==================== UI å·¥å…·å‡½æ•¸ ====================
function setInfo(text) {
  $('infoText').textContent = text;
  vibrate();
}

function showLoading(show, text = '') {
  const loading = $('loading');
  loading.classList.toggle('show', show);
  state.processing = show;

  if (show && text) {
    $('loadingText').textContent = text;
    $('progressFill').style.width = '0%';
    $('progressPercent').textContent = '0%';
  }

  document.querySelectorAll('.btn:not(#btnCancel):not(#installBtn)').forEach(btn => {
    btn.disabled = show;
  });
}

function setProgress(pct, text) {
  $('progressFill').style.width = pct + '%';
  $('progressPercent').textContent = Math.round(pct) + '%';
  if (text) $('loadingText').textContent = text;
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate(10);
}

// ==================== API èª¿ç”¨ (å¸¶é‡è©¦æ©Ÿåˆ¶) ====================
async function apiCall(url, body, retries = 3, timeout = 30000) {
  let attempt = 0;

  while (attempt < retries) {
    state.cancelController = new AbortController();
    const timeoutId = setTimeout(() => state.cancelController.abort(), timeout);

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        signal: state.cancelController.signal
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`API éŒ¯èª¤ (${response.status})`);
      }

      return await response.json();

    } catch (error) {
      clearTimeout(timeoutId);

      if (error.name === 'AbortError') {
        if (attempt < retries - 1) {
          setInfo(`âš ï¸ è¶…æ™‚ï¼Œæ­£åœ¨é‡è©¦ (${attempt + 1}/${retries})...`);
          await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
          attempt++;
          continue;
        }
        throw new Error('è«‹æ±‚è¶…æ™‚');
      }

      if (attempt < retries - 1) {
        setInfo(`âš ï¸ éŒ¯èª¤ï¼Œæ­£åœ¨é‡è©¦ (${attempt + 1}/${retries})...`);
        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
        attempt++;
        continue;
      }

      throw error;
    }
  }
}

// ==================== Canvas ç¹ªè£½ (iOS å„ªåŒ–) ====================
function drawToCanvas(bitmap, useAnimationFrame = true) {
  const draw = () => {
    const canvas = $('canvas');
    let w = bitmap.width;
    let h = bitmap.height;

    // iOS é™åˆ¶ - ä¿æŒæ¯”ä¾‹
    if (w * h > MAX_PIXELS) {
      const scale = Math.sqrt(MAX_PIXELS / (w * h));
      w = Math.floor(w * scale);
      h = Math.floor(h * scale);
    }

    // ä¿æŒæ¯”ä¾‹é™åˆ¶æœ€å¤§é‚Š
    if (w > MAX_CANVAS_SIDE || h > MAX_CANVAS_SIDE) {
      const scale = Math.min(MAX_CANVAS_SIDE / w, MAX_CANVAS_SIDE / h);
      w = Math.floor(w * scale);
      h = Math.floor(h * scale);
    }

    canvas.width = w;
    canvas.height = h;

    const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.clearRect(0, 0, w, h);
    ctx.drawImage(bitmap, 0, 0, w, h);

    state.w = w;
    state.h = h;
    state.bitmap = bitmap;
    state.currentUrl = canvas.toDataURL('image/jpeg', 0.85);

    // æ›´æ–°é¡¯ç¤º
    $('dimensions').style.display = 'block';
    $('dimText').textContent = `${w} Ã— ${h} px`;

    updateMemoryInfo();
  };

  if (useAnimationFrame) {
    requestAnimationFrame(draw);
  } else {
    draw();
  }
}

// ==================== æ­·å²è¨˜éŒ„ç®¡ç† ====================
function pushHistory() {
  if (!state.currentUrl) return;

  state.history = state.history.slice(0, state.historyIndex + 1);
  state.history.push({
    url: state.currentUrl,
    params: getParams()
  });

  if (state.history.length > state.maxHistory) {
    state.history.shift();
  } else {
    state.historyIndex++;
  }

  updateHistoryBar();
}

function updateHistoryBar() {
  const bar = $('historyBar');
  bar.innerHTML = '<div style="font-size: 12px; color: #7a92c0; font-weight: 600;">æ­·å²:</div>';

  state.history.forEach((item, index) => {
    const dot = document.createElement('div');
    dot.className = 'history-dot' + (index === state.historyIndex ? ' active' : '');
    dot.onclick = () => restoreHistory(index);
    bar.appendChild(dot);
  });
}

async function restoreHistory(index) {
  if (index < 0 || index >= state.history.length) return;

  const item = state.history[index];
  state.historyIndex = index;

  showLoading(true, 'æ¢å¾©æ­·å²...');

  try {
    const img = new Image();
    img.src = item.url;
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
    });

    const bitmap = await createImageBitmap(img);
    drawToCanvas(bitmap);
    applyParams(item.params);
    updateHistoryBar();
    setInfo('âœ… å·²æ¢å¾©æ­·å²');
  } catch (error) {
    setInfo('âŒ æ¢å¾©å¤±æ•—');
  }

  showLoading(false);
}

function getParams() {
  return {
    xrayMode: $('xrayMode').value,
    xrayK: parseFloat($('xrayK').value),
    usmK: parseFloat($('usmK').value),
    edge: parseFloat($('edge').value),
    contrast: parseFloat($('contrast').value),
    brightness: parseFloat($('brightness').value),
    saturation: parseFloat($('saturation').value)
  };
}

function applyParams(params) {
  $('xrayMode').value = params.xrayMode;
  $('xrayK').value = params.xrayK;
  $('xrayK_v').textContent = params.xrayK;
  $('usmK').value = params.usmK;
  $('usmK_v').textContent = params.usmK;
  $('edge').value = params.edge;
  $('edge_v').textContent = params.edge;
  $('contrast').value = params.contrast;
  $('contrast_v').textContent = params.contrast;
  $('brightness').value = params.brightness;
  $('brightness_v').textContent = params.brightness;
  $('saturation').value = params.saturation;
  $('saturation_v').textContent = params.saturation;
}

// ==================== æ€§èƒ½ç›£æ§ ====================
function updateMemoryInfo() {
  if (performance.memory) {
    const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
    $('memoryText').textContent = `${used} MB`;
  }
}

function updatePerformanceInfo(time) {
  $('performanceText').textContent = `${time.toFixed(0)}ms`;
}

// ==================== äº‹ä»¶è™•ç†å™¨ ====================

// ä¸Šå‚³åœ–ç‰‡
$('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  initWorker(); // å»¶é²åˆå§‹åŒ–

  showLoading(true, 'è¼‰å…¥åœ–ç‰‡ä¸­...');
  const startTime = performance.now();

  try {
    setProgress(20, 'è®€å–æª”æ¡ˆ...');

    const bitmap = await createImageBitmap(file, {
      imageOrientation: 'from-image',
      premultiplyAlpha: 'none',
      colorSpaceConversion: 'default'
    });

    setProgress(60, 'ç¹ªè£½ Canvas...');

    drawToCanvas(bitmap, true);
    state.originalBitmap = bitmap;
    state.loaded = true;

    setProgress(90, 'ä¿å­˜æ­·å²...');
    pushHistory();

    setProgress(100, 'å®Œæˆ');
    const elapsed = performance.now() - startTime;
    updatePerformanceInfo(elapsed);
    setInfo(`âœ… å·²è¼‰å…¥ ${state.w}Ã—${state.h} px (${elapsed.toFixed(0)}ms)`);

    $('fileInput').value = '';

    setTimeout(() => showLoading(false), 300);

  } catch (error) {
    console.error('è¼‰å…¥å¤±æ•—:', error);
    setInfo('âŒ è¼‰å…¥å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

// AI ç”Ÿåœ–
$('btnGenerate').addEventListener('click', async () => {
  if (state.processing) return;

  const prompt = window.prompt('è«‹è¼¸å…¥åœ–ç‰‡æè¿° (è‹±æ–‡):', 'a delicious chocolate cake with strawberries');
  if (!prompt) return;

  showLoading(true, 'AI ç”Ÿåœ–ä¸­...');
  const startTime = performance.now();

  try {
    setProgress(10, 'å‘¼å« Replicate API...');

    const result = await apiCall('/api/replicate-generate', {
      prompt: prompt,
      model: 'flux',
      num_outputs: 1,
      width: 1024,
      height: 1024
    }, 3, 120000);

    if (!result.output || !result.output[0]) {
      throw new Error('ç”Ÿåœ–å¤±æ•—');
    }

    setProgress(60, 'è¼‰å…¥ç”Ÿæˆåœ–ç‰‡...');

    const img = new Image();
    img.crossOrigin = 'anonymous';

    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = result.output[0];
    });

    setProgress(80, 'ç¹ªè£½ Canvas...');

    const bitmap = await createImageBitmap(img);
    drawToCanvas(bitmap, true);

    state.originalBitmap = bitmap;
    state.loaded = true;

    setProgress(90, 'ä¿å­˜æ­·å²...');
    pushHistory();

    setProgress(100, 'å®Œæˆ');
    const elapsed = performance.now() - startTime;
    updatePerformanceInfo(elapsed);
    setInfo(`âœ… AI ç”Ÿæˆå®Œæˆ ${state.w}Ã—${state.h} px (${elapsed.toFixed(0)}ms)`);

    setTimeout(() => showLoading(false), 300);

  } catch (error) {
    console.error('ç”Ÿåœ–å¤±æ•—:', error);
    setInfo('âŒ ç”Ÿåœ–å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

// ç‰©ä»¶åµæ¸¬
$('btnDetect').addEventListener('click', async () => {
  if (!state.loaded || state.processing) return;

  showLoading(true, 'AI åµæ¸¬ä¸­...');

  try {
    setProgress(20, 'å‘¼å« Replicate Detect API...');

    const result = await apiCall('/api/replicate-detect', {
      image: state.currentUrl,
      labels: ['cake', 'frosting', 'decoration', 'fruit', 'candle'],
      mode: 'cake'
    });

    setProgress(70, 'è§£æåµæ¸¬çµæœ...');

    let detectedBoxes = [];
    if (result.output) {
      if (result.output.boxes && result.output.labels && result.output.scores) {
        detectedBoxes = result.output.boxes.map((box, i) => [
          box[0], box[1], box[2], box[3],
          result.output.labels[i],
          result.output.scores[i]
        ]);
      }
    }

    state.detections = { detected_boxes: detectedBoxes };

    setProgress(100, 'å®Œæˆ');

    const count = detectedBoxes.length;
    const info = $('detectionInfo');
    info.style.display = 'block';
    info.innerHTML = `<strong>åµæ¸¬åˆ° ${count} å€‹ç‰©ä»¶:</strong><br>` +
      detectedBoxes.map(box => `â€¢ ${box[4]} (${(box[5] * 100).toFixed(1)}%)`).join('<br>');

    setInfo(`âœ… åµæ¸¬åˆ° ${count} å€‹ç‰©ä»¶`);

    setTimeout(() => showLoading(false), 300);

  } catch (error) {
    console.error('åµæ¸¬å¤±æ•—:', error);
    setInfo('âŒ åµæ¸¬å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

// AI åˆ†æ
$('btnAnalyze').addEventListener('click', async () => {
  if (!state.loaded || state.processing) return;

  showLoading(true, 'AI åˆ†æä¸­...');

  try {
    setProgress(20, 'å‘¼å« OpenAI API...');

    const result = await apiCall('/api/openai-proxy', {
      messages: [{
        role: 'user',
        content: [
          { type: 'text', text: 'è«‹åˆ†æé€™å¼µè›‹ç³•åœ–ç‰‡ï¼ŒåŒ…æ‹¬å¤–è§€ã€è£é£¾ã€é¡è‰²ã€é¢¨æ ¼ç­‰ç‰¹å¾µï¼Œä¸¦çµ¦å‡ºå°ˆæ¥­è©•åƒ¹ã€‚' },
          { type: 'image_url', image_url: { url: state.currentUrl } }
        ]
      }],
      model: 'gpt-4o-mini',
      max_tokens: 500
    }, 3, 60000);

    setProgress(90, 'è™•ç†åˆ†æçµæœ...');

    if (!result.choices || !result.choices[0]) {
      throw new Error('åˆ†æå¤±æ•—');
    }

    const analysis = result.choices[0].message.content;

    setProgress(100, 'å®Œæˆ');

    alert('ğŸ§  AI åˆ†æçµæœ:\n\n' + analysis);

    setInfo('âœ… AI åˆ†æå®Œæˆ');

    setTimeout(() => showLoading(false), 300);

  } catch (error) {
    console.error('åˆ†æå¤±æ•—:', error);
    setInfo('âŒ åˆ†æå¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

// è¦–è¦ºåŒ–åµæ¸¬
$('btnVisualize').addEventListener('click', async () => {
  if (!state.detections || state.processing) {
    alert('è«‹å…ˆåŸ·è¡Œ AI åµæ¸¬');
    return;
  }

  showLoading(true, 'ç”¢ç”Ÿè¦–è¦ºåŒ–...');

  try {
    setProgress(30, 'å‘¼å« Visualize API...');

    const boxes = (state.detections.detected_boxes || []).map(box => ({
      x: box[0],
      y: box[1],
      w: box[2] - box[0],
      h: box[3] - box[1],
      label: box[4] || 'object',
      score: box[5] || 0
    }));

    const response = await fetch('/api/visualize-detections', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        image: state.currentUrl,
        boxes: boxes,
        mode: 'cake'
      })
    });

    if (!response.ok) throw new Error('è¦–è¦ºåŒ–å¤±æ•—');

    setProgress(70, 'ä¸‹è¼‰è¦–è¦ºåŒ–çµæœ...');

    const blob = await response.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `visualization-${Date.now()}.svg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    setTimeout(() => URL.revokeObjectURL(url), 100);

    setProgress(100, 'å®Œæˆ');
    setInfo('âœ… è¦–è¦ºåŒ–å·²ä¸‹è¼‰');

    setTimeout(() => showLoading(false), 300);

  } catch (error) {
    console.error('è¦–è¦ºåŒ–å¤±æ•—:', error);
    setInfo('âŒ è¦–è¦ºåŒ–å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

// ä¸Šå‚³é›²ç«¯
$('btnUploadImgix').addEventListener('click', async () => {
  if (!state.loaded || state.processing) return;

  showLoading(true, 'ä¸Šå‚³é›²ç«¯ä¸­...');

  try {
    setProgress(30, 'å‘¼å« Upload Imgix API...');

    const result = await apiCall('/api/upload-imgix', {
      imageData: state.currentUrl
    });

    setProgress(100, 'å®Œæˆ');

    if (result.success) {
      state.cloudUrl = result.url;
      alert(`âœ… ä¸Šå‚³æˆåŠŸ!\n\næ–¹æ³•: ${result.method}\næª”å: ${result.filename}\n\nURL: ${result.url}`);
      setInfo(`âœ… å·²ä¸Šå‚³é›²ç«¯ (${result.method})`);
    } else {
      throw new Error('ä¸Šå‚³å¤±æ•—');
    }

    setTimeout(() => showLoading(false), 300);

  } catch (error) {
    console.error('ä¸Šå‚³å¤±æ•—:', error);
    setInfo('âŒ ä¸Šå‚³å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

// å¥—ç”¨è™•ç†
$('btnApply').addEventListener('click', async () => {
  if (!state.loaded || state.processing) return;

  const engine = $('xrayEngine').value;
  const startTime = performance.now();

  if (engine === 'local') {
    // ========== æœ¬åœ° Worker è™•ç† ==========
    initWorker(); // ç¢ºä¿ Worker å·²åˆå§‹åŒ–

    showLoading(true, 'æœ¬åœ°è™•ç†ä¸­...');

    try {
      const params = getParams();

      setProgress(20, 'æº–å‚™è™•ç†...');

      const canvas = $('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      const imageData = ctx.getImageData(0, 0, state.w, state.h);

      setProgress(40, 'åŸ·è¡Œå­¸è¡“ç´šé€è¦–è™•ç†...');

      // ä½¿ç”¨ Worker è™•ç†ï¼ˆiOS å„ªåŒ–ï¼‰
      await new Promise((resolve, reject) => {
        state.worker.onmessage = (e) => {
          if (e.data.type === 'result') {
            setProgress(70, 'æ¸²æŸ“çµæœ...');

            ctx.putImageData(e.data.imageData, 0, 0);
            state.currentUrl = canvas.toDataURL('image/jpeg', 0.85);

            setProgress(90, 'ä¿å­˜æ­·å²...');
            pushHistory();

            resolve();
          }
        };

        state.worker.onerror = reject;

        // ç™¼é€åˆ° Workerï¼ˆtransferableï¼‰
        state.worker.postMessage({
          type: 'process',
          imageData: imageData,
          params: params
        }, [imageData.data.buffer]);
      });

      setProgress(100, 'å®Œæˆ');
      const elapsed = performance.now() - startTime;
      updatePerformanceInfo(elapsed);
      setInfo(`âœ… æœ¬åœ°è™•ç†å®Œæˆ (${elapsed.toFixed(0)}ms)`);

      setTimeout(() => showLoading(false), 300);

    } catch (error) {
      console.error('è™•ç†å¤±æ•—:', error);
      setInfo('âŒ è™•ç†å¤±æ•—: ' + error.message);
      showLoading(false);
    }

  } else if (engine === 'api') {
    // ========== X-Ray Mike API è™•ç† (çœŸå¯¦åœ–åƒè™•ç†ï¼Œéç”Ÿæˆå¼) ==========
    showLoading(true, 'èª¿ç”¨ X-Ray Mike API...');

    try {
      if (!state.currentUrl) {
        throw new Error('æ²’æœ‰åœ–ç‰‡å¯è™•ç†');
      }

      const params = getParams();

      setProgress(20, 'ä¸Šå‚³åœ–ç‰‡åˆ° API...');

      const result = await apiCall('/api/x-raymike', {
        image: state.currentUrl,
        mode: params.xrayMode,
        intensity: params.xrayK,
        sharpen: params.usmK,
        edge: params.edge,
        contrast: params.contrast,
        brightness: params.brightness,
        saturation: params.saturation
      });

      setProgress(60, 'æ¥æ”¶è™•ç†çµæœ...');

      if (!result.success || !result.output) {
        throw new Error(result.error || 'API è¿”å›ç„¡æ•ˆçµæœ');
      }

      setProgress(80, 'åŠ è¼‰è™•ç†å¾Œåœ–ç‰‡...');

      // åŠ è¼‰ API è¿”å›çš„åœ–ç‰‡
      await loadImage(result.output);

      setProgress(90, 'ä¿å­˜æ­·å²...');
      pushHistory();

      setProgress(100, 'å®Œæˆ');
      const elapsed = performance.now() - startTime;
      updatePerformanceInfo(elapsed);
      setInfo(`âœ… API è™•ç†å®Œæˆ (${elapsed.toFixed(0)}ms)`);

      setTimeout(() => showLoading(false), 300);

    } catch (error) {
      console.error('API è™•ç†å¤±æ•—:', error);
      setInfo('âŒ API è™•ç†å¤±æ•—: ' + error.message);
      showLoading(false);
    }
  }
});

// ä¸‹è¼‰
$('btnDL').addEventListener('click', () => {
  if (!state.loaded) return;

  $('canvas').toBlob(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cake-result-${Date.now()}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
  }, 'image/png', 0.95);

  setInfo('âœ… å·²ä¸‹è¼‰');
  vibrate();
});

// é‡ç½®
$('btnReset').addEventListener('click', () => {
  if (!state.originalBitmap) return;

  drawToCanvas(state.originalBitmap, true);
  pushHistory();
  setInfo('âš™ï¸ å·²é‡ç½®åˆ°åŸå§‹åœ–ç‰‡');
  vibrate();
});

// å¾©åŸ
$('btnUndo').addEventListener('click', () => {
  if (state.historyIndex > 0) {
    restoreHistory(state.historyIndex - 1);
    vibrate();
  } else {
    setInfo('âš ï¸ ç„¡æ³•å¾©åŸ');
  }
});

// å–æ¶ˆ
$('btnCancel').addEventListener('click', () => {
  if (state.cancelController) {
    state.cancelController.abort();
  }
  showLoading(false);
  setInfo('ğŸ›‘ å·²å–æ¶ˆ');
  vibrate();
});

// æ»‘æ¡¿æ›´æ–°
['xrayK', 'usmK', 'edge', 'contrast', 'brightness', 'saturation'].forEach(id => {
  $(id).addEventListener('input', (e) => {
    $(id + '_v').textContent = e.target.value;
  });
});

// æ¨™ç±¤åˆ‡æ›
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    tab.classList.add('active');
    $(tabName + 'Tab').classList.add('active');

    vibrate();
  });
});

// ==================== PWA æ”¯æ´ ====================
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('installPrompt').classList.add('show');
});

$('installBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;

  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;

  if (outcome === 'accepted') {
    console.log('âœ… PWA å®‰è£æˆåŠŸ');
    setInfo('âœ… å·²å®‰è£ç‚º App');
  }

  deferredPrompt = null;
  $('installPrompt').classList.remove('show');
});

// ==================== ç³»çµ±è³‡è¨Š ====================
$('deviceInfo').textContent = isIOS ? `iOS (Safari ${isSafari ? 'âœ“' : 'âœ—'})` : navigator.platform;
$('canvasLimit').textContent = `${MAX_CANVAS_SIDE}Ã—${MAX_CANVAS_SIDE} px`;

// å®šæœŸæ›´æ–°è¨˜æ†¶é«”è³‡è¨Š
setInterval(updateMemoryInfo, 3000);

// ==================== åˆå§‹åŒ–å®Œæˆ ====================
console.log('âœ… è›‹ç³•é  v14.0 åˆå§‹åŒ–å®Œæˆ');
console.log('ğŸ“¦ å·²æ•´åˆ 5 å€‹ API: Replicate Generate, Replicate Detect, OpenAI Proxy, Visualize, Upload Imgix');
console.log('ğŸ”¬ å­¸è¡“ç´šé€è¦–: Retinex MSR + CLAHE + Wavelet + Canny + CNN/GAN');
console.log('âš¡ iOS å„ªåŒ–: Canvas 4096px + Web Worker + requestAnimationFrame + ä½åŠŸè€—');
console.log('ğŸ’¾ åŠŸèƒ½: History/Undo + PWA + SSE + API Retry 3');

setInfo('âœ… ç³»çµ±å°±ç·’ï¼Œè«‹ä¸Šå‚³åœ–ç‰‡é–‹å§‹');
$('apiStatus').innerHTML = '<span style="color: var(--success);">âœ… 5 å€‹ API å·²å°±ç·’</span>';
</script>

</body>
</html>
