<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UAG æ¥­å‹™å»£å‘Šå¾Œå°</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #f5f5f5;
  padding: 20px;
}
.container { max-width: 1400px; margin: 0 auto; }
header { 
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
h1 { font-size: 24px; margin-bottom: 8px; }
.subtitle { color: #666; font-size: 14px; }
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}
.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.stat-card h3 { 
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.stat-card .value {
  font-size: 32px;
  font-weight: bold;
  color: #333;
}
.stat-card .change {
  font-size: 12px;
  margin-top: 4px;
}
.stat-card .change.up { color: #10b981; }
.stat-card .change.down { color: #ef4444; }
.chart-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
.chart-card h2 {
  font-size: 18px;
  margin-bottom: 16px;
  color: #333;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  text-align: left;
  padding: 12px;
  border-bottom: 1px solid #eee;
}
th {
  background: #f9fafb;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  color: #666;
}
td { font-size: 14px; }
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
}
.badge.primary { background: #dbeafe; color: #1e40af; }
.badge.success { background: #d1fae5; color: #065f46; }
.badge.warning { background: #fef3c7; color: #92400e; }
.loading {
  text-align: center;
  padding: 40px;
  color: #999;
}
.error {
  background: #fee2e2;
  color: #991b1b;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 20px;
}
.filters {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.filters select, .filters input {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
}
.btn {
  padding: 8px 16px;
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}
.btn:hover { background: #1d4ed8; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>ğŸ“Š UAG æ¥­å‹™å»£å‘Šå¾Œå°</h1>
    <div class="subtitle">User Activity & Growth Analytics Dashboard</div>
  </header>

  <div id="error-message"></div>

  <div class="filters">
    <select id="timeRange">
      <option value="today">ä»Šå¤©</option>
      <option value="7d" selected>éå» 7 å¤©</option>
      <option value="30d">éå» 30 å¤©</option>
      <option value="90d">éå» 90 å¤©</option>
    </select>
    <button class="btn" onclick="loadData()">ğŸ”„ é‡æ–°æ•´ç†</button>
  </div>

  <div id="loading" class="loading">è¼‰å…¥ä¸­...</div>

  <div id="dashboard" style="display:none;">
    <!-- ç¸½è¦½æ•¸æ“š -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>ç¸½äº‹ä»¶æ•¸</h3>
        <div class="value" id="total-events">-</div>
        <div class="change" id="events-change">-</div>
      </div>
      <div class="stat-card">
        <h3>æ´»èºæœƒè©±</h3>
        <div class="value" id="total-sessions">-</div>
        <div class="change" id="sessions-change">-</div>
      </div>
      <div class="stat-card">
        <h3>è¨»å†Šç”¨æˆ¶</h3>
        <div class="value" id="total-users">-</div>
        <div class="change" id="users-change">-</div>
      </div>
      <div class="stat-card">
        <h3>è½‰æ›ç‡</h3>
        <div class="value" id="conversion-rate">-</div>
        <div class="change" id="conversion-change">-</div>
      </div>
    </div>

    <!-- ç†±é–€äº‹ä»¶ -->
    <div class="chart-card">
      <h2>ğŸ”¥ ç†±é–€äº‹ä»¶</h2>
      <table id="top-events-table">
        <thead>
          <tr>
            <th>äº‹ä»¶åç¨±</th>
            <th>è§¸ç™¼æ¬¡æ•¸</th>
            <th>ç¨ç«‹æœƒè©±</th>
            <th>ç¨ç«‹ç”¨æˆ¶</th>
          </tr>
        </thead>
        <tbody id="top-events-body">
          <tr><td colspan="4" style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- ç†±é–€é é¢ -->
    <div class="chart-card">
      <h2>ğŸ“„ ç†±é–€é é¢</h2>
      <table id="top-pages-table">
        <thead>
          <tr>
            <th>é é¢è·¯å¾‘</th>
            <th>ç€è¦½æ¬¡æ•¸</th>
            <th>ç¨ç«‹æœƒè©±</th>
          </tr>
        </thead>
        <tbody id="top-pages-body">
          <tr><td colspan="3" style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- æœ€è¿‘äº‹ä»¶ -->
    <div class="chart-card">
      <h2>â±ï¸ æœ€è¿‘äº‹ä»¶</h2>
      <table id="recent-events-table">
        <thead>
          <tr>
            <th>æ™‚é–“</th>
            <th>äº‹ä»¶</th>
            <th>é é¢</th>
            <th>æœƒè©± ID</th>
            <th>ç”¨æˆ¶ ID</th>
          </tr>
        </thead>
        <tbody id="recent-events-body">
          <tr><td colspan="5" style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

// å¾ app.config.json è®€å– Supabase è¨­å®š (å®‰å…¨!)
async function getSupabaseConfig() {
  try {
    const baseUrl = import.meta.env?.BASE_URL || '/'
    const configUrl = `${window.location.origin}${baseUrl}app.config.json`
    const res = await fetch(configUrl)
    const config = await res.json()
    return {
      url: config.supabaseUrl || import.meta.env?.VITE_SUPABASE_URL,
      key: config.supabaseAnonKey || import.meta.env?.VITE_SUPABASE_ANON_KEY
    }
  } catch (err) {
    console.error('ç„¡æ³•è®€å–è¨­å®š:', err)
    return { url: null, key: null }
  }
}

const config = await getSupabaseConfig()
if (!config.url || !config.key) {
  document.getElementById('error-message').innerHTML = `
    <div class="error">
      <strong>è¨­å®šéŒ¯èª¤:</strong> è«‹åœ¨ app.config.json è¨­å®š supabaseUrl å’Œ supabaseAnonKey
    </div>
  `
  throw new Error('Missing Supabase config')
}

const supabase = createClient(config.url, config.key)

let currentRange = '7d'

window.loadData = async function() {
  const loading = document.getElementById('loading')
  const dashboard = document.getElementById('dashboard')
  const errorMsg = document.getElementById('error-message')
  
  loading.style.display = 'block'
  dashboard.style.display = 'none'
  errorMsg.innerHTML = ''

  try {
    currentRange = document.getElementById('timeRange').value
    const days = currentRange === 'today' ? 1 : parseInt(currentRange)
    const since = new Date()
    since.setDate(since.getDate() - days)

    // æŸ¥è©¢æ•¸æ“š
    const { data: events, error } = await supabase
      .from('uag_events')
      .select('*')
      .gte('ts', since.toISOString())
      .order('ts', { ascending: false })

    if (error) throw error

    // è¨ˆç®—ç¸½è¦½çµ±è¨ˆ
    const totalEvents = events.length
    const uniqueSessions = new Set(events.map(e => e.session_id)).size
    const uniqueUsers = new Set(events.filter(e => e.user_id).map(e => e.user_id)).size
    const conversionRate = uniqueSessions > 0 
      ? ((uniqueUsers / uniqueSessions) * 100).toFixed(1) + '%'
      : '0%'

    document.getElementById('total-events').textContent = totalEvents.toLocaleString()
    document.getElementById('total-sessions').textContent = uniqueSessions.toLocaleString()
    document.getElementById('total-users').textContent = uniqueUsers.toLocaleString()
    document.getElementById('conversion-rate').textContent = conversionRate

    // ç†±é–€äº‹ä»¶
    const eventCounts = {}
    const eventSessions = {}
    const eventUsers = {}
    
    events.forEach(e => {
      eventCounts[e.event] = (eventCounts[e.event] || 0) + 1
      
      if (!eventSessions[e.event]) eventSessions[e.event] = new Set()
      eventSessions[e.event].add(e.session_id)
      
      if (e.user_id) {
        if (!eventUsers[e.event]) eventUsers[e.event] = new Set()
        eventUsers[e.event].add(e.user_id)
      }
    })

    const topEvents = Object.entries(eventCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)

    const topEventsHTML = topEvents.map(([event, count]) => `
      <tr>
        <td><span class="badge primary">${event}</span></td>
        <td>${count.toLocaleString()}</td>
        <td>${eventSessions[event].size.toLocaleString()}</td>
        <td>${(eventUsers[event]?.size || 0).toLocaleString()}</td>
      </tr>
    `).join('')

    document.getElementById('top-events-body').innerHTML = topEventsHTML || 
      '<tr><td colspan="4" style="text-align:center;color:#999;">ç„¡æ•¸æ“š</td></tr>'

    // ç†±é–€é é¢
    const pageCounts = {}
    const pageSessions = {}
    
    events.forEach(e => {
      pageCounts[e.page] = (pageCounts[e.page] || 0) + 1
      if (!pageSessions[e.page]) pageSessions[e.page] = new Set()
      pageSessions[e.page].add(e.session_id)
    })

    const topPages = Object.entries(pageCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)

    const topPagesHTML = topPages.map(([page, count]) => `
      <tr>
        <td><code>${page}</code></td>
        <td>${count.toLocaleString()}</td>
        <td>${pageSessions[page].size.toLocaleString()}</td>
      </tr>
    `).join('')

    document.getElementById('top-pages-body').innerHTML = topPagesHTML ||
      '<tr><td colspan="3" style="text-align:center;color:#999;">ç„¡æ•¸æ“š</td></tr>'

    // æœ€è¿‘äº‹ä»¶
    const recentHTML = events.slice(0, 20).map(e => {
      const time = new Date(e.ts).toLocaleString('zh-TW', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
      return `
        <tr>
          <td>${time}</td>
          <td><span class="badge success">${e.event}</span></td>
          <td><code style="font-size:12px;">${e.page}</code></td>
          <td><code style="font-size:11px;">${e.session_id.substring(0, 8)}...</code></td>
          <td>${e.user_id ? `<code style="font-size:11px;">${e.user_id.substring(0, 8)}...</code>` : '-'}</td>
        </tr>
      `
    }).join('')

    document.getElementById('recent-events-body').innerHTML = recentHTML ||
      '<tr><td colspan="5" style="text-align:center;color:#999;">ç„¡æ•¸æ“š</td></tr>'

    loading.style.display = 'none'
    dashboard.style.display = 'block'

  } catch (err) {
    console.error('Load error:', err)
    errorMsg.innerHTML = `
      <div class="error">
        <strong>è¼‰å…¥å¤±æ•—:</strong> ${err.message}<br>
        <small>è«‹ç¢ºèª Supabase è¨­å®šæ˜¯å¦æ­£ç¢º,ä¸¦å·²åŸ·è¡Œ schema.sql</small>
      </div>
    `
    loading.style.display = 'none'
  }
}

// åˆå§‹è¼‰å…¥
loadData()
</script>

</body>
</html>
