<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UAG æ¥­å‹™å»£å‘Šå¾Œå°</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #f5f5f5;
  padding: 20px;
}
.container { max-width: 1400px; margin: 0 auto; }
header { 
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
h1 { font-size: 24px; margin-bottom: 8px; }
.subtitle { color: #666; font-size: 14px; }
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}
.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.stat-card h3 { 
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.stat-card .value {
  font-size: 32px;
  font-weight: bold;
  color: #333;
}
.stat-card .change {
  font-size: 12px;
  margin-top: 4px;
}
.stat-card .change.up { color: #10b981; }
.stat-card .change.down { color: #ef4444; }
.chart-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
.chart-card h2 {
  font-size: 18px;
  margin-bottom: 16px;
  color: #333;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  text-align: left;
  padding: 12px;
  border-bottom: 1px solid #eee;
}
th {
  background: #f9fafb;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  color: #666;
}
td { font-size: 14px; }
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
}
.badge.primary { background: #dbeafe; color: #1e40af; }
.badge.success { background: #d1fae5; color: #065f46; }
.badge.warning { background: #fef3c7; color: #92400e; }
.loading {
  text-align: center;
  padding: 40px;
  color: #999;
}
.error {
  background: #fee2e2;
  color: #991b1b;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 20px;
}
.filters {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.filters select, .filters input {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
}
.btn {
  padding: 8px 16px;
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}
.btn:hover { background: #1d4ed8; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>ğŸ“Š UAG æ¥­å‹™åˆ†æå¾Œå° v8.3</h1>
    <div class="subtitle">User Activity & Grade - å®¢æˆ¶æ„å‘è¿½è¹¤ç³»çµ±</div>
  </header>

  <div id="error-message"></div>

  <div class="filters">
    <select id="timeRange">
      <option value="today">ä»Šå¤©</option>
      <option value="7d" selected>éå» 7 å¤©</option>
      <option value="30d">éå» 30 å¤©</option>
      <option value="90d">éå» 90 å¤©</option>
    </select>
    <button class="btn" onclick="loadData()">ğŸ”„ é‡æ–°æ•´ç†</button>
  </div>

  <div id="loading" class="loading">è¼‰å…¥ä¸­...</div>

  <div id="dashboard" style="display:none;">
    <!-- ç¸½è¦½æ•¸æ“š -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>ç¸½äº‹ä»¶æ•¸</h3>
        <div class="value" id="total-events">-</div>
        <div class="change" id="events-change">-</div>
      </div>
      <div class="stat-card">
        <h3>æ´»èºæœƒè©±</h3>
        <div class="value" id="total-sessions">-</div>
        <div class="change" id="sessions-change">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);">
        <h3>â­ S ç´šå®¢æˆ¶</h3>
        <div class="value" id="s-grade-count">-</div>
        <div class="change" id="s-grade-change">-</div>
      </div>
      <div class="stat-card">
        <h3>å¹³å‡åœç•™æ™‚é–“</h3>
        <div class="value" id="avg-duration">-</div>
        <div class="change" id="duration-change">ç§’</div>
      </div>
    </div>

    <!-- ç¬¬äºŒæ’çµ±è¨ˆ -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>å¼·ä¿¡è™Ÿç‡ (LINE/é›»è©±)</h3>
        <div class="value" id="strong-signal-rate">-</div>
        <div class="change" id="signal-change">-</div>
      </div>
      <div class="stat-card">
        <h3>ç†±é–€è¡Œæ”¿å€</h3>
        <div class="value" id="top-district" style="font-size: 24px;">-</div>
        <div class="change" id="district-count">-</div>
      </div>
      <div class="stat-card">
        <h3>å›è¨ªå®¢æˆ¶</h3>
        <div class="value" id="revisit-count">-</div>
        <div class="change" id="revisit-rate">-</div>
      </div>
      <div class="stat-card">
        <h3>ç€è¦½æˆ¿æºæ•¸</h3>
        <div class="value" id="property-count">-</div>
        <div class="change" id="property-change">-</div>
      </div>
    </div>

    <!-- ç†±é–€æˆ¿æº -->
    <div class="chart-card">
      <h2>ğŸ  ç†±é–€æˆ¿æº</h2>
      <table id="top-properties-table">
        <thead>
          <tr>
            <th>æˆ¿æº ID</th>
            <th>ç€è¦½æ¬¡æ•¸</th>
            <th>å¹³å‡åœç•™</th>
            <th>LINE é»æ“Š</th>
          </tr>
        </thead>
        <tbody id="top-properties-body">
          <tr><td colspan="4" style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- è¡Œæ”¿å€åˆ†ä½ˆ -->
    <div class="chart-card">
      <h2>ğŸ“ è¡Œæ”¿å€åˆ†ä½ˆ</h2>
      <table id="districts-table">
        <thead>
          <tr>
            <th>è¡Œæ”¿å€</th>
            <th>ç€è¦½æ¬¡æ•¸</th>
            <th>ç¨ç«‹æœƒè©±</th>
          </tr>
        </thead>
        <tbody id="districts-body">
          <tr><td colspan="3" style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- æœ€è¿‘äº‹ä»¶ -->
    <div class="chart-card">
      <h2>â±ï¸ æœ€è¿‘äº‹ä»¶</h2>
      <table id="recent-events-table">
        <thead>
          <tr>
            <th>æ™‚é–“</th>
            <th>æˆ¿æº</th>
            <th>è¡Œæ”¿å€</th>
            <th>åœç•™æ™‚é–“</th>
            <th>å‹•ä½œ</th>
            <th>æœƒè©± ID</th>
          </tr>
        </thead>
        <tbody id="recent-events-body">
          <tr><td colspan="6" style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- S ç´šå®¢æˆ¶åˆ—è¡¨ -->
    <div class="chart-card">
      <h2>â­ S ç´šé«˜æ„å‘å®¢æˆ¶</h2>
      <table id="s-grade-table">
        <thead>
          <tr>
            <th>æœƒè©± ID</th>
            <th>æœ€å¾Œæ´»èº</th>
            <th>ç¸½æ™‚é•·</th>
            <th>æˆ¿æºæ•¸</th>
            <th>å¼·ä¿¡è™Ÿ</th>
          </tr>
        </thead>
        <tbody id="s-grade-body">
          <tr><td colspan="5" style="text-align:center;color:#999;">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

// å¾ app.config.json è®€å– Supabase è¨­å®š (å®‰å…¨!)
async function getSupabaseConfig() {
  try {
    const baseUrl = import.meta.env?.BASE_URL || '/'
    const configUrl = `${window.location.origin}${baseUrl}app.config.json`
    const res = await fetch(configUrl)
    const config = await res.json()
    return {
      url: config.supabaseUrl || import.meta.env?.VITE_SUPABASE_URL,
      key: config.supabaseAnonKey || import.meta.env?.VITE_SUPABASE_ANON_KEY
    }
  } catch (err) {
    console.error('ç„¡æ³•è®€å–è¨­å®š:', err)
    return { url: null, key: null }
  }
}

const config = await getSupabaseConfig()
if (!config.url || !config.key) {
  document.getElementById('error-message').innerHTML = `
    <div class="error">
      <strong>è¨­å®šéŒ¯èª¤:</strong> è«‹åœ¨ app.config.json è¨­å®š supabaseUrl å’Œ supabaseAnonKey
    </div>
  `
  throw new Error('Missing Supabase config')
}

const supabase = createClient(config.url, config.key)

let currentRange = '7d'

window.loadData = async function() {
  const loading = document.getElementById('loading')
  const dashboard = document.getElementById('dashboard')
  const errorMsg = document.getElementById('error-message')
  
  loading.style.display = 'block'
  dashboard.style.display = 'none'
  errorMsg.innerHTML = ''

  try {
    currentRange = document.getElementById('timeRange').value
    const days = currentRange === 'today' ? 1 : parseInt(currentRange)
    const since = new Date()
    since.setDate(since.getDate() - days)

    // æŸ¥è©¢äº‹ä»¶æ•¸æ“š (ä½¿ç”¨æ–°æ¬„ä½ created_at, property_id, actions, district, duration)
    const { data: events, error: eventsError } = await supabase
      .from('uag_events')
      .select('*')
      .gte('created_at', since.toISOString())
      .order('created_at', { ascending: false })

    if (eventsError) throw eventsError

    // æŸ¥è©¢æœƒè©±æ•¸æ“š (ç”¨æ–¼ S ç´šçµ±è¨ˆ)
    const { data: sessions, error: sessionsError } = await supabase
      .from('uag_sessions')
      .select('*')
      .gte('last_active', since.toISOString())
      .order('last_active', { ascending: false })

    if (sessionsError) throw sessionsError

    // ====== è¨ˆç®—ç¸½è¦½çµ±è¨ˆ ======
    const totalEvents = events.length
    const uniqueSessions = new Set(events.map(e => e.session_id)).size
    
    // S ç´šå®¢æˆ¶æ•¸
    const sGradeCount = sessions.filter(s => s.grade === 'S').length
    
    // å¹³å‡åœç•™æ™‚é–“
    const totalDuration = events.reduce((sum, e) => sum + (e.duration || 0), 0)
    const avgDuration = events.length > 0 ? Math.round(totalDuration / events.length) : 0
    
    // å¼·ä¿¡è™Ÿç‡ (LINE æˆ–é›»è©±é»æ“Š)
    const strongSignals = events.filter(e => {
      const actions = e.actions || {}
      return (actions.click_line >= 1) || (actions.click_call >= 1)
    }).length
    const strongSignalRate = events.length > 0 
      ? ((strongSignals / events.length) * 100).toFixed(1) + '%'
      : '0%'

    // è¡Œæ”¿å€çµ±è¨ˆ
    const districtCounts = {}
    const districtSessions = {}
    events.forEach(e => {
      if (e.district && e.district !== 'unknown') {
        districtCounts[e.district] = (districtCounts[e.district] || 0) + 1
        if (!districtSessions[e.district]) districtSessions[e.district] = new Set()
        districtSessions[e.district].add(e.session_id)
      }
    })
    const topDistrictEntry = Object.entries(districtCounts).sort((a, b) => b[1] - a[1])[0]
    const topDistrict = topDistrictEntry ? topDistrictEntry[0] : '-'
    const topDistrictCount = topDistrictEntry ? `${topDistrictEntry[1]} æ¬¡` : '-'

    // å›è¨ªå®¢æˆ¶ (session çš„ visits > 1)
    const revisitSessions = sessions.filter(s => {
      const summary = s.summary || {}
      return (summary.visits || 0) > 1
    }).length
    const revisitRate = sessions.length > 0 
      ? ((revisitSessions / sessions.length) * 100).toFixed(1) + '%'
      : '0%'

    // ç¨ç«‹æˆ¿æºæ•¸
    const uniqueProperties = new Set(events.filter(e => e.property_id).map(e => e.property_id)).size

    // æ›´æ–° DOM
    document.getElementById('total-events').textContent = totalEvents.toLocaleString()
    document.getElementById('total-sessions').textContent = uniqueSessions.toLocaleString()
    document.getElementById('s-grade-count').textContent = sGradeCount.toLocaleString()
    document.getElementById('avg-duration').textContent = avgDuration.toLocaleString()
    document.getElementById('strong-signal-rate').textContent = strongSignalRate
    document.getElementById('top-district').textContent = topDistrict
    document.getElementById('district-count').textContent = topDistrictCount
    document.getElementById('revisit-count').textContent = revisitSessions.toLocaleString()
    document.getElementById('revisit-rate').textContent = revisitRate
    document.getElementById('property-count').textContent = uniqueProperties.toLocaleString()

    // ====== ç†±é–€æˆ¿æº ======
    const propertyCounts = {}
    const propertyDurations = {}
    const propertyLineClicks = {}
    
    events.forEach(e => {
      if (e.property_id) {
        propertyCounts[e.property_id] = (propertyCounts[e.property_id] || 0) + 1
        propertyDurations[e.property_id] = (propertyDurations[e.property_id] || 0) + (e.duration || 0)
        if ((e.actions?.click_line || 0) >= 1) {
          propertyLineClicks[e.property_id] = (propertyLineClicks[e.property_id] || 0) + 1
        }
      }
    })

    const topProperties = Object.entries(propertyCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)

    const topPropertiesHTML = topProperties.map(([propId, count]) => {
      const avgPropDuration = Math.round(propertyDurations[propId] / count)
      const lineClicks = propertyLineClicks[propId] || 0
      return `
        <tr>
          <td><code>${propId.substring(0, 12)}...</code></td>
          <td>${count.toLocaleString()}</td>
          <td>${avgPropDuration}s</td>
          <td>${lineClicks > 0 ? `<span class="badge success">${lineClicks}</span>` : '-'}</td>
        </tr>
      `
    }).join('')

    document.getElementById('top-properties-body').innerHTML = topPropertiesHTML || 
      '<tr><td colspan="4" style="text-align:center;color:#999;">ç„¡æ•¸æ“š</td></tr>'

    // ====== è¡Œæ”¿å€åˆ†ä½ˆ ======
    const topDistricts = Object.entries(districtCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)

    const districtsHTML = topDistricts.map(([district, count]) => `
      <tr>
        <td><span class="badge primary">${district}</span></td>
        <td>${count.toLocaleString()}</td>
        <td>${districtSessions[district].size.toLocaleString()}</td>
      </tr>
    `).join('')

    document.getElementById('districts-body').innerHTML = districtsHTML ||
      '<tr><td colspan="3" style="text-align:center;color:#999;">ç„¡æ•¸æ“š</td></tr>'

    // ====== æœ€è¿‘äº‹ä»¶ ======
    const recentHTML = events.slice(0, 20).map(e => {
      const time = new Date(e.created_at).toLocaleString('zh-TW', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
      const actions = e.actions || {}
      const actionBadges = []
      if (actions.click_line >= 1) actionBadges.push('<span class="badge success">LINE</span>')
      if (actions.click_call >= 1) actionBadges.push('<span class="badge warning">é›»è©±</span>')
      if (actions.click_photos > 0) actionBadges.push(`ğŸ“·${actions.click_photos}`)
      if (actions.scroll_depth > 0) actionBadges.push(`â¬‡${actions.scroll_depth}%`)
      
      return `
        <tr>
          <td>${time}</td>
          <td><code style="font-size:12px;">${e.property_id?.substring(0, 12) || '-'}...</code></td>
          <td>${e.district || '-'}</td>
          <td>${e.duration || 0}s</td>
          <td>${actionBadges.join(' ') || '-'}</td>
          <td><code style="font-size:11px;">${e.session_id.substring(0, 8)}...</code></td>
        </tr>
      `
    }).join('')

    document.getElementById('recent-events-body').innerHTML = recentHTML ||
      '<tr><td colspan="6" style="text-align:center;color:#999;">ç„¡æ•¸æ“š</td></tr>'

    // ====== S ç´šå®¢æˆ¶åˆ—è¡¨ ======
    const sGradeSessions = sessions.filter(s => s.grade === 'S').slice(0, 10)
    const sGradeHTML = sGradeSessions.map(s => {
      const lastActive = new Date(s.last_active).toLocaleString('zh-TW', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
      const summary = s.summary || {}
      const hasLine = (summary.click_line || 0) >= 1
      const hasCall = (summary.click_call || 0) >= 1
      const signals = []
      if (hasLine) signals.push('<span class="badge success">LINE</span>')
      if (hasCall) signals.push('<span class="badge warning">é›»è©±</span>')
      
      return `
        <tr>
          <td><code style="font-size:11px;">${s.session_id.substring(0, 12)}...</code></td>
          <td>${lastActive}</td>
          <td>${s.total_duration || 0}s</td>
          <td>${s.property_count || 0}</td>
          <td>${signals.join(' ') || '-'}</td>
        </tr>
      `
    }).join('')

    document.getElementById('s-grade-body').innerHTML = sGradeHTML ||
      '<tr><td colspan="5" style="text-align:center;color:#999;">ç›®å‰æ²’æœ‰ S ç´šå®¢æˆ¶</td></tr>'

    loading.style.display = 'none'
    dashboard.style.display = 'block'

  } catch (err) {
    console.error('Load error:', err)
    errorMsg.innerHTML = `
      <div class="error">
        <strong>è¼‰å…¥å¤±æ•—:</strong> ${err.message}<br>
        <small>è«‹ç¢ºèª Supabase è¨­å®šæ˜¯å¦æ­£ç¢º,ä¸¦å·²åŸ·è¡Œ uag-tracking.sql</small>
      </div>
    `
    loading.style.display = 'none'
  }
}

// åˆå§‹è¼‰å…¥
loadData()
</script>

</body>
</html>
