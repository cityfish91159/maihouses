#!/bin/bash
# ============================================================================
# AI Audit Script - 簡單有效的審計
# 只檢查真正重要的事：程式能不能跑
# ============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

FAILED=0

echo ""
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${YELLOW}    🔍 AI 審計 - 只檢查程式能不能跑                        ${NC}"
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# ============================================================================
# 檢查 1: TypeScript 編譯
# ============================================================================
echo -e "${YELLOW}[1/3]${NC} TypeScript 檢查..."
if npm run typecheck --silent 2>/dev/null; then
  echo -e "${GREEN}  ✅ TypeScript 通過${NC}"
else
  echo -e "${RED}  ❌ TypeScript 失敗${NC}"
  FAILED=1
fi

# ============================================================================
# 檢查 2: ESLint
# ============================================================================
echo -e "${YELLOW}[2/3]${NC} ESLint 檢查..."
if npm run lint --silent 2>/dev/null; then
  echo -e "${GREEN}  ✅ ESLint 通過${NC}"
else
  echo -e "${RED}  ❌ ESLint 失敗${NC}"
  FAILED=1
fi

# ============================================================================
# 檢查 3: Build
# ============================================================================
echo -e "${YELLOW}[3/3]${NC} Build 檢查..."
if npm run build --silent 2>/dev/null; then
  echo -e "${GREEN}  ✅ Build 通過${NC}"
else
  echo -e "${RED}  ❌ Build 失敗${NC}"
  FAILED=1
fi

# ============================================================================
# 結果
# ============================================================================
echo ""
if [[ "$FAILED" -eq 1 ]]; then
  echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${RED}    ❌ 審計失敗 - 修復問題後才能提交                        ${NC}"
  echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  exit 1
else
  echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${GREEN}    ✅ 審計通過                                            ${NC}"
  echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
fi
