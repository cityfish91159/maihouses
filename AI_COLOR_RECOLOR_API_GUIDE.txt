================================================================================
🎨 Cake Reveal M - AI 顏色回填模組 - 完整 API 連接說明
================================================================================
生成日期: 2025-11-12
專案: maihouses - Cake Reveal M 終極版
整合模型: OpenAI GPT-4 Vision + Replicate Flux + imgix + LAB Color Space
================================================================================

目錄
----
1. 系統架構概覽
2. API 端點詳細說明
3. 資料流程圖
4. 環境變數設定
5. 測試方法
6. 常見問題排除

================================================================================
1. 系統架構概覽
================================================================================

本系統整合 5 個 AI 模型進行圖像顏色回填：

[使用者上傳圖片]
    ↓
[OpenAI GPT-4 Vision] ← 分析圖片內容、物體、顏色、光照
    ↓
[Replicate GroundingDINO] ← 物體檢測、定位、標註
    ↓
[Replicate Flux Pro] ← 圖像增強、細節生成
    ↓
[imgix Blend API] ← 顏色混合、回填
    ↓
[Canvas LAB 色彩空間] ← 精細顏色校正 (deltaE < 0.8)
    ↓
[最終輸出圖片]

================================================================================
2. API 端點詳細說明
================================================================================

────────────────────────────────────────────────────────────────────────────
2.1 OpenAI Vision API - 圖像內容分析
────────────────────────────────────────────────────────────────────────────

端點: /api/openai-proxy
方法: POST
檔案: /workspaces/maihouses/api/openai-proxy.js

請求格式:
{
  "model": "gpt-4o",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "分析這張圖片,識別主要物體、顏色分布、光照條件。返回 JSON 格式: {objects: [], colors: [], lighting: \"\", suggestions: {}}"
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "data:image/png;base64,iVBORw0KGgoAAAANS..."
          }
        }
      ]
    }
  ],
  "max_tokens": 500,
  "temperature": 0.3
}

回應格式:
{
  "choices": [
    {
      "message": {
        "content": "{\"objects\": [\"cake\", \"plate\"], \"colors\": [\"pink\", \"white\"], \"lighting\": \"soft\", \"suggestions\": {\"xrayK\": 4.5, \"usmK\": 1.2}}"
      }
    }
  ]
}

環境變數:
- OPENAI_API_KEY: 你的 OpenAI API 金鑰

測試指令:
curl -X POST https://你的網域.vercel.app/api/openai-proxy \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": [{"type": "text", "text": "Hello"}]}]
  }'

────────────────────────────────────────────────────────────────────────────
2.2 Replicate Detection API - 物體檢測
────────────────────────────────────────────────────────────────────────────

端點: /api/replicate-detect
方法: POST
檔案: /workspaces/maihouses/api/replicate-detect.js

請求格式:
{
  "image": "https://example.com/image.jpg",
  "labels": ["cake", "clothing", "person", "object"],
  "mode": "general"
}

回應格式:
{
  "detections": [
    {
      "box": [100, 150, 300, 400],
      "score": 0.95,
      "label": "cake"
    }
  ],
  "count": 1
}

環境變數:
- REPLICATE_API_TOKEN: 你的 Replicate API Token
- REPLICATE_DEPLOYMENT_DETECT: 檢測模型部署路徑
  例: "你的用戶名/grounding-dino"

測試指令:
curl -X POST https://你的網域.vercel.app/api/replicate-detect \
  -H "Content-Type: application/json" \
  -d '{
    "image": "https://example.com/test.jpg",
    "labels": ["cake"],
    "mode": "general"
  }'

────────────────────────────────────────────────────────────────────────────
2.3 Replicate Generate API - 圖像生成/增強
────────────────────────────────────────────────────────────────────────────

端點: /api/replicate-generate
方法: POST
檔案: /workspaces/maihouses/api/replicate-generate.js

請求格式:
{
  "prompt": "enhance image quality, preserve colors, add details",
  "image": "https://example.com/image.jpg",
  "deployment": "flux-pro"
}

回應格式:
{
  "output": "https://replicate.delivery/pbxt/xyz123.png",
  "status": "succeeded"
}

環境變數:
- REPLICATE_API_TOKEN: 你的 Replicate API Token
- REPLICATE_DEPLOYMENT: Flux 模型部署路徑
  例: "你的用戶名/flux-pro"

測試指令:
curl -X POST https://你的網域.vercel.app/api/replicate-generate \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "high quality image",
    "deployment": "flux-pro"
  }'

────────────────────────────────────────────────────────────────────────────
2.4 imgix Upload API - 圖片上傳
────────────────────────────────────────────────────────────────────────────

端點: /api/upload-imgix
方法: POST
檔案: /workspaces/maihouses/api/upload-imgix.js

請求格式:
{
  "imageData": "data:image/png;base64,iVBORw0KGgoAAAANS..."
}

回應格式:
{
  "success": true,
  "url": "https://maihouses.imgix.net/uploads/1699876543-abc123.png",
  "filename": "uploads/1699876543-abc123.png"
}

環境變數:
- IMGIX_DOMAIN: 你的 imgix 網域 (例: maihouses.imgix.net)
- AWS_S3_BUCKET: S3 bucket 名稱
- AWS_S3_REGION: S3 區域 (例: us-east-1)
- AWS_ACCESS_KEY_ID: AWS Access Key
- AWS_SECRET_ACCESS_KEY: AWS Secret Key

測試指令:
curl -X POST https://你的網域.vercel.app/api/upload-imgix \
  -H "Content-Type: application/json" \
  -d '{
    "imageData": "data:image/png;base64,iVBORw0..."
  }'

────────────────────────────────────────────────────────────────────────────
2.5 imgix Blend API - 顏色混合
────────────────────────────────────────────────────────────────────────────

端點: 直接使用 imgix URL 參數
方法: GET
文件: https://docs.imgix.com/apis/rendering/blending

URL 格式:
https://maihouses.imgix.net/uploads/original.png?
  blend=https://replicate.delivery/enhanced.png&
  blend-mode=screen&
  blend-alpha=60&
  sat=10&
  sharp=20&
  auto=enhance

參數說明:
- blend: 要混合的圖片 URL
- blend-mode: 混合模式 (screen, multiply, overlay, etc.)
- blend-alpha: 混合透明度 (0-100)
- sat: 飽和度調整 (-100 到 100)
- sharp: 銳化強度 (0-100)
- auto: 自動增強 (enhance, format, compress)

測試指令:
curl "https://maihouses.imgix.net/uploads/test.png?blend-mode=screen&sat=10" \
  -o output.png

================================================================================
3. 資料流程圖
================================================================================

┌─────────────────────────────────────────────────────────────────────────┐
│ 前端 (ai-color-recolor-m.html)                                         │
└─────────────────────────────────────────────────────────────────────────┘
                            ↓ 使用者上傳圖片
┌─────────────────────────────────────────────────────────────────────────┐
│ Step 1: FileReader 讀取為 base64 DataURL                               │
│ → imageDataURL = "data:image/png;base64,..."                           │
└─────────────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ Step 2: 呼叫 OpenAI Vision API                                          │
│ POST /api/openai-proxy                                                  │
│ → 分析物體、顏色、光照                                                   │
│ ← { objects: [], colors: [], lighting: "", suggestions: {} }           │
└─────────────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ Step 3: 上傳圖片到 imgix (透過 S3)                                      │
│ POST /api/upload-imgix                                                  │
│ → { imageData: "data:image/..." }                                       │
│ ← { url: "https://maihouses.imgix.net/uploads/xxx.png" }               │
└─────────────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ Step 4: Replicate 物體檢測                                              │
│ POST /api/replicate-detect                                              │
│ → { image: "https://...", labels: [...] }                              │
│ ← { detections: [{box, score, label}] }                                │
└─────────────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ Step 5: Replicate Flux 增強                                             │
│ POST /api/replicate-generate                                            │
│ → { prompt: "enhance...", image: "https://..." }                       │
│ ← { output: "https://replicate.delivery/enhanced.png" }                │
└─────────────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ Step 6: imgix 顏色混合                                                  │
│ GET https://maihouses.imgix.net/uploads/xxx.png?blend=...&blend-mode=  │
│ → 混合原始圖與增強圖                                                     │
│ ← 混合後的圖片 URL                                                       │
└─────────────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ Step 7: Canvas LAB 顏色空間校正                                         │
│ → 載入原始圖與混合圖到 Canvas                                            │
│ → 轉換到 LAB 色彩空間                                                    │
│ → 使用增強的 L (亮度), 保留原始 a/b (色度)                              │
│ → 轉換回 RGB                                                             │
│ ← 最終校正後的圖片                                                       │
└─────────────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────┐
│ Step 8: 顯示結果給使用者                                                │
│ → Canvas 繪製最終圖片                                                    │
│ → 顯示 AI 建議面板                                                       │
│ → 允許下載/分享                                                          │
└─────────────────────────────────────────────────────────────────────────┘

================================================================================
4. 環境變數設定
================================================================================

在 Vercel 專案設定中新增以下環境變數:

────────────────────────────────────────────────────────────────────────────
OpenAI 設定
────────────────────────────────────────────────────────────────────────────
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

取得方式: https://platform.openai.com/api-keys

────────────────────────────────────────────────────────────────────────────
Replicate 設定
────────────────────────────────────────────────────────────────────────────
REPLICATE_API_TOKEN=r8_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
REPLICATE_DEPLOYMENT=你的用戶名/flux-pro
REPLICATE_DEPLOYMENT_DETECT=你的用戶名/grounding-dino

取得方式: https://replicate.com/account/api-tokens

────────────────────────────────────────────────────────────────────────────
imgix + S3 設定
────────────────────────────────────────────────────────────────────────────
IMGIX_DOMAIN=maihouses.imgix.net
AWS_S3_BUCKET=你的bucket名稱
AWS_S3_REGION=us-east-1
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=xxxxx...

imgix 設定: https://dashboard.imgix.com/
AWS S3: https://console.aws.amazon.com/s3/

注意: imgix 需要先連接到你的 S3 bucket 作為 Source

────────────────────────────────────────────────────────────────────────────
Vercel 設定指令
────────────────────────────────────────────────────────────────────────────

# 使用 Vercel CLI 設定
vercel env add OPENAI_API_KEY
vercel env add REPLICATE_API_TOKEN
vercel env add REPLICATE_DEPLOYMENT
vercel env add REPLICATE_DEPLOYMENT_DETECT
vercel env add IMGIX_DOMAIN
vercel env add AWS_S3_BUCKET
vercel env add AWS_S3_REGION
vercel env add AWS_ACCESS_KEY_ID
vercel env add AWS_SECRET_ACCESS_KEY

# 或透過 Vercel Dashboard:
# https://vercel.com/你的帳號/maihouses/settings/environment-variables

================================================================================
5. 測試方法
================================================================================

────────────────────────────────────────────────────────────────────────────
5.1 本地開發測試
────────────────────────────────────────────────────────────────────────────

# 1. 安裝依賴
npm install

# 2. 建立 .env.local 檔案
cat > .env.local << EOF
OPENAI_API_KEY=sk-proj-xxx
REPLICATE_API_TOKEN=r8_xxx
REPLICATE_DEPLOYMENT=你的用戶名/flux-pro
REPLICATE_DEPLOYMENT_DETECT=你的用戶名/grounding-dino
IMGIX_DOMAIN=maihouses.imgix.net
AWS_S3_BUCKET=你的bucket
AWS_S3_REGION=us-east-1
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=xxx...
EOF

# 3. 啟動開發伺服器
npm run dev

# 4. 開啟瀏覽器
open http://localhost:5173/tools/cake-reveal/ai-color-recolor-m.html

────────────────────────────────────────────────────────────────────────────
5.2 API 端點測試
────────────────────────────────────────────────────────────────────────────

# 測試 OpenAI API
curl -X POST http://localhost:3000/api/openai-proxy \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4o",
    "messages": [
      {
        "role": "user",
        "content": [
          {"type": "text", "text": "Say hello"}
        ]
      }
    ]
  }'

# 測試 Replicate Detection
curl -X POST http://localhost:3000/api/replicate-detect \
  -H "Content-Type: application/json" \
  -d '{
    "image": "https://example.com/test.jpg",
    "labels": ["object"],
    "mode": "general"
  }'

# 測試 Replicate Generate
curl -X POST http://localhost:3000/api/replicate-generate \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "a beautiful landscape"
  }'

# 測試 imgix Upload
curl -X POST http://localhost:3000/api/upload-imgix \
  -H "Content-Type: application/json" \
  -d '{
    "imageData": "data:image/png;base64,iVBORw0KGgo..."
  }'

────────────────────────────────────────────────────────────────────────────
5.3 完整流程測試腳本
────────────────────────────────────────────────────────────────────────────

建立測試腳本: test-ai-recolor.sh

#!/bin/bash

echo "🧪 測試 AI 顏色回填完整流程"
echo "================================"

BASE_URL="http://localhost:3000"
TEST_IMAGE="data:image/png;base64,iVBORw0KGgo..."

echo "📝 Step 1: 測試 OpenAI Vision..."
curl -X POST $BASE_URL/api/openai-proxy \
  -H "Content-Type: application/json" \
  -d "{\"model\":\"gpt-4o\",\"messages\":[{\"role\":\"user\",\"content\":\"test\"}]}" \
  | jq .

echo ""
echo "📝 Step 2: 測試圖片上傳..."
UPLOAD_RESULT=$(curl -X POST $BASE_URL/api/upload-imgix \
  -H "Content-Type: application/json" \
  -d "{\"imageData\":\"$TEST_IMAGE\"}" \
  | jq -r '.url')

echo "上傳成功: $UPLOAD_RESULT"

echo ""
echo "📝 Step 3: 測試物體檢測..."
curl -X POST $BASE_URL/api/replicate-detect \
  -H "Content-Type: application/json" \
  -d "{\"image\":\"$UPLOAD_RESULT\",\"labels\":[\"object\"],\"mode\":\"general\"}" \
  | jq .

echo ""
echo "📝 Step 4: 測試圖像增強..."
curl -X POST $BASE_URL/api/replicate-generate \
  -H "Content-Type: application/json" \
  -d "{\"prompt\":\"enhance image\",\"image\":\"$UPLOAD_RESULT\"}" \
  | jq .

echo ""
echo "✅ 測試完成!"

使用方法:
chmod +x test-ai-recolor.sh
./test-ai-recolor.sh

────────────────────────────────────────────────────────────────────────────
5.4 前端測試
────────────────────────────────────────────────────────────────────────────

1. 開啟頁面: http://localhost:5173/tools/cake-reveal/ai-color-recolor-m.html
2. 點擊「📂 選擇圖片」上傳測試圖片
3. 確認「🎨 AI回填」選項已勾選
4. 觀察處理進度:
   - ⏳ AI 處理中...
   - 🤖 OpenAI 分析中... (10%)
   - 🔍 Replicate 物體檢測... (30%)
   - 🎨 Replicate Flux 增強中... (50%)
   - 🎨 imgix 顏色回填中... (70%)
   - 🔬 LAB 顏色空間回填... (80%)
   - ✅ 完成! (100%)
5. 檢查結果:
   - 右側畫布顯示處理後的圖片
   - 可拖動中線對比原圖與結果
   - AI 建議面板顯示分析結果
6. 測試下載功能
7. 檢查瀏覽器 Console 是否有錯誤

================================================================================
6. 常見問題排除
================================================================================

────────────────────────────────────────────────────────────────────────────
Q1: OpenAI API 返回 401 Unauthorized
────────────────────────────────────────────────────────────────────────────
A: 檢查 OPENAI_API_KEY 是否正確設定
   - 確認金鑰格式: sk-proj-xxxx
   - 檢查 Vercel 環境變數設定
   - 確認金鑰有效且有額度

────────────────────────────────────────────────────────────────────────────
Q2: Replicate API 返回 404 或 deployment not found
────────────────────────────────────────────────────────────────────────────
A: 檢查部署路徑格式
   - 格式應為: "username/model-name"
   - 確認模型已在 Replicate 建立並部署
   - 檢查 REPLICATE_DEPLOYMENT 和 REPLICATE_DEPLOYMENT_DETECT

────────────────────────────────────────────────────────────────────────────
Q3: imgix 圖片無法載入或 CORS 錯誤
────────────────────────────────────────────────────────────────────────────
A: 設定 imgix CORS
   - 登入 imgix Dashboard
   - 前往 Source Settings → CORS
   - 新增允許的網域: https://你的網域.vercel.app
   - 或設定為 * (開發用)

────────────────────────────────────────────────────────────────────────────
Q4: S3 上傳失敗
────────────────────────────────────────────────────────────────────────────
A: 檢查 AWS 權限
   - IAM 使用者需要 s3:PutObject 權限
   - Bucket 政策需允許公開讀取
   - 檢查 AWS_ACCESS_KEY_ID 和 AWS_SECRET_ACCESS_KEY

────────────────────────────────────────────────────────────────────────────
Q5: LAB 顏色回填結果不理想
────────────────────────────────────────────────────────────────────────────
A: 調整混合比例
   - 修改 labColorRestore() 函數中的混合比例:
     enhLab[0] * 0.7 + origLab[0] * 0.3
   - 嘗試不同的比例組合 (0.5/0.5, 0.8/0.2, etc.)
   - 根據圖片類型調整 blend-alpha 參數

────────────────────────────────────────────────────────────────────────────
Q6: 處理速度太慢
────────────────────────────────────────────────────────────────────────────
A: 優化策略
   - 減少圖片尺寸: 在上傳前先壓縮
   - 使用較快的 Replicate 模型
   - 考慮跳過某些步驟 (如檢測)
   - 使用 Vercel Edge Functions 加速

────────────────────────────────────────────────────────────────────────────
Q7: 記憶體溢出錯誤
────────────────────────────────────────────────────────────────────────────
A: 限制圖片大小
   - 在前端限制最大尺寸 (如 2048px)
   - 使用 Canvas 縮放大圖
   - 考慮分塊處理大圖

================================================================================
7. 部署到 Vercel
================================================================================

# 1. 安裝 Vercel CLI
npm i -g vercel

# 2. 登入 Vercel
vercel login

# 3. 連結專案
vercel link

# 4. 設定環境變數
vercel env add OPENAI_API_KEY
vercel env add REPLICATE_API_TOKEN
vercel env add REPLICATE_DEPLOYMENT
vercel env add REPLICATE_DEPLOYMENT_DETECT
vercel env add IMGIX_DOMAIN
vercel env add AWS_S3_BUCKET
vercel env add AWS_S3_REGION
vercel env add AWS_ACCESS_KEY_ID
vercel env add AWS_SECRET_ACCESS_KEY

# 5. 部署
vercel --prod

# 6. 測試生產環境
curl https://你的網域.vercel.app/api/openai-proxy \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"model":"gpt-4o","messages":[{"role":"user","content":"test"}]}'

================================================================================
8. 效能指標與監控
================================================================================

────────────────────────────────────────────────────────────────────────────
建議的處理時間 (1024x1024 圖片)
────────────────────────────────────────────────────────────────────────────
- OpenAI Vision 分析: 2-4 秒
- Replicate 物體檢測: 3-5 秒
- Replicate Flux 增強: 10-20 秒
- imgix 混合: 1-2 秒
- Canvas LAB 處理: 1-3 秒
- 總計: 約 17-34 秒

────────────────────────────────────────────────────────────────────────────
監控建議
────────────────────────────────────────────────────────────────────────────
1. 使用 Vercel Analytics 監控 API 回應時間
2. 在前端加入 performance.mark() 追蹤各步驟耗時
3. 記錄失敗率和錯誤訊息
4. 監控 API 配額使用量

================================================================================
9. 成本估算
================================================================================

────────────────────────────────────────────────────────────────────────────
OpenAI GPT-4 Vision
────────────────────────────────────────────────────────────────────────────
- 費用: $0.01 / 1K tokens (約 750 字)
- 每次圖片分析: 約 $0.005 - $0.01
- 1000 次處理: 約 $5 - $10

────────────────────────────────────────────────────────────────────────────
Replicate
────────────────────────────────────────────────────────────────────────────
- 費用依模型而定
- GroundingDINO: 約 $0.0005 / 次
- Flux Pro: 約 $0.05 / 次
- 1000 次處理: 約 $50

────────────────────────────────────────────────────────────────────────────
imgix + S3
────────────────────────────────────────────────────────────────────────────
- S3 儲存: $0.023 / GB / 月
- imgix: 依流量計費, 約 $0.08 / GB
- 1000 張圖 (假設每張 2MB): 約 $0.16

────────────────────────────────────────────────────────────────────────────
總計 (1000 次處理)
────────────────────────────────────────────────────────────────────────────
約 $55 - $60

建議: 實作快取機制減少重複處理

================================================================================
10. 檔案清單
================================================================================

前端:
✅ /workspaces/maihouses/public/tools/cake-reveal/ai-color-recolor-m.html

後端 API:
✅ /workspaces/maihouses/api/openai-proxy.js
✅ /workspaces/maihouses/api/replicate-detect.js
✅ /workspaces/maihouses/api/replicate-generate.js
✅ /workspaces/maihouses/api/upload-imgix.js

文件:
✅ /workspaces/maihouses/AI_COLOR_RECOLOR_API_GUIDE.txt (本檔案)

================================================================================
11. 下一步建議
================================================================================

□ 實作圖片快取機制 (避免重複處理)
□ 加入批次處理功能 (一次處理多張圖)
□ 優化 LAB 顏色回填演算法
□ 加入更多 AI 模型選項 (SDXL, ControlNet, etc.)
□ 實作進階參數調整介面
□ 加入結果評分系統 (deltaE, SSIM, etc.)
□ 建立使用者回饋機制
□ 實作 A/B 測試比較不同模型效果
□ 加入浮水印和版權保護
□ 實作付費訂閱制 (基於處理次數)

================================================================================
12. 聯絡資訊
================================================================================

專案: maihouses - Cake Reveal M
Repository: https://github.com/cityfish91159/maihouses
作者: cityfish91159

如有問題或建議,請透過 GitHub Issues 回報:
https://github.com/cityfish91159/maihouses/issues

================================================================================
文件結束
================================================================================
