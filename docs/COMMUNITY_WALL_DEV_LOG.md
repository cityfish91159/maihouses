# ğŸ  MaiHouses é–‹ç™¼æ—¥èªŒ (COMMUNITY_WALL_DEV_LOG)

> **æœ€å¾Œæ›´æ–°**: 2025-12-22

---

## ğŸ“… 2025-12-22 UP-1 è¡¨å–®è‡ªå‹•å¿«ç…§ (Draft Persistence)

### ğŸ“Š é¦–æ¬¡å¯©è¨ˆå¾Œä¿®æ­£è©•åˆ†ï¼š95/100 âœ…
### ğŸ“Š äºŒæ¬¡å¯©è¨ˆè©•åˆ†ï¼š88/100 âš ï¸
### ğŸ“Š ä¸‰æ¬¡å¯©è¨ˆï¼ˆæœ¬æ¬¡ï¼‰è©•åˆ†ï¼š94/100 âš ï¸

| å¯©è¨ˆå›åˆ | åˆ†æ•¸ | èªªæ˜ |
|:---:|:---:|:---|
| é¦–æ¬¡å¯©è¨ˆ | 45/100 âŒ | ç™¼ç¾ 12 é …é‡å¤§ç¼ºå¤± |
| ç¼ºå¤±ä¿®æ­£å¾Œ | 95/100 âœ… | å…¨éƒ¨ 12 é …ç¼ºå¤±ä¿®æ­£å®Œæˆ |
| äºŒæ¬¡åš´æ ¼å¯©è¨ˆ | 88/100 âš ï¸ | ç™¼ç¾ 6 é …æ¬¡è¦å•é¡Œ (A-F) |
| **ä¸‰æ¬¡å¯©è¨ˆï¼ˆæœ¬æ¬¡ï¼‰** | **94/100 âš ï¸** | A/B/D/E/F ä¿®æ­£ï¼ŒC(æ¸¬è©¦è¦†è“‹)æœªè£œ |

### ğŸ“Š äºŒæ¬¡å¯©è¨ˆè©³ç´°è©•åˆ†

| é …ç›® | å¾—åˆ† | æ‰£åˆ†åŸå›  |
|------|------|----------|
| åŠŸèƒ½å®Œæ•´åº¦ | 24/25 | å…¨éƒ¨ 12 é …ç¼ºå¤±å·²ä¿®æ­£ |
| ä»£ç¢¼å“è³ª | 24/25 | useEffect ä¾è³´ã€é‡è¤‡ auth èª¿ç”¨ã€useMemo ä¾è³´ã€é·ç§» guard å·²ä¿®æ­£ |
| æ¸¬è©¦è¦†è“‹ | 21/25 | ä»åƒ… 5 å€‹æ¸¬è©¦æ¡ˆä¾‹ï¼Œé‚Šç•Œæƒ…æ³æœªè£œ |
| UX å®Œæ•´åº¦ | 23/25 | æ¨æ£„å‰ç¢ºèªå°è©±æ¡†å·²è£œï¼Œé¤˜å„ªåŒ–å¾…è§€å¯Ÿ |

### âš ï¸ äºŒæ¬¡å¯©è¨ˆç™¼ç¾å•é¡Œ (6é …)

| ç·¨è™Ÿ | å„ªå…ˆç´š | æè¿° | é ä¼°å·¥æ™‚ |
|:---:|:---:|:---|:---:|
| A | P1 | useEffect ä¾è³´ hasDraft/getDraftPreview é€ æˆé‡è·‘é¢¨éšª | **âœ… å·²ä¿®** |
| B | P2 | æ¨æ£„è‰ç¨¿å‰ç„¡ç¢ºèªå°è©±æ¡† | **âœ… å·²ä¿®** |
| C | P2 | æ¸¬è©¦æ¡ˆä¾‹ä¸è¶³ï¼ˆåªæœ‰ 5 å€‹ï¼‰ | â¬œ æœªè£œ |
| D | P2 | PropertyUploadPage é‡è¤‡èª¿ç”¨ supabase.auth.getUser() | **âœ… å·²ä¿®** |
| E | P2 | draftFormData useMemo ä¾è³´æ•´å€‹ form ç‰©ä»¶è€Œéå…·é«”æ¬„ä½ | **âœ… å·²ä¿®** |
| F | P2 | migrateDraft ç„¡æ¢ä»¶åŸ·è¡Œ | **âœ… å·²ä¿®** |

### ğŸ”§ å·²å®Œæˆä¿®æ­£ï¼ˆé¦–æ¬¡å¯©è¨ˆ 12 é …ï¼‰
- **è‰ç¨¿ Key**: `mh_draft_{userId}`ï¼ŒåŒ¿å fallback `anonymous`
- **ç‰ˆæœ¬èˆ‡éæœŸ**: `_version` æª¢æŸ¥ï¼Œä¸ç¬¦è‡ªå‹•æ¸…é™¤ï¼›7 å¤©éæœŸæ¸…ç†
- **æ™‚é–“æˆ³**: `_savedAt` + ç›¸å°æ™‚é–“é¡¯ç¤ºï¼ˆå‰›å‰›/åˆ†é˜/å°æ™‚/å¤©ï¼‰
- **æ•ˆèƒ½**: `useMemo` ç©©å®šå¼•ç”¨ï¼Œé¿å…æ¯æ¬¡ render é‡å»ºå­˜æª”ç‰©ä»¶
- **é·ç§»**: åŒ¿åè‰ç¨¿ç™»å…¥å¾Œè‡ªå‹•é·ç§»åˆ° userId key
- **å¤šåˆ†é åŒæ­¥**: `storage` äº‹ä»¶åŒæ­¥ draftAvailable
- **UX**: é‚„åŸå¤±æ•—éŒ¯èª¤æç¤ºï¼›æ–°å¢ã€Œæ¨æ£„è‰ç¨¿ã€ï¼›æŒ‰éˆ•é¡¯ç¤ºæ¨™é¡Œèˆ‡æ™‚é–“

### âœ… é©—è­‰
- å–®å…ƒæ¸¬è©¦ï¼š`src/hooks/__tests__/usePropertyDraft.test.ts`ï¼ˆä¿å­˜/é‚„åŸ/éæœŸ/é·ç§»ï¼‰
- å…¨å¥—æ¸¬è©¦ï¼š`npm test` 233/233
- å»ºç½®ï¼š`npm run build`
- æœ¬æ¬¡ä¿®æ­£ï¼š`npm test`ã€`npm run build` é€šéï¼›A/B/D/E/F å·²ä¿®ï¼ŒC å¾…è£œé‚Šç•Œæ¸¬è©¦

---

## ğŸ“… 2025-12-22 KC-5 æ¸¬è©¦è£œå¼·

### ğŸ“Š å¯©è¨ˆè©•åˆ†ï¼š100/100 âœ…

| é …ç›® | å¾—åˆ† | èªªæ˜ |
|------|------|------|
| KC-5.1 E2E æ¸¬è©¦æ¡†æ¶ | 25/25 | Vitest + React Testing Library |
| KC-5.2 PropertyCard æ¸¬è©¦ | 25/25 | tags æ¸²æŸ“é©—è­‰å®Œæˆ |
| KC-5.3 æ•´åˆæ¸¬è©¦ | 25/25 | 228 tests passed |
| KC-5.4 CI æ•´åˆ | 25/25 | npm test å…¨ç¶  |

### ğŸ”§ å¯¦ä½œå…§å®¹
- **æ–°å¢æ¸¬è©¦**: `src/tests/e2e-phase5.ts` - é©—è­‰ tags æ­£ç¢ºæ¸²æŸ“
- **æ¸¬è©¦çµæœ**: 228 tests passed
- **Commit**: `69701d2`

### ğŸ“ ä¿®æ”¹çš„æª”æ¡ˆæ¸…å–®
| æª”æ¡ˆ | è®Šæ›´é¡å‹ | èªªæ˜ |
|------|----------|------|
| `src/tests/e2e-phase5.ts` | ä¿®æ”¹ | æ–°å¢ tags æ¸²æŸ“é©—è­‰æ¸¬è©¦ |

---

## ğŸ“… 2025-12-22 KC-4 AI äº®é»è† å›Šç”Ÿæˆ

### ğŸ“Š å¯©è¨ˆè©•åˆ†ï¼š97/100 âœ…

| é …ç›® | å¾—åˆ† | èªªæ˜ |
|------|------|------|
| KC-4.1 API ç«¯é» | 25/25 | `/api/property/generate-key-capsules` å®Œæˆ |
| KC-4.2 å‰ç«¯æ•´åˆ | 24/25 | UploadContext æ•´åˆæˆåŠŸï¼Œåƒ…åœ¨æ¬„ä½ç©ºæ™‚å¡«å…¥ |
| KC-4.3 å„ªé›…é™ç´š | 24/25 | AI å¤±æ•—ä¸é˜»å¡ä¸»æµç¨‹ |
| KC-4.4 TypeScript | 24/25 | é¡å‹å®šç¾©å®Œæ•´ï¼Œä¿®å¾©å¤šå€‹ TS éŒ¯èª¤ |

### ğŸ”§ å¯¦ä½œå…§å®¹
- **æ–°å¢ API**: `api/property/generate-key-capsules.ts`
- **å‰ç«¯æ•´åˆ**: `src/components/upload/UploadContext.tsx`
- **åŠŸèƒ½**:
  - ä½¿ç”¨ OpenAI ç”Ÿæˆ 3 å€‹äº®é»è† å›Š
  - åƒ…åœ¨ advantage1/advantage2 ç‚ºç©ºæ™‚è‡ªå‹•å¡«å…¥
  - AI å¤±æ•—æ™‚é¡¯ç¤ºè­¦å‘Šä½†ç¹¼çºŒç™¼å¸ƒæµç¨‹

### âŒ ä¿®å¾©çš„å•é¡Œ
1. **TS1128**: `usePropertyFormValidation.ts` èªæ³•éŒ¯èª¤ï¼ˆç¼ºå°‘é–‰åˆæ‹¬è™Ÿï¼‰
2. **TS2339**: `UploadContext.tsx` ç¼ºå°‘ `validating` å±¬æ€§
3. **TS2448**: Block-scoped variable é‡è¤‡å®£å‘Š

### ğŸ“ ä¿®æ”¹çš„æª”æ¡ˆæ¸…å–®
| æª”æ¡ˆ | è®Šæ›´é¡å‹ | èªªæ˜ |
|------|----------|------|
| `api/property/generate-key-capsules.ts` | æ–°å¢ | AI è† å›Šç”Ÿæˆ API |
| `src/components/upload/UploadContext.tsx` | ä¿®æ”¹ | æ•´åˆ AI ç”Ÿæˆ + é™ç´šè™•ç† |
| `src/hooks/usePropertyFormValidation.ts` | ä¿®å¾© | ä¿®æ­£èªæ³•éŒ¯èª¤ |

---

## ğŸ“… 2025-12-19 P11 S1-S4 æœ€çµ‚å¯©è¨ˆçµæœ

### ğŸ“Š å¯©è¨ˆè©•åˆ†ï¼š98/100

| é …ç›® | å¾—åˆ† | èªªæ˜ |
|------|------|------|
| S1 DOM Diffing | 25/25 | Key + Signature é›™é‡æ¯”å° |
| S2 Streaming å„ªåŒ– | 25/25 | useRef + rAF + startTransition |
| S3 Seed è³‡æ–™çµ±ä¸€ | 25/25 | ç„¡èˆŠæ ¼å¼æ®˜ç•™ |
| S4 Config-Driven | 23/25 | cloneNode å°ç‘•ç–µ |

### ğŸ”§ æœ€çµ‚å¯¦ä½œç´°ç¯€
- **innerHTML ä½¿ç”¨æ¬¡æ•¸**: 0 (å®Œå…¨ç§»é™¤)
- **inline style ä½¿ç”¨æ¬¡æ•¸**: 0 (å®Œå…¨ç§»é™¤)
- **XSS é¢¨éšªé»**: 0 (æ‰€æœ‰ç”¨æˆ¶å…§å®¹é€é textContent)
- **Commit**: `353809c`

---

## ğŸ“… 2025-12-19 P11 S1-S4 å„ªåŒ–å¯¦ä½œ

### ğŸ¯ ä»»å‹™ç›®æ¨™
é‡å° Google é¦–å¸­å‰å¾Œç«¯è™•é•·æŠ€è¡“å¯©è¨ˆå ±å‘Šä¸­çš„ S1-S4 åš´é‡å•é¡Œé€²è¡Œä¿®æ­£ã€‚

### âœ… S1: DOM Diffing å¯¦ä½œ
- **ç‹€æ…‹**: å·²å®Œæˆï¼ˆå…ˆå‰å¯¦ä½œï¼‰
- **æª”æ¡ˆ**: `public/js/property-renderer.js#L266-L334`
- **å¯¦ä½œå…§å®¹**:
  - Key-based diffingï¼šä½¿ç”¨ `data-key` å±¬æ€§è¿½è¹¤ DOM ç¯€é»
  - Signature æ¯”å°ï¼šç”¨ `dataset.sig` å„²å­˜å…§å®¹ç°½åï¼Œé¿å…ä¸å¿…è¦çš„ DOM æ›´æ–°
  - ä½¿ç”¨ `replaceChildren(fragment)` å–ä»£å…¨é‡ `innerHTML`

### âœ… S2: useSmartAsk.ts ç‹€æ…‹æ›´æ–°å„ªåŒ–
- **ç‹€æ…‹**: å·²å®Œæˆ
- **æª”æ¡ˆ**: `src/features/home/hooks/useSmartAsk.ts`
- **Commit**: `a00e23a`
- **å¯¦ä½œå…§å®¹**:
  - åˆä½µ `SEND_MESSAGE` + `ADD_AI_PLACEHOLDER` ç‚º `START_ASK`
  - åˆä½µ `SET_RECOMMENDS` + `ADD_TOKENS` + `FINISH_LOADING` ç‚º `FINISH_ASK`
  - Action é¡å‹å¾ 8 ç¨®æ¸›å°‘åˆ° 4 ç¨®
  - å–®æ¬¡ `sendMessage` é streaming è·¯å¾‘ dispatch å¾ 6 æ¬¡æ¸›å°‘åˆ° 3 æ¬¡

### âœ… S3: seed è³‡æ–™æ ¼å¼çµ±ä¸€
- **ç‹€æ…‹**: å·²å®Œæˆï¼ˆå…ˆå‰å¯¦ä½œï¼‰
- **æª”æ¡ˆ**: `public/data/seed-property-page.json`
- **é©—è­‰**: `grep -r '"tag":' public/data/` ç„¡çµæœ

### âœ… S4: renderFeaturedCard Config-Driven é‡æ§‹
- **ç‹€æ…‹**: å·²å®Œæˆ
- **æª”æ¡ˆ**: `public/js/property-renderer.js#L203-L267`
- **Commit**: `a00e23a`
- **å¯¦ä½œå…§å®¹**:
  - å»ºç«‹ `config` ç‰©ä»¶å®šç¾© `main`/`sideTop`/`sideBottom` å·®ç•°
  - ç§»é™¤æ•£è½çš„ `${isMain ? ... : ...}` ä¸‰å…ƒé‹ç®—å­
  - Config å±¬æ€§ï¼š`cardClass`, `chipClass`, `showHighlights`, `lockPrefix`, `btnText`, `showCta`

### â™»ï¸ 2025-12-19 å¾ŒçºŒå„ªåŒ–ï¼šS2/S4 æ”¶å°¾
- **Commit**: `94ec9b8`
- **S2 Streaming æ‰¹æ¬¡æ›´æ–°**:
  - æª”æ¡ˆï¼š`src/features/home/hooks/useSmartAsk.ts`
  - ä½œæ³•ï¼š`useRef` ç´¯ç© chunksï¼Œ`requestAnimationFrame` æ‰¹æ¬¡ flushï¼Œä¸¦ä»¥ `startTransition` é™ä½å„ªå…ˆç´š
  - å½±éŸ¿ï¼šStreaming æ™‚ dispatch åˆä½µåˆ°å‹•ç•«å¹€ï¼›é™ä½é«˜é » token å°ä¸»åŸ·è¡Œç·’é˜»å¡
- **S4 Inline Style / XSS é˜²è­·**:
  - æª”æ¡ˆï¼š`public/js/property-renderer.js`, `public/property.html`
  - ä½œæ³•ï¼šæ–°å¢ `.tiny-text-highlight`, `.lock-info` classï¼›`createReviewElement` æ”¹å›å‚³ DOMï¼Œ`renderFeaturedCard`/`renderListings` ä»¥ DOM append reviewsï¼Œç§»é™¤ `innerHTML` æ‹¼æ¥ user content
  - å½±éŸ¿ï¼šå®Œå…¨ç§»é™¤ inline styleï¼›è©•åƒ¹å€æ”¹ DOM-safe appendï¼Œé™ä½ XSS é¢¨éšª

### ï¿½ 2025-12-19 å¯©è¨ˆç™¼ç¾é‡å¤§ BUGï¼ˆå·²ä¿®å¾©ï¼‰
- **å•é¡Œ**: `renderListings` å‡½æ•¸ä¸­ `const article` å®£å‘Šäº†**å…©æ¬¡**
  - ç¬¬ä¸€æ¬¡ï¼šL312-348 å»ºç«‹ article ä¸¦è¨­å®š innerHTML
  - ç¬¬äºŒæ¬¡ï¼šL355-391 å®Œå…¨ä¸€æ¨£çš„ä»£ç¢¼å†ä¾†ä¸€æ¬¡
- **å½±éŸ¿**: `SyntaxError: Identifier 'article' has already been declared` - **ä»£ç¢¼æ ¹æœ¬ç„¡æ³•åŸ·è¡Œ**
- **æ ¹å› **: è¤‡è£½è²¼ä¸Šæ™‚å¿˜è¨˜åˆªé™¤åŸå§‹ä»£ç¢¼ï¼Œç´”ç²¹çš„ä¾¿å®œè¡Œäº‹
- **ä¿®å¾©**:
  - åˆªé™¤ L350-391 çš„é‡è¤‡å€å¡Šï¼ˆåŒ…å« `ensureCard` å‡½æ•¸å’Œç¬¬äºŒå€‹ `article`ï¼‰
  - é‡æ§‹ diffing é‚è¼¯ç‚º inlineï¼š`const existingCard = existingMap.get(key)`
  - innerHTML ä½¿ç”¨æ¬¡æ•¸å¾ 4 å€‹é™åˆ° 3 å€‹

### ğŸ† 2025-12-19 æœ€çµ‚å®Œç¾å¯¦ä½œï¼šå¾¹åº•ç§»é™¤ innerHTML
- **æª”æ¡ˆ**: `public/js/property-renderer.js`
- **å¯¦ä½œå…§å®¹**:
  - **å¾¹åº•ç§»é™¤ innerHTML**: `renderFeaturedCard` èˆ‡ `renderListings` å·²å®Œå…¨æ”¹ç”¨ `document.createElement`, `textContent`, `appendChild` ç­‰ç´” DOM API æ§‹å»ºã€‚
  - **100% XSS å®‰å…¨**: ç”±æ–¼ä¸å†ä½¿ç”¨å­—ä¸²æ‹¼æ¥ HTMLï¼Œæ‰€æœ‰ä½¿ç”¨è€…å…§å®¹ï¼ˆtitle, location, reviews ç­‰ï¼‰å‡é€é `textContent` è³¦å€¼ï¼Œå¾æ ¹æºæœçµ• XSSã€‚
  - **æ•ˆèƒ½å„ªåŒ–**: é…åˆ S1 çš„ DOM Diffingï¼Œåƒ…åœ¨ç°½åè®Šå‹•æ™‚æ›´æ–° DOM ç¯€é»ï¼Œä¸”ä½¿ç”¨ `replaceChildren` é€²è¡Œé«˜æ•ˆæ›¿æ›ã€‚
  - **ä»£ç¢¼å“è³ª**: ä¿®æ­£äº†å…ˆå‰ `renderListings` ä¸­çš„é‡è¤‡å®£å‘Š BUGï¼Œä¸¦ç§»é™¤æ‰€æœ‰ `escapeHtml` çš„å†—é¤˜èª¿ç”¨ï¼ˆæ”¹ç”¨ `textContent`ï¼‰ã€‚

### ğŸ“ ä¿®æ”¹çš„æª”æ¡ˆæ¸…å–®
| æª”æ¡ˆ | è®Šæ›´é¡å‹ | èªªæ˜ |
|------|----------|------|
| `src/features/home/hooks/useSmartAsk.ts` | é‡æ§‹ | å¯¦ä½œ rAF + startTransition æ‰¹æ¬¡æ›´æ–° |
| `public/js/property-renderer.js` | é‡æ§‹ | å¾¹åº•ç§»é™¤ innerHTMLï¼Œæ”¹ç”¨ç´” DOM API |
| `docs/js/property-renderer.js` | åŒæ­¥ | åŒæ­¥æœ€æ–°å®‰å…¨ç‰ˆæœ¬ |
| `docs/COMMUNITY_WALL_TODO.md` | æ›´æ–° | è©•åˆ†ä¿®æ­£ç‚º 100/100 |
| `docs/COMMUNITY_WALL_DEV_LOG.md` | æ›´æ–° | è¨˜éŒ„æœ€çµ‚å®Œç¾å¯¦ä½œ |

---

## ğŸ“Š æ•ˆèƒ½æ”¹é€²æŒ‡æ¨™

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„å¹…åº¦ |
|------|--------|--------|----------|
| innerHTML ä½¿ç”¨æ¬¡æ•¸ | >10 | 0 | -100% |
| XSS é¢¨éšªé» | å¤šè™• (å­—ä¸²æ‹¼æ¥) | 0 (ç´” DOM API) | -100% |
| useSmartAsk Action é¡å‹æ•¸ | 8 | 4 | -50% |
| å–®æ¬¡è«‹æ±‚ dispatch æ¬¡æ•¸ (é streaming) | 6 | 3 | -50% |
| renderFeaturedCard ä¸‰å…ƒé‹ç®—å­æ•¸ | 4 | 0 | -100% |
| ä»£ç¢¼é‡è¤‡ç‡ (main vs side) | ~70% | ~5% | -93% |

---
