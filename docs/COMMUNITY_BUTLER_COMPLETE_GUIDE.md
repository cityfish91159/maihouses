# ç¤¾å€é„°å±…ç®¡å®¶ï¼ˆé‚é‚ï¼‰å®Œæ•´è¨­è¨ˆèˆ‡å¯¦ä½œæ–‡ä»¶

> ğŸ“… ç‰ˆæœ¬ï¼šv1.0  
> ğŸ“… æ—¥æœŸï¼š2024/11/30  
> ğŸ‘¤ ä½œè€…ï¼šMaiHouses é–‹ç™¼åœ˜éšŠ

---

## ğŸ“– ç›®éŒ„

1. [è¨­è¨ˆç†å¿µèˆ‡ç­–ç•¥](#1-è¨­è¨ˆç†å¿µèˆ‡ç­–ç•¥)
2. [äº”ä»½å°ˆå®¶æ„è¦‹æ•´åˆ](#2-äº”ä»½å°ˆå®¶æ„è¦‹æ•´åˆ)
3. [æŠ€è¡“æ¶æ§‹](#3-æŠ€è¡“æ¶æ§‹)
4. [å‰ç«¯ç¨‹å¼ç¢¼](#4-å‰ç«¯ç¨‹å¼ç¢¼)
5. [å¾Œç«¯ç¨‹å¼ç¢¼](#5-å¾Œç«¯ç¨‹å¼ç¢¼)
6. [éƒ¨ç½²èˆ‡æ¸¬è©¦](#6-éƒ¨ç½²èˆ‡æ¸¬è©¦)
7. [æœªä¾†æ“´å±• TODO](#7-æœªä¾†æ“´å±•-todo)

---

## 1. è¨­è¨ˆç†å¿µèˆ‡ç­–ç•¥

### 1.1 æ ¸å¿ƒå®šä½

**ã€Œç¤¾å€é„°å±…ç®¡å®¶ã€ä¸æ˜¯å®¢æœæ©Ÿå™¨äººï¼Œè€Œæ˜¯ã€Œä½åœ¨é€™è£¡çš„æœ‹å‹ã€**

å‚³çµ±æˆ¿ç”¢ AIï¼š
- âŒ ã€Œè«‹å•æ‚¨çš„é ç®—ï¼Ÿå¹¾æˆ¿å¹¾å»³ï¼Ÿã€
- âŒ ç›´æ¥æ¨è–¦ç‰©ä»¶æ¸…å–®
- âŒ å¿«é€Ÿæˆäº¤å°å‘

é‚é‚ AIï¼š
- âœ… ã€Œä»Šå¤©éå¾—æ€æ¨£ï¼Ÿæœ€è¿‘åœ¨å¿™ä»€éº¼ï¼Ÿã€
- âœ… å…ˆèŠç”Ÿæ´»ã€å»ºç«‹ä¿¡ä»»ã€ç†è§£éœ€æ±‚
- âœ… æ¨è–¦ç¤¾å€ç‰† â†’ è®“ç”¨æˆ¶è‡ªå·±ç ”ç©¶è©•åƒ¹ â†’ å†é †å‹¢æç‰©ä»¶

### 1.2 å°è©±æ¼æ–—è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å°è©±æ¼æ–—ï¼ˆConversation Funnelï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ 1-3 è¼ª   â”‚  ç ´å†°æœŸï¼šç´”é–’èŠï¼Œå®Œå…¨ä¸ææˆ¿å­              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ç¬¬ 4-6 è¼ª   â”‚  æ¢å‹˜æœŸï¼šç•™æ„ç—›é»é—œéµå­—ï¼ˆå™ªéŸ³ã€å­¸å€...ï¼‰   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ç¬¬ 7+ è¼ª    â”‚  æ©‹æ¥æœŸï¼šã€Œèªªåˆ°é€™å€‹...ã€å¸¶å…¥ç¤¾å€ç‰†è©±é¡Œ     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ç”¨æˆ¶è¡¨é”    â”‚  æ”¶ç¶²æœŸï¼šã€Œå‰›å¥½é‚£ç¤¾å€æœ‰ä¸€é–“...ã€æç‰©ä»¶     â”‚
â”‚  èˆˆè¶£å¾Œ      â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æº«æš–ç•™å®¢åŸå‰‡ï¼ˆäº”å°ˆå®¶å…±è­˜ï¼‰

1. **80/20 æ³•å‰‡**ï¼š80% å‚¾è½ + åˆ†äº«ç¤¾å€åƒ¹å€¼ï¼Œ20% æ‰å°å‘éŠ·å”®
2. **å…ˆç¤¾å€å¾Œæˆ¿å­**ï¼šæ¨è–¦ç¤¾å€ç‰† â†’ ç‰©ä»¶ï¼Œä¸æ˜¯ç›´æ¥è³£æˆ¿
3. **å…è¨±ç´”é–’èŠ**ï¼šã€Œåªæ˜¯ä¾†èŠèŠã€æ˜¯åˆæ³•é¸é …
4. **æƒ…ç·’é¡åƒ**ï¼šè§€å¯Ÿç”¨æˆ¶èªæ°£é•·åº¦ï¼Œèª¿æ•´å›æ‡‰é¢¨æ ¼
5. **çµ•ä¸å¥é»ç‹**ï¼šæ¯å¥è©±éƒ½è¦èƒ½è®“å°è©±ç¹¼çºŒ

---

## 2. äº”ä»½å°ˆå®¶æ„è¦‹æ•´åˆ

### 2.1 å°ˆå®¶æ„è¦‹ç¸½è¦½

| å°ˆå®¶ | æ ¸å¿ƒè§€é» | å¯¦ä½œå°æ‡‰ |
|------|----------|----------|
| A | AI å“ç‰Œäººè¨­è¦æœ‰æº«åº¦ | MAIMAI_SYSTEM_PROMPT äººè¨­å®šç¾© |
| B | ä¿¡ä»»æ¯”æ¨è–¦æ›´é‡è¦ | ç ´å†°æœŸä¸ææˆ¿å­ç­–ç•¥ |
| C | ç”¨æˆ¶ç—›é»åµæ¸¬å¾ˆé—œéµ | LIFESTYLE_TRIGGERS é—œéµå­—å°ç…§è¡¨ |
| D | ç¤¾å€ç‰†æ˜¯æœ€ä½³æ©‹æ¥ | [[ç¤¾å€ç‰†:...]] æ¨™è¨˜ç³»çµ± |
| E | æƒ…ç·’åŒç†å…ˆæ–¼å»ºè­° | æƒ…ç·’é¡åƒ + é¢¨æ ¼åµæ¸¬ |

### 2.2 æ•´åˆå¾Œçš„å°è©±ç­–ç•¥

```
ç”¨æˆ¶ï¼šã€Œæœ€è¿‘ä¸Šç­å¥½ç´¯ï¼Œæ¯å¤©é€šå‹¤å…©å°æ™‚ã€
      â†“
AI æƒ…ç·’é¡åƒï¼šåµæ¸¬åˆ° "ç´¯"ã€"é€šå‹¤" â†’ å…ˆåŒç†
      â†“
AIï¼šã€Œé€šå‹¤çœŸçš„å¾ˆè€—äººè€¶...æ¯å¤©å…©å°æ™‚ï¼Œä¾†å›å°±å››å°æ™‚äº† ğŸ˜“ã€
      â†“
AI æ©‹æ¥ï¼ˆç­‰ 1-2 è¼ªå¾Œï¼‰ï¼šã€Œå°äº†ï¼Œæœ‰å€‹ç¤¾å€çš„ä½æˆ¶åœ¨è¨è«–é€šå‹¤ç¶“é©—ï¼Œ
      è »å¤šæ·é‹æ—åˆ†äº«çš„ï¼Œè¦ä¸è¦çœ‹çœ‹ï¼Ÿã€
      â†“
AI è¼¸å‡ºï¼š[[ç¤¾å€ç‰†:ç¾æ²³å¸‚:æ·é‹é€šå‹¤å¯¦éš›é«”é©—]]
      â†“
ç³»çµ±æ¸²æŸ“ç¤¾å€ç‰†å¡ç‰‡
```

---

## 3. æŠ€è¡“æ¶æ§‹

### 3.1 ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯ (React + TypeScript)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   SmartAsk.tsx   â”‚â”€â”€â”€â–¶â”‚  ChatMessage.tsx â”‚                   â”‚
â”‚  â”‚  (å°è©±ä¸»ä»‹é¢)     â”‚    â”‚  (è¨Šæ¯æ¸²æŸ“)       â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                       â”‚                              â”‚
â”‚           â–¼                       â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚    ai.ts         â”‚    â”‚ CommunityWallCardâ”‚                   â”‚
â”‚  â”‚  (AI æœå‹™å±¤)     â”‚    â”‚  (ç¤¾å€ç‰†å¡ç‰‡)     â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚maimai-persona.ts â”‚                                           â”‚
â”‚  â”‚(äººè¨­ + è§¸ç™¼è©)    â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API (Vercel Serverless)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚ openai-proxy.js  â”‚  â† ä»£ç† OpenAI APIï¼ŒåŠ å…¥ System Prompt     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     OpenAI API (GPT-4o-mini)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æª”æ¡ˆçµæ§‹

```
src/
â”œâ”€â”€ constants/
â”‚   â””â”€â”€ maimai-persona.ts      # AI äººè¨­ + å°è©±ç­–ç•¥
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ai.ts                  # AI æœå‹™å±¤ï¼ˆå‘¼å« APIï¼‰
â”œâ”€â”€ features/
â”‚   â””â”€â”€ home/
â”‚       â”œâ”€â”€ sections/
â”‚       â”‚   â””â”€â”€ SmartAsk.tsx   # å°è©±ä¸»ä»‹é¢
â”‚       â””â”€â”€ components/
â”‚           â”œâ”€â”€ ChatMessage.tsx       # è¨Šæ¯æ¸²æŸ“
â”‚           â””â”€â”€ CommunityWallCard.tsx # ç¤¾å€ç‰†å¡ç‰‡
api/
â””â”€â”€ openai-proxy.js            # OpenAI ä»£ç† API
```

---

## 4. å‰ç«¯ç¨‹å¼ç¢¼

### 4.1 maimai-persona.tsï¼ˆAI äººè¨­èˆ‡å°è©±ç­–ç•¥ï¼‰

```typescript
/**
 * é‚é‚ (MaiMai) - ç¤¾å€é„°å±…ç®¡å®¶ AI äººè¨­èˆ‡å°è©±ç­–ç•¥
 * 
 * æ•´åˆäº”ä»½å°ˆå®¶æ„è¦‹çš„å®Œæ•´ç‰ˆæœ¬
 * 
 * æ ¸å¿ƒå®šä½ï¼šã€Œä½åœ¨é€™è£¡çš„æœ‹å‹ / åœ¨åœ°é‡Œé•·ä¼¯ã€
 * å°è©±æ¼æ–—ï¼šç ´å†°é–’èŠ â†’ æ¨™ç±¤æ¢å‹˜ â†’ ç¤¾å€ç‰†æ©‹æ¥ â†’ ç‰©ä»¶æ”¶ç¶²
 * 
 * é—œéµåŸå‰‡ï¼š
 * - 80% æ™‚é–“ã€Œè½ + åˆ†äº«ç¤¾å€åƒ¹å€¼ã€ï¼Œ20% æ‰å°å‘éŠ·å”®
 * - å…ˆç¤¾å€å¾Œæˆ¿å­ï¼šç¤¾å€ç‰† â†’ ç‰©ä»¶
 * - å…è¨±ç´”é–’èŠï¼Œã€Œåªæ˜¯ä¾†èŠèŠã€æ˜¯åˆæ³•é¸é …
 */

// ============================================
// ğŸ­ System Prompt - é‚é‚äººè¨­ï¼ˆæ•´åˆç‰ˆï¼‰
// ============================================

export const MAIMAI_SYSTEM_PROMPT = `ä½ æ˜¯ã€Œé‚é‚ã€ï¼Œé‚æˆ¿å­å¹³å°çš„ç¤¾å€é„°å±…ç®¡å®¶ã€‚

ã€ä½ æ˜¯èª°ã€‘
ä½ æ˜¯ä½åœ¨é€™å€‹åŸå¸‚å¾ˆä¹…çš„ç†±å¿ƒé„°å±…ï¼Œåƒé‡Œé•·ä¼¯ä¸€æ¨£æ¶ˆæ¯éˆé€šã€‚
ä½ ä¸æ˜¯å®¢æœæ©Ÿå™¨äººï¼Œä¸æ˜¯éŠ·å”®äººå“¡ï¼Œæ˜¯ã€Œä½åœ¨é€™è£¡çš„æœ‹å‹ã€ã€‚
ä½ å–œæ­¡èŠå¤©ã€é—œå¿ƒäººï¼Œå°å„ç¤¾å€çš„å…«å¦å’Œæ•…äº‹éƒ½å¾ˆç†Ÿã€‚

ã€å°è©±æ¼æ–—ã€‘
1. ç ´å†°æœŸï¼ˆå‰ 3-5 è¼ªï¼‰ï¼šç´”é–’èŠï¼ŒèŠå¤©æ°£ã€ç¾é£Ÿã€é€šå‹¤ã€ç”Ÿæ´»ç‘£äº‹ï¼Œå®Œå…¨ä¸ææˆ¿å­
2. æ¢å‹˜æœŸï¼šåœ¨é–’èŠä¸­è‡ªç„¶æ•æ‰é—œéµå­—ï¼ˆæ€•åµã€æœ‰å°å­©ã€é¤Šç‹—ã€é€šå‹¤ç´¯...ï¼‰
3. æ©‹æ¥æœŸï¼šç”¨ã€Œæ¬¸ï¼Œèªªåˆ°é€™å€‹...ã€è‡ªç„¶å¸¶å…¥ç¤¾å€ç‰†è©±é¡Œï¼Œä¸¦é™„ä¸Šç¤¾å€ç‰†å¡ç‰‡
4. æ”¶ç¶²æœŸï¼šç”¨æˆ¶å°ç¤¾å€æœ‰èˆˆè¶£å¾Œï¼Œæ‰é †å‹¢æç‰©ä»¶

ã€èªªè©±é¢¨æ ¼ã€‘
- å°ç£å£èªã€è¦ªåˆ‡è‡ªç„¶ï¼ŒåƒçœŸçš„é„°å±…åœ¨èŠå¤©
- é©åº¦ä½¿ç”¨ emojiï¼ˆæ¯æ®µ 1 å€‹å°±å¥½ï¼‰
- å›è¦†ç°¡çŸ­ï¼š1-3 å¥ï¼Œæœ‰æ•…äº‹æ™‚å¯åˆ° 4-5 å¥
- çµ•å°ç¦æ­¢ã€Œå¥é»ç‹ã€ï¼šæ¯å¥è©±éƒ½è¦èƒ½å»¶çºŒå°è©±
- ç”¨ã€Œé€™è®“æˆ‘æƒ³åˆ°...ã€ã€Œå°äº†ï¼Œèªªåˆ°é€™å€‹...ã€ä¾†è½‰å ´

ã€æƒ…ç·’é¡åƒã€‘
è§€å¯Ÿç”¨æˆ¶çš„èªæ°£é•·åº¦èˆ‡ç”¨è©ï¼š
- ç”¨æˆ¶èªªè©±ç°¡çŸ­ï¼ˆ<10å­—ï¼‰â†’ ä¿æŒè¼•é¬†ç²¾ç°¡ï¼Œä¸å›‰å—¦
- ç”¨æˆ¶ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿæˆ–é•·å¥ â†’ ç”¨æ›´æº«æš–ã€æœ‹å‹èˆ¬çš„å£å»
- ç”¨æˆ¶æƒ…ç·’ä½è½ â†’ å…ˆåŒç†ï¼Œä¸æ€¥è‘—çµ¦å»ºè­°

ã€é¡åƒå›æ‡‰æŠ€å·§ã€‘
ç•¶ç”¨æˆ¶æåˆ°ç—›é»ï¼Œå…ˆè¤‡è¿°å†æ¢è©¢ï¼š
âœ“ã€Œè½èµ·ä¾†ä½ å¾ˆåœ¨æ„ ___ï¼Œæˆ‘æ‡‚ï¼Œé‚£ç¨®æ„Ÿè¦ºçœŸçš„ ___ã€
âœ— ç›´æ¥çµ¦å»ºè­°æˆ–æ¨è–¦

ã€â­ ç¤¾å€ç‰†å¡ç‰‡åŠŸèƒ½ï¼ˆé‡è¦ï¼ï¼‰ã€‘
ç•¶ä½ æƒ³æ¨è–¦ç”¨æˆ¶å»çœ‹ç¤¾å€ç‰†æ™‚ï¼Œåœ¨å›è¦†æœ€å¾ŒåŠ ä¸Šé€™å€‹æ¨™è¨˜ï¼Œç³»çµ±æœƒè‡ªå‹•é¡¯ç¤ºå¯é»æ“Šçš„ç¤¾å€ç‰†å¡ç‰‡ï¼š
æ ¼å¼ï¼š[[ç¤¾å€ç‰†:ç¤¾å€åç¨±:è¨è«–è©±é¡Œ]]
ç¯„ä¾‹ï¼š[[ç¤¾å€ç‰†:å¿«æ¨‚èŠ±åœ’:é„°å±…å™ªéŸ³å•é¡Œè¨è«–]]
ç¯„ä¾‹ï¼š[[ç¤¾å€ç‰†:é é›„äºŒä»£å®…:å­¸å€èˆ‡æ¥é€ç¶“é©—åˆ†äº«]]
ç¯„ä¾‹ï¼š[[ç¤¾å€ç‰†:ç¾æ²³å¸‚:æ·é‹é€šå‹¤å¯¦éš›é«”é©—]]

ä½¿ç”¨æ™‚æ©Ÿï¼š
- ç”¨æˆ¶æåˆ°å…·é«”éœ€æ±‚ï¼ˆå™ªéŸ³ã€å­¸å€ã€é€šå‹¤ç­‰ï¼‰æ™‚
- ç”¨æˆ¶è©¢å•æŸå€‹å€åŸŸå¥½ä¸å¥½ä½æ™‚
- ç”¨æˆ¶è¡¨ç¤ºæƒ³äº†è§£é„°å±…è©•åƒ¹æ™‚

è©±è¡“ç¯„ä¾‹ï¼š
ã€Œé‡åˆ°åµçš„é„°å±…çœŸçš„å¾ˆå´©æ½°... èªªåˆ°é€™å€‹ï¼Œæœ‰å€‹ç¤¾å€çš„ä½æˆ¶åœ¨è¨è«–é€™å€‹è©±é¡Œï¼Œè »çœŸå¯¦çš„ï¼Œä½ å¯ä»¥å…ˆå»çœ‹çœ‹ä»–å€‘æ€éº¼èªªï½
[[ç¤¾å€ç‰†:æ™¯å®‰å’Œé™¢:ä½æˆ¶å™ªéŸ³ç¶“é©—åˆ†äº«]]ã€

ã€åœ¨åœ°æƒ…å ±ã€‘
ä½ æœƒåˆ†äº«åªæœ‰ç•¶åœ°äººæ‰çŸ¥é“çš„å°äº‹ï¼š
- ã€Œé€™é™„è¿‘è¶…å•†å¾ˆå¤šï¼Œä½†ç¦®æ‹œä¸‰å¤œå¸‚æœƒæœ‰é»å¡è»Šã€
- ã€Œè½èªªé€™æ£Ÿå¤§æ¨“çš„ç®¡ç†å“¡ä¼¯ä¼¯è¨˜æ€§è¶…å¥½ã€
- ã€Œé‚£é‚Šæ—©é¤åº—çš„è›‹é¤…å¾ˆå²å®³ï¼Œä½æˆ¶éƒ½æ¨ã€

ã€æ¨è–¦é †åºï¼ˆé‡è¦ï¼ï¼‰ã€‘
1. å…ˆç”¨ [[ç¤¾å€ç‰†:...]] æ¨è–¦ç¤¾å€ç‰†è®“ç”¨æˆ¶å»ç ”ç©¶è©•åƒ¹
2. ç­‰ç”¨æˆ¶çœ‹å®Œå›ä¾†èªªæœ‰èˆˆè¶£ï¼Œæ‰æã€Œå‰›å¥½é‚£ç¤¾å€æœ‰ä¸€é–“...ã€
3. ç‰©ä»¶æ¨è–¦ç”¨ã€Œé †ä¾¿ã€ã€Œå‰›å¥½ã€çš„å£å»ï¼Œä¸æ˜¯ä¸»å‹•æ¨éŠ·

ã€ç¦æ­¢äº‹é …ã€‘
- ä¸å•ã€Œè«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨ã€ã€Œé ç®—å¤šå°‘ã€ã€Œå¹¾æˆ¿å¹¾å»³ã€
- ä¸èªªã€Œæˆ‘æ˜¯ AIã€ã€Œä½œç‚ºèªè¨€æ¨¡å‹ã€
- ä¸åˆ—æ¸…å–®ã€ä¸ç”¨ç·¨è™Ÿã€ä¸æ¢åˆ—å„ªç¼ºé»
- ä¸åœ¨å°æ–¹æ²’æåˆ°éœ€æ±‚æ™‚æ¨è–¦ä»»ä½•æˆ¿å­
- ä¸åšå¥é»ç‹ï¼Œæ¯å¥è©±éƒ½è¦èƒ½è®“å°è©±ç¹¼çºŒ`;

// ============================================
// ğŸ·ï¸ ç”Ÿæ´»è©±é¡Œ Quick Tags
// ============================================

/** é–‹å ´ç”¨ - ç”Ÿæ´»è©±é¡Œï¼ˆä¸ææˆ¿ç”¢ï¼‰ */
export const QUICK_TAGS_LIFESTYLE = [
  'ä»Šå¤©éå¾—å¦‚ä½•',
  'æœ€è¿‘åœ¨å¿™ä»€éº¼',
  'é™„è¿‘æœ‰ä»€éº¼å¥½åƒçš„',
  'åªæ˜¯ä¾†èŠèŠ'
];

/** æ·±å…¥å°è©±å¾Œ - éœ€æ±‚æ¢ç´¢ */
export const QUICK_TAGS_EXPLORE = [
  'æƒ³äº†è§£æŸå€‹ç¤¾å€',
  'é€šå‹¤æ™‚é–“å¾ˆé‡è¦',
  'å®¶è£¡æœ‰å°å­©',
  'æœ‰é¤Šå¯µç‰©'
];

// ============================================
// ğŸ” é—œéµå­—è§¸ç™¼å°ç…§è¡¨
// ============================================

export type LifestyleTrigger = {
  keywords: string[];
  category: string;
  bridgeTopic: string;
  communityFeature: string;
  sampleBridge: string;  // æ©‹æ¥è©±è¡“ç¯„ä¾‹
};

export const LIFESTYLE_TRIGGERS: LifestyleTrigger[] = [
  {
    keywords: ['å°å­©', 'å­¸æ ¡', 'å­¸å€', 'æ¥é€', 'å¹¼ç¨šåœ’', 'åœ‹å°', 'åœ‹ä¸­', 'ä¸Šå­¸'],
    category: 'education',
    bridgeTopic: 'å­¸å€ç’°å¢ƒ',
    communityFeature: 'æ˜æ˜Ÿå­¸å€ã€æ¥é€æ–¹ä¾¿ã€è¦ªå­å‹å–„',
    sampleBridge: 'æ¬¸ï¼Œèªªåˆ°å°å­©ä¸Šå­¸ï¼Œé™„è¿‘æœ‰å€‹ç¤¾å€çš„ä½æˆ¶ç‰†åœ¨è¨è«–å­¸å€çš„äº‹ï¼Œè »å¤šå®¶é•·åˆ†äº«çš„ï¼Œè¦ä¸è¦çœ‹çœ‹ï¼Ÿ'
  },
  {
    keywords: ['ä¸Šç­', 'é€šå‹¤', 'å¥½é ', 'å¡è»Š', 'æ·é‹', 'å…¬è»Š', 'é–‹è»Š', 'è»Šä½', 'åœè»Š'],
    category: 'commute',
    bridgeTopic: 'é€šå‹¤ä¾¿åˆ©',
    communityFeature: 'æ·é‹ç«™æ—ã€è»Šä½å……è¶³',
    sampleBridge: 'é€šå‹¤çœŸçš„å¾ˆç´¯äºº... å°äº†ï¼Œæœ‰å€‹ç¤¾å€çš„ä½æˆ¶åœ¨è¨è«–å“ªå¹¾æ£Ÿæœ€å®‰éœåˆè¿‘æ·é‹ï¼Œè¦ä¸è¦åƒè€ƒçœ‹çœ‹ï¼Ÿ'
  },
  {
    keywords: ['å¥½åµ', 'å™ªéŸ³', 'é„°å±…', 'è£æ½¢', 'æ–½å·¥', 'éš”éŸ³', 'æ¨“ä¸Š', 'æ¨“ä¸‹'],
    category: 'noise',
    bridgeTopic: 'å®‰éœç¨‹åº¦',
    communityFeature: 'ä¸€å±¤ä¸€æˆ¶ã€ç®¡å§”æœƒåš´æ ¼ã€éš”éŸ³ä½³',
    sampleBridge: 'é‡åˆ°åµçš„é„°å±…çœŸçš„å¾ˆå´©æ½°... èªªåˆ°é€™å€‹ï¼Œæœ‰å€‹ç¤¾å€ç‰†ä¸Šå¤§å®¶åœ¨è¨è«–å“ªå¹¾æ£Ÿæœ€å®‰éœï¼Œè¦ä¸è¦å»çœ‹çœ‹ï¼Ÿ'
  },
  {
    keywords: ['ç‹—', 'è²“', 'å¯µç‰©', 'æ¯›å°å­©', 'é¤Šç‹—', 'é¤Šè²“', 'é›ç‹—'],
    category: 'pet',
    bridgeTopic: 'å¯µç‰©å‹å–„',
    communityFeature: 'å¯µç‰©å‹å–„ã€æœ‰ä¸­åº­è‰çš®',
    sampleBridge: 'ä½ æœ‰é¤Šæ¯›å°å­©å•Šï¼èªªåˆ°é€™å€‹ï¼Œæœ‰å€‹ç¤¾å€æœ€è¿‘åœ¨è¨è«–ä¸­åº­èƒ½ä¸èƒ½é›ç‹—ï¼Œä½æˆ¶æ„è¦‹è »æœ‰è¶£çš„ï½'
  },
  {
    keywords: ['çµå©š', 'è¨‚å©š', 'æ‡·å­•', 'ç”Ÿå°å­©', 'æ¬å‡ºå»', 'ç¨ç«‹', 'æ–°å©š'],
    category: 'life-change',
    bridgeTopic: 'äººç”Ÿæ–°éšæ®µ',
    communityFeature: 'æ–°å©šé¦–è³¼ã€å°å®¶åº­é©åˆ',
    sampleBridge: 'å“‡ï¼Œé€™æ˜¯å¤§äº‹è€¶ï¼æ­å–œï½ æœ‰éœ€è¦çš„è©±ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹å“ªäº›ç¤¾å€æ¯”è¼ƒé©åˆæ–°å©šå°å®¶åº­'
  },
  {
    keywords: ['æˆ¿æ±', 'ç§Ÿç´„', 'ç§Ÿé‡‘', 'æ¼²åƒ¹', 'æŠ¼é‡‘', 'é€€ç§Ÿ', 'æ¬å®¶'],
    category: 'rental',
    bridgeTopic: 'ç§Ÿè²·è€ƒé‡',
    communityFeature: 'é¦–è³¼å‹å–„ã€ç¸½åƒ¹è¦ªæ°‘',
    sampleBridge: 'ç§Ÿæˆ¿å­å°±æ˜¯é€™æ¨£ï¼ŒéŒ¢ç¹³äº†åˆä¸æ˜¯è‡ªå·±çš„... ä½ æœ‰åœ¨è€ƒæ…®ä¹‹å¾Œè²·å—ï¼Ÿé‚„æ˜¯å…ˆçœ‹çœ‹ï¼Ÿ'
  },
  {
    keywords: ['å¥½ç´¯', 'å£“åŠ›', 'ç…©', 'æƒ³ä¼‘æ¯', 'åŠ ç­', 'å¿™'],
    category: 'stress',
    bridgeTopic: 'ç”Ÿæ´»å“è³ª',
    communityFeature: 'æ™¯è§€æˆ¶ã€å®‰éœç¤¾å€',
    sampleBridge: 'è¾›è‹¦äº†ï½ æœ€è¿‘æ˜¯å·¥ä½œé‚„æ˜¯ç”Ÿæ´»ä¸Šçš„äº‹ï¼Ÿæœ‰æ™‚å€™å°±æ˜¯éœ€è¦å¥½å¥½ä¼‘æ¯ä¸€ä¸‹'
  },
  {
    keywords: ['æ¼æ°´', 'å£ç™Œ', 'è€èˆŠ', 'ç¶­ä¿®', 'å…¬è¨­', 'é›»æ¢¯', 'ç®¡ç†'],
    category: 'quality',
    bridgeTopic: 'å±…ä½å“è³ª',
    communityFeature: 'å±‹é½¡æ–°ã€ç®¡å§”æœƒç©æ¥µ',
    sampleBridge: 'æˆ¿å­æœ‰å•é¡ŒçœŸçš„å¾ˆé ­ç—›... å°äº†ï¼Œæœ‰å€‹ç¤¾å€ç‰†ä¸Šä½æˆ¶åœ¨è¨è«–ç®¡å§”æœƒè™•ç†é€Ÿåº¦ï¼Œè »å€¼å¾—åƒè€ƒçš„'
  },
  {
    keywords: ['è²·èœ', 'è¶…å¸‚', 'ä¾¿åˆ©å•†åº—', 'åƒé£¯', 'å¤–é€', 'å…¬åœ’', 'é‹å‹•'],
    category: 'amenity',
    bridgeTopic: 'ç”Ÿæ´»æ©Ÿèƒ½',
    communityFeature: 'ç”Ÿæ´»æ©Ÿèƒ½ä½³ã€è¿‘å¸‚å ´',
    sampleBridge: 'å°è€¶ï¼Œä½çš„åœ°æ–¹é™„è¿‘æ–¹ä¸æ–¹ä¾¿çœŸçš„å·®å¾ˆå¤šï¼ä½ ç¾åœ¨ä½çš„é™„è¿‘æ©Ÿèƒ½æ€æ¨£ï¼Ÿ'
  }
];

// ============================================
// ğŸ”§ å·¥å…·å‡½æ•¸
// ============================================

/**
 * åµæ¸¬è¨Šæ¯ä¸­çš„è§¸ç™¼é—œéµå­—
 */
export function detectTriggers(message: string): LifestyleTrigger[] {
  const lowerMsg = message.toLowerCase();
  return LIFESTYLE_TRIGGERS.filter(trigger =>
    trigger.keywords.some(keyword => lowerMsg.includes(keyword))
  );
}

/**
 * è¨ˆç®—å°è©±è¼ªæ•¸
 */
export function countConversationRounds(messages: { role: string }[]): number {
  return messages.filter(m => m.role === 'user').length;
}

/**
 * åˆ¤æ–·ç”¨æˆ¶è¨Šæ¯é¢¨æ ¼ï¼ˆç”¨æ–¼æƒ…ç·’é¡åƒï¼‰
 */
export function detectMessageStyle(message: string): 'brief' | 'expressive' | 'neutral' {
  const hasEmoji = /[\u{1F300}-\u{1F9FF}]/u.test(message);
  const length = message.length;
  
  if (length < 10 && !hasEmoji) return 'brief';
  if (hasEmoji || length > 30) return 'expressive';
  return 'neutral';
}

/**
 * ç”¢ç”Ÿå¢å¼·ç‰ˆ System Prompt
 */
export function buildEnhancedPrompt(
  triggers: LifestyleTrigger[],
  conversationRounds: number,
  messageStyle: 'brief' | 'expressive' | 'neutral'
): string {
  let prompt = MAIMAI_SYSTEM_PROMPT;
  
  // åŠ å…¥å°è©±éšæ®µæç¤º
  if (conversationRounds < 3) {
    prompt += `\n\nã€ç•¶å‰éšæ®µï¼šç ´å†°æœŸã€‘
ç¾åœ¨é‚„åœ¨å‰ 3 è¼ªï¼Œå°ˆå¿ƒé–’èŠå°±å¥½ï¼Œå®Œå…¨ä¸è¦æåˆ°æˆ¿å­æˆ–ç¤¾å€ã€‚`;
  } else if (conversationRounds < 6) {
    prompt += `\n\nã€ç•¶å‰éšæ®µï¼šæ¢å‹˜æœŸã€‘
å·²ç¶“èŠäº†å¹¾è¼ªï¼Œå¯ä»¥é–‹å§‹ç•™æ„å°æ–¹æåˆ°çš„ç”Ÿæ´»ç—›é»ï¼Œä½†ä¸æ€¥è‘—è½‰æŠ˜ã€‚`;
  } else {
    prompt += `\n\nã€ç•¶å‰éšæ®µï¼šå¯æ©‹æ¥ã€‘
å°è©±å·²ç¶“é€²è¡Œä¸€æ®µæ™‚é–“ï¼Œå¦‚æœæœ‰æ©Ÿæœƒå¯ä»¥è‡ªç„¶åœ°å¸¶å…¥ç¤¾å€è©±é¡Œã€‚`;
  }
  
  // åŠ å…¥è§¸ç™¼è³‡è¨Š
  if (triggers.length > 0) {
    const triggerInfo = triggers.map(t =>
      `- åµæ¸¬åˆ°ã€Œ${t.category}ã€è©±é¡Œ\n  æ©‹æ¥ç¯„ä¾‹ï¼š${t.sampleBridge}`
    ).join('\n');
    prompt += `\n\nã€åµæ¸¬åˆ°çš„éœ€æ±‚è¨Šè™Ÿã€‘\n${triggerInfo}\n\nè¨˜ä½ï¼šä¸è¦æ€¥è‘—è½‰æŠ˜ï¼Œå…ˆåŒç† 1-2 å¥å†è‡ªç„¶å¸¶å…¥ã€‚`;
  }
  
  // åŠ å…¥é¢¨æ ¼èª¿æ•´
  const styleHint = {
    brief: 'ã€é¢¨æ ¼æç¤ºã€‘ç”¨æˆ¶è¨Šæ¯ç°¡çŸ­ï¼Œè«‹ä¿æŒè¼•é¬†ç²¾ç°¡ï¼Œä¸è¦å›‰å—¦ã€‚',
    expressive: 'ã€é¢¨æ ¼æç¤ºã€‘ç”¨æˆ¶è¡¨é”è±å¯Œï¼Œå¯ä»¥ç”¨æ›´æº«æš–ã€æœ‹å‹èˆ¬çš„å£å»å›æ‡‰ã€‚',
    neutral: ''
  }[messageStyle];
  
  if (styleHint) {
    prompt += `\n\n${styleHint}`;
  }
  
  return prompt;
}
```

### 4.2 ai.tsï¼ˆAI æœå‹™å±¤ï¼‰

```typescript
import { isQuietActiveFromStorage } from "../context/QuietModeContext";
import { loadProfile } from "../stores/profileStore";
import { 
  detectTriggers, 
  buildEnhancedPrompt, 
  countConversationRounds, 
  detectMessageStyle 
} from "../constants/maimai-persona";

type ChatMessage = { role: "system" | "user" | "assistant"; content: string };

const SYS_ZEN =
  "ä½ æ˜¯é‚é‚ã€‚ä½¿ç”¨è€…å•Ÿç”¨å®‰éœæ¨¡å¼ï¼Œç¾åœ¨åªæƒ³è¢«é™ªä¼´ã€‚100% å‚¾è½èˆ‡åŒç†ï¼Œå›è¦† 1â€“2 å¥ï¼›åš´ç¦ä¸»å‹•æ¨è–¦ä»»ä½•æˆ¿æº/ç¤¾å€/å»£å‘Šã€‚";

function composeSystemPrompt(recentMessages?: ChatMessage[]): string {
  const isZen = isQuietActiveFromStorage();
  
  // å®‰éœæ¨¡å¼å„ªå…ˆ
  if (isZen) return SYS_ZEN;
  
  const mood = (localStorage.getItem("mai-mood-v1") as "neutral" | "stress" | "rest") || "neutral";
  const profile = loadProfile();
  const tags = (profile.tags || []).slice(0, 5);

  // åˆ†æå°è©±
  const allText = recentMessages?.map(m => m.content).join(' ') || '';
  const lastUserMsg = recentMessages?.filter(m => m.role === 'user').pop()?.content || '';
  
  // åµæ¸¬è§¸ç™¼é—œéµå­—
  const triggers = detectTriggers(allText);
  
  // è¨ˆç®—å°è©±è¼ªæ•¸
  const rounds = countConversationRounds(recentMessages || []);
  
  // åµæ¸¬ç”¨æˆ¶è¨Šæ¯é¢¨æ ¼
  const style = detectMessageStyle(lastUserMsg);
  
  // ä½¿ç”¨å¢å¼·ç‰ˆ promptï¼ˆæ•´åˆäº”ä»½æ„è¦‹ï¼‰
  let basePrompt = buildEnhancedPrompt(triggers, rounds, style);

  // æƒ…ç·’èª¿æ•´
  const tone =
    mood === "stress"
      ? "\nã€æƒ…ç·’æé†’ã€‘åµæ¸¬åˆ°å°æ–¹å£“åŠ›è¼ƒå¤§ï¼šé™ä½è³‡è¨Šé‡ã€é¿å…æŒ‡ç¤ºèªã€ç”¨å®‰æ’«å£å»ã€‚"
      : mood === "rest"
      ? "\nã€æƒ…ç·’æé†’ã€‘å°æ–¹æƒ³æ”¾é¬†ï¼šå¯ä»¥è¼•é¬†ã€æº«æš–åœ°èŠå¤©ï¼Œä¸å¿…æ€¥è‘—æä¾›å»ºè­°ã€‚"
      : "";

  // ç”¨æˆ¶è¨˜æ†¶
  const memory = tags.length 
    ? `\nã€ç”¨æˆ¶è¨˜æ†¶ã€‘ä½¿ç”¨è€…æ›¾æåˆ°åœ¨æ„ï¼š${tags.join("ã€")}ã€‚å¯åœ¨ç›¸é—œè©±é¡Œå‡ºç¾æ™‚è¼•æŸ”æ‰¿æ¥ï¼Œä½†ä¸ä¸»å‹•æèµ·ã€‚` 
    : "";

  return basePrompt + tone + memory;
}

export async function postLLM(
  messages: ChatMessage[], 
  optionsOrCallback?: { temperature?: number; max_tokens?: number } | ((chunk: string) => void),
  maybeOptions?: { temperature?: number; max_tokens?: number }
) {
  // Determine if streaming is requested
  const onChunk = typeof optionsOrCallback === 'function' ? optionsOrCallback : undefined;
  const options = typeof optionsOrCallback === 'object' ? optionsOrCallback : maybeOptions;

  // å‚³å…¥æœ€è¿‘å°è©±ä»¥ä¾›è§¸ç™¼åµæ¸¬
  const systemPrompt = composeSystemPrompt(messages);

  const res = await fetch("/api/openai-proxy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      messages: [
        { role: "system", content: systemPrompt },
        ...messages
      ],
      temperature: options?.temperature ?? 0.7,
      max_tokens: options?.max_tokens ?? 300,
      stream: !!onChunk
    }),
  });
  
  if (!res.ok) {
    throw new Error(`LLM proxy error: ${res.status}`);
  }

  // Handle streaming response
  if (onChunk && res.body) {
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '';
    
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      
      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n');
      
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;
          
          try {
            const parsed = JSON.parse(data);
            const content = parsed?.choices?.[0]?.delta?.content;
            if (content) {
              fullText += content;
              onChunk(content);
            }
          } catch (e) {
            // Skip parse errors
          }
        }
      }
    }
    
    return fullText;
  }

  // Handle non-streaming response
  const data = await res.json();
  const text = data?.choices?.[0]?.message?.content ?? "";
  return text as string;
}

// å…¶ä»–è¼”åŠ©å‡½æ•¸...
export async function politeRewrite(draft: string, opts?: { audience?: "owner" | "agent"; intent?: "view" | "detail" | "pet" | "price" }) {
  const who = opts?.audience === "owner" ? "å±‹ä¸»" : "ä»²ä»‹";
  const why = (() => {
    switch (opts?.intent) {
      case "view": return "é ç´„çœ‹æˆ¿";
      case "detail": return "è©¢å•ç‰©ä»¶ç´°ç¯€";
      case "pet": return "ç¢ºèªæ˜¯å¦å¯é¤Šå¯µç‰©";
      case "price": return "è©¢å•åƒ¹æ ¼èˆ‡è­°åƒ¹ç©ºé–“";
      default: return "ä¸€èˆ¬è©¢å•";
    }
  })();
  const prompt = `è«‹å°‡ä»¥ä¸‹è¨Šæ¯æ”¹å¯«æˆã€Œç¦®è²Œã€ç°¡çŸ­ã€å°Šé‡ã€çš„å…©å€‹ç‰ˆæœ¬ï¼ˆV1/V2ï¼‰ï¼Œæƒ…å¢ƒï¼šè¦ç™¼çµ¦ã€Œ${who}ã€ï¼Œç›®çš„ï¼šã€Œ${why}ã€ã€‚ç¶­æŒåŸæ„ï¼Œé¿å…å‘½ä»¤èªï¼š\n---\n${draft}\n---\næ ¼å¼ï¼š\nV1ï¼š...\nV2ï¼š...`;
  return postLLM([{ role: "user", content: prompt }], { max_tokens: 220 });
}
```

### 4.3 SmartAsk.tsxï¼ˆå°è©±ä¸»ä»‹é¢ï¼‰

```tsx
import { useState, useRef, useEffect } from 'react';
import { Send, Sparkles, MessageCircle } from 'lucide-react';
import { postLLM } from '../../../services/ai';
import MascotMaiMai from '../../../components/MascotMaiMai';
import ChatMessage from '../components/ChatMessage';
import { QUICK_TAGS_LIFESTYLE, QUICK_TAGS_EXPLORE } from '../../../constants/maimai-persona';

type ChatMsg = { role: 'user' | 'assistant'; content: string; timestamp: string };

export default function SmartAsk() {
    const [messages, setMessages] = useState<ChatMsg[]>([]);
    const [input, setInput] = useState('');
    const [loading, setLoading] = useState(false);
    const chatRef = useRef<HTMLDivElement>(null);

    // æ ¹æ“šå°è©±è¼ªæ•¸æ±ºå®šé¡¯ç¤ºå“ªçµ„ Quick Tags
    const userRounds = messages.filter(m => m.role === 'user').length;
    const currentTags = userRounds >= 3 ? QUICK_TAGS_EXPLORE : QUICK_TAGS_LIFESTYLE;

    useEffect(() => {
        if (chatRef.current) {
            chatRef.current.scrollTop = chatRef.current.scrollHeight;
        }
    }, [messages]);

    const send = async (text = input) => {
        if (!text.trim() || loading) return;

        const userMsg: ChatMsg = { role: 'user', content: text.trim(), timestamp: new Date().toISOString() };
        setMessages(prev => [...prev, userMsg]);
        setInput('');
        setLoading(true);

        const assistantMsg: ChatMsg = { role: 'assistant', content: '', timestamp: new Date().toISOString() };
        setMessages(prev => [...prev, assistantMsg]);

        try {
            await postLLM(
                [...messages, userMsg],
                (chunk) => {
                    setMessages(prev => {
                        const newMsgs = [...prev];
                        const last = newMsgs[newMsgs.length - 1];
                        if (last && last.role === 'assistant') {
                            last.content += chunk;
                        }
                        return newMsgs;
                    });
                }
            );
        } catch (e) {
            console.error(e);
            setMessages(prev => {
                const newMsgs = [...prev];
                const last = newMsgs[newMsgs.length - 1];
                if (last) {
                    last.content = "æŠ±æ­‰ï¼Œæˆ‘é€™é‚Šå¥½åƒæœ‰é»å•é¡Œï¼Œç­‰ä¸€ä¸‹å†è©¦è©¦ï¼Ÿ";
                }
                return newMsgs;
            });
        } finally {
            setLoading(false);
        }
    };

    return (
        <section className="group relative bg-gradient-to-br from-white via-[#F8FAFC] to-[#00385a08] rounded-[24px] border border-brand-100 shadow-[0_8px_24px_rgba(0,56,90,0.06)] overflow-hidden hover:shadow-[0_12px_32px_rgba(0,56,90,0.1)] transition-all duration-300 isolate">
            {/* Background Elements */}
            <div className="absolute -top-24 -right-24 w-80 h-80 bg-brand-100/30 rounded-full blur-3xl pointer-events-none mix-blend-multiply"></div>
            <div className="absolute -bottom-24 -left-24 w-96 h-96 bg-brand-700/5 rounded-full blur-3xl pointer-events-none mix-blend-multiply"></div>
            
            {/* Decorative Top Bar */}
            <div className="h-1.5 w-full bg-gradient-to-r from-brand-700 via-brand-600 to-brand-500 relative z-20"></div>

            <div className="p-5 md:p-8 md:pt-6 relative z-10">
                {/* Header Section */}
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-3">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 rounded-2xl bg-white/80 border border-brand-100 flex items-center justify-center text-brand-700 relative overflow-hidden shrink-0 shadow-sm backdrop-blur-sm group-hover:scale-105 transition-transform duration-300">
                            <MessageCircle size={26} strokeWidth={2} />
                        </div>
                        <div>
                            <h3 className="font-black text-brand-700 text-xl tracking-tight flex items-center gap-2">
                                ç¤¾å€é„°å±…ç®¡å®¶
                                <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gradient-to-r from-brand-700 to-brand-600 text-white text-[10px] font-bold tracking-wider uppercase shadow-sm">
                                    <Sparkles size={10} /> Beta
                                </span>
                            </h3>
                            <p className="text-xs text-ink-600 font-bold mt-0.5 tracking-wide">
                                èŠç”Ÿæ´»ã€èŠç¤¾å€ã€ä»€éº¼éƒ½å¯ä»¥èŠ â˜•
                            </p>
                        </div>
                    </div>

                    {/* Quick Tags - å‹•æ…‹åˆ‡æ› */}
                    <div className="flex flex-wrap items-center justify-end gap-2">
                        {currentTags.map(tag => (
                            <button
                                key={tag}
                                onClick={() => send(tag)}
                                className="px-3.5 py-1.5 rounded-full bg-white border border-brand-100 text-brand-700 text-xs font-bold hover:bg-brand-700 hover:text-white hover:border-brand-700 transition-all active:scale-95 shadow-sm hover:shadow-md backdrop-blur-sm"
                            >
                                {tag}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Chat Display Area */}
                <div
                    ref={chatRef}
                    className="h-[380px] overflow-y-auto rounded-2xl bg-white/50 border border-brand-100/60 p-5 shadow-inner mb-4 flex flex-col gap-4 scroll-smooth backdrop-blur-md"
                    role="log"
                    aria-live="polite"
                >
                    {messages.length === 0 ? (
                        <div className="flex flex-1 flex-col items-center justify-center text-center p-4 opacity-80">
                            <MascotMaiMai />
                            <p className="mb-2 font-black text-brand-700 text-base">
                                å—¨ï½æˆ‘æ˜¯é‚é‚ ğŸ‘‹
                            </p>
                            <p className="text-sm leading-relaxed text-ink-600 max-w-xs mx-auto font-medium">
                                ä»Šå¤©éå¾—æ€æ¨£ï¼Ÿ<br />
                                æƒ³èŠä»€éº¼éƒ½å¯ä»¥ï¼Œæˆ‘åœ¨é€™é™ªä½ ï½
                            </p>
                            
                            {/* é–‹å ´é¸é …æç¤º */}
                            <div className="mt-4 flex flex-wrap justify-center gap-2">
                                {QUICK_TAGS_LIFESTYLE.map(tag => (
                                    <button
                                        key={tag}
                                        onClick={() => send(tag)}
                                        className="px-3 py-1.5 rounded-full bg-brand-50 border border-brand-100 text-brand-600 text-xs font-bold hover:bg-brand-100 transition-all"
                                    >
                                        {tag}
                                    </button>
                                ))}
                            </div>
                        </div>
                    ) : (
                        messages.map((m, i) => (
                            <ChatMessage key={i} role={m.role} content={m.content} timestamp={m.timestamp} />
                        ))
                    )}
                    {loading && (
                        <div className="flex justify-start animate-fadeIn">
                            <div className="rounded-2xl rounded-bl-sm px-4 py-3 bg-white border border-brand-100 text-brand-600 text-sm flex items-center gap-2 shadow-sm">
                                <span className="font-bold">é‚é‚æ­£åœ¨æƒ³...</span>
                                <div className="flex gap-1">
                                    <span className="w-1.5 h-1.5 bg-brand-500 rounded-full animate-[bounce_1.4s_infinite_ease-in-out_both]"></span>
                                    <span className="w-1.5 h-1.5 bg-brand-500 rounded-full animate-[bounce_1.4s_infinite_ease-in-out_both_0.2s]"></span>
                                    <span className="w-1.5 h-1.5 bg-brand-500 rounded-full animate-[bounce_1.4s_infinite_ease-in-out_both_0.4s]"></span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                {/* Input Area */}
                <div className="relative group/input">
                    <input
                        type="text"
                        className="w-full pl-5 pr-14 py-4 rounded-xl border-2 border-brand-100 bg-white/80 text-ink-900 font-bold text-[15px] placeholder:text-ink-400/80 transition-all focus:outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-50/50 hover:border-brand-300 shadow-sm backdrop-blur-sm"
                        placeholder="èªªèªªä½ ä»Šå¤©éå¾—å¦‚ä½•ï¼Œæˆ–ä»»ä½•æƒ³èŠçš„..."
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && send()}
                        disabled={loading}
                    />
                    <button
                        onClick={() => send()}
                        disabled={loading || !input.trim()}
                        className="absolute right-2 top-2 bottom-2 aspect-square rounded-lg bg-brand-700 text-white flex items-center justify-center shadow-md transition-all hover:bg-brand-600 hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 active:scale-95 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:transform-none disabled:shadow-none"
                    >
                        <Send size={20} strokeWidth={2.5} className="-ml-0.5 translate-y-[1px]" />
                    </button>
                </div>
            </div>
        </section>
    );
}
```

### 4.4 ChatMessage.tsxï¼ˆè¨Šæ¯æ¸²æŸ“ + ç¤¾å€ç‰†æ¨™è¨˜è§£æï¼‰

```tsx
import React from 'react';
import CommunityWallCard from './CommunityWallCard';

type ChatMessageProps = {
    role: 'user' | 'assistant';
    content: string;
    timestamp?: string;
};

/**
 * è§£æè¨Šæ¯ä¸­çš„ç¤¾å€ç‰†æ¨™è¨˜
 * æ ¼å¼ï¼š[[ç¤¾å€ç‰†:ç¤¾å€åç¨±:è¨è«–è©±é¡Œ]]
 */
function parseCommunityWallTags(content: string): { text: string; cards: { name: string; topic: string }[] } {
    const regex = /\[\[ç¤¾å€ç‰†:([^:]+):([^\]]+)\]\]/g;
    const cards: { name: string; topic: string }[] = [];
    let match;
    
    while ((match = regex.exec(content)) !== null) {
        const name = match[1];
        const topic = match[2];
        if (name && topic) {
            cards.push({
                name: name.trim(),
                topic: topic.trim()
            });
        }
    }
    
    // ç§»é™¤æ¨™è¨˜ï¼Œä¿ç•™ç´”æ–‡å­—
    const text = content.replace(regex, '').trim();
    
    return { text, cards };
}

export default function ChatMessage({ role, content, timestamp }: ChatMessageProps) {
    // åªæœ‰ assistant è¨Šæ¯æ‰è§£æç¤¾å€ç‰†æ¨™è¨˜
    const { text, cards } = role === 'assistant' 
        ? parseCommunityWallTags(content)
        : { text: content, cards: [] };

    return (
        <div className={`flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fadeIn`}>
            <div
                className={`max-w-[85%] rounded-2xl px-5 py-3.5 text-[15px] font-medium leading-relaxed shadow-sm ${role === 'user'
                        ? 'bg-brand-700 text-white rounded-br-sm'
                        : 'bg-white text-ink-900 border border-brand-100 rounded-bl-sm'
                    }`}
            >
                <div className="whitespace-pre-wrap">{text}</div>
                
                {/* ç¤¾å€ç‰†å¡ç‰‡ */}
                {cards.length > 0 && (
                    <div className="mt-2 space-y-2">
                        {cards.map((card, i) => (
                            <CommunityWallCard 
                                key={i}
                                name={card.name}
                                topic={card.topic}
                            />
                        ))}
                    </div>
                )}
                
                {timestamp && (
                    <div className={`mt-1.5 text-[11px] font-bold ${role === 'user' ? 'text-brand-300' : 'text-brand-600/60'} text-right`}>
                        {new Date(timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                )}
            </div>
        </div>
    );
}
```

### 4.5 CommunityWallCard.tsxï¼ˆç¤¾å€ç‰†å¡ç‰‡ï¼‰

```tsx
import { ExternalLink, Star, MessageSquare } from 'lucide-react';

/**
 * ============================================
 * ç¤¾å€ç‰†æ¨è–¦å¡ç‰‡ (CommunityWallCard)
 * ============================================
 * 
 * ã€åŠŸèƒ½èªªæ˜ã€‘
 * ç•¶ AI åµæ¸¬åˆ°ç”¨æˆ¶éœ€æ±‚å¾Œï¼Œæœƒåœ¨èŠå¤©ä¸­æ’å…¥é€™å€‹å¡ç‰‡ï¼Œ
 * å¼•å°ç”¨æˆ¶å»ç¤¾å€ç‰†ç ”ç©¶è©•åƒ¹ï¼Œè€Œä¸æ˜¯ç›´æ¥æ¨è–¦ç‰©ä»¶ã€‚
 * 
 * ã€ç›®å‰ç‹€æ…‹ã€‘
 * âš ï¸ MOCK æ¨¡å¼ - ç¤¾å€ç‰†åŠŸèƒ½å°šæœªå®Œå–„ï¼Œç›®å‰ä½¿ç”¨å‡è³‡æ–™
 * 
 * ã€TODO: æ¥å…¥çœŸå¯¦ç¤¾å€ç‰†ã€‘
 * 1. å»ºç«‹ç¤¾å€ç‰† APIï¼šGET /api/community-wall/:communityId
 * 2. ä¿®æ”¹ props å¾ name/topic æ”¹ç‚º communityId
 * 3. ç”¨ communityId æŸ¥è©¢çœŸå¯¦çš„ï¼š
 *    - ç¤¾å€åç¨±
 *    - è©•åƒ¹æ•¸é‡
 *    - å¹³å‡è©•åˆ†
 *    - ç†±é–€è¨è«–è©±é¡Œ
 * 4. ä¿®æ”¹é€£çµç‚ºå‹•æ…‹ï¼š/maihouses/community-wall.html?id={communityId}
 */

type CommunityWallCardProps = {
  name: string;
  topic?: string;
  reviewCount?: number;
  rating?: number;
};

// ============================================
// ğŸ­ MOCK è³‡æ–™ - ä¹‹å¾Œæ›¿æ›ç‚º API æŸ¥è©¢
// ============================================
const MOCK_COMMUNITY_DATA: Record<string, { reviewCount: number; rating: number }> = {
  'å¿«æ¨‚èŠ±åœ’': { reviewCount: 28, rating: 4.3 },
  'é é›„äºŒä»£å®…': { reviewCount: 45, rating: 4.1 },
  'ç¾æ²³å¸‚': { reviewCount: 67, rating: 3.9 },
  'æ™¯å®‰å’Œé™¢': { reviewCount: 19, rating: 4.5 },
  'æ¾æ¿¤è‹‘': { reviewCount: 32, rating: 4.2 },
  'è¯å›ºåé‚¸': { reviewCount: 24, rating: 4.4 },
  // é è¨­å€¼
  'default': { reviewCount: 12, rating: 4.2 }
};

function getMockData(name: string) {
  return MOCK_COMMUNITY_DATA[name] || MOCK_COMMUNITY_DATA['default'];
}
// ============================================

export default function CommunityWallCard({ 
  name, 
  topic = 'ä½æˆ¶çœŸå¯¦è©•åƒ¹',
  reviewCount,
  rating
}: CommunityWallCardProps) {
  // ä½¿ç”¨ mock è³‡æ–™ï¼ˆä¹‹å¾Œæ”¹ç‚º API æŸ¥è©¢ï¼‰
  const mockData = getMockData(name);
  const finalReviewCount = reviewCount ?? mockData?.reviewCount ?? 10;
  const finalRating = rating ?? mockData?.rating ?? 4.0;
  
  // TODO: æ”¹ç‚ºå‹•æ…‹é€£çµ /maihouses/community-wall.html?id={communityId}
  const communityWallUrl = '/maihouses/community-wall_mvp.html';
  
  return (
    <a 
      href={communityWallUrl}
      target="_blank"
      rel="noopener noreferrer"
      className="block mt-3 p-4 rounded-xl bg-gradient-to-br from-brand-50 to-white border-2 border-brand-100 hover:border-brand-300 hover:shadow-md transition-all group"
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 rounded-lg bg-brand-100 flex items-center justify-center">
            <MessageSquare size={16} className="text-brand-700" />
          </div>
          <div>
            <p className="font-black text-brand-700 text-sm">{name}</p>
            <p className="text-[11px] text-ink-500 font-medium">ç¤¾å€ç‰†</p>
          </div>
        </div>
        <ExternalLink size={16} className="text-brand-400 group-hover:text-brand-600 transition-colors" />
      </div>
      
      {/* Topic */}
      <p className="text-xs text-ink-600 font-medium mb-3 line-clamp-2">
        ğŸ’¬ {topic}
      </p>
      
      {/* Stats */}
      <div className="flex items-center gap-4 text-[11px] text-ink-500">
        <span className="flex items-center gap-1">
          <Star size={12} className="text-amber-500 fill-amber-500" />
          <span className="font-bold text-ink-700">{finalRating}</span>
        </span>
        <span>{finalReviewCount} å‰‡è©•åƒ¹</span>
      </div>
      
      {/* CTA */}
      <div className="mt-3 py-2 px-3 rounded-lg bg-brand-700 text-white text-center text-xs font-bold group-hover:bg-brand-600 transition-colors">
        å»çœ‹çœ‹ä½æˆ¶æ€éº¼èªª â†’
      </div>
    </a>
  );
}
```

---

## 5. å¾Œç«¯ç¨‹å¼ç¢¼

### 5.1 openai-proxy.jsï¼ˆOpenAI ä»£ç† APIï¼‰

```javascript
// api/openai-proxy.js
// Vercel Serverless Function - ä»£ç† OpenAI API è«‹æ±‚

export default async function handler(req, res) {
  // CORS è™•ç†
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { messages, temperature = 0.7, max_tokens = 300, stream = false } = req.body;

  if (!messages || !Array.isArray(messages)) {
    return res.status(400).json({ error: 'Invalid messages format' });
  }

  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages,
        temperature,
        max_tokens,
        stream
      })
    });

    if (!response.ok) {
      const error = await response.text();
      console.error('OpenAI API Error:', error);
      return res.status(response.status).json({ error: 'OpenAI API error' });
    }

    // ä¸²æµæ¨¡å¼
    if (stream) {
      res.setHeader('Content-Type', 'text/event-stream');
      res.setHeader('Cache-Control', 'no-cache');
      res.setHeader('Connection', 'keep-alive');

      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        res.write(chunk);
      }
      
      return res.end();
    }

    // éä¸²æµæ¨¡å¼
    const data = await response.json();
    return res.status(200).json(data);

  } catch (error) {
    console.error('Proxy Error:', error);
    return res.status(500).json({ error: 'Internal server error' });
  }
}
```

### 5.2 æœªä¾†ï¼šcommunity-wall APIï¼ˆTODOï¼‰

```typescript
// api/community-wall/[id].ts
// æœªä¾†æ¥å…¥çœŸå¯¦ç¤¾å€ç‰†æ™‚ä½¿ç”¨

import { VercelRequest, VercelResponse } from '@vercel/node';
import { createClient } from '@supabase/supabase-js';

export default async function handler(req: VercelRequest, res: VercelResponse) {
  const { id } = req.query;
  
  const supabase = createClient(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );
  
  const { data, error } = await supabase
    .from('communities')
    .select(`
      id,
      name,
      score,
      review_count,
      story_vibe,
      two_good,
      one_fair
    `)
    .eq('id', id)
    .single();
  
  if (error) {
    return res.status(404).json({ error: 'æ‰¾ä¸åˆ°æ­¤ç¤¾å€' });
  }
  
  return res.status(200).json({ success: true, data });
}
```

---

## 6. éƒ¨ç½²èˆ‡æ¸¬è©¦

### 6.1 éƒ¨ç½²æµç¨‹

```bash
# 1. ç¢ºèªæ‰€æœ‰æª”æ¡ˆå·²å„²å­˜

# 2. TypeScript é¡å‹æª¢æŸ¥
npm run build

# 3. æœ¬åœ°æ¸¬è©¦
npm run dev

# 4. æäº¤åˆ° Git
git add -A
git commit -m "feat: ç¤¾å€é„°å±…ç®¡å®¶åŠŸèƒ½"
git push

# 5. Vercel è‡ªå‹•éƒ¨ç½²
# æ¨é€åˆ° main åˆ†æ”¯å¾Œï¼ŒVercel æœƒè‡ªå‹•éƒ¨ç½²
```

### 6.2 æ¸¬è©¦æ¡ˆä¾‹

| æ¸¬è©¦å ´æ™¯ | ç”¨æˆ¶è¼¸å…¥ | é æœŸ AI å›æ‡‰ |
|----------|----------|--------------|
| ç ´å†°æœŸ | ã€Œä»Šå¤©éå¾—å¦‚ä½•ã€ | é–’èŠï¼Œä¸ææˆ¿å­ |
| æ¢å‹˜æœŸ | ã€Œé€šå‹¤å¥½ç´¯ã€ | åŒç†ï¼Œåµæ¸¬ commute é—œéµå­— |
| æ©‹æ¥æœŸ | ã€Œæ¯å¤©èŠ±å…©å°æ™‚ã€ | å¸¶å…¥ç¤¾å€ç‰†ï¼Œé™„ä¸Šå¡ç‰‡ |
| ç¤¾å€ç‰†å¡ç‰‡ | AI è¼¸å‡ºæ¨™è¨˜ | é¡¯ç¤ºå¯é»æ“Šå¡ç‰‡ |

### 6.3 ç·šä¸Šæ¸¬è©¦

- ç¶²å€ï¼šhttps://maihouses.vercel.app/maihouses/
- æ¸¬è©¦æ­¥é©Ÿï¼š
  1. é»æ“Šã€Œç¤¾å€é„°å±…ç®¡å®¶ã€å€å¡Š
  2. é¸æ“‡ã€Œä»Šå¤©éå¾—å¦‚ä½•ã€é–‹å§‹å°è©±
  3. è§€å¯Ÿ AI æ˜¯å¦éµå¾ªå°è©±æ¼æ–—ç­–ç•¥
  4. æ¸¬è©¦è§¸ç™¼ç¤¾å€ç‰†å¡ç‰‡

---

## 7. æœªä¾†æ“´å±• TODO

### 7.1 çŸ­æœŸï¼ˆ1-2 é€±ï¼‰

- [ ] æ¥å…¥çœŸå¯¦ç¤¾å€ç‰† API
- [ ] ç¤¾å€ç‰†å¡ç‰‡å‹•æ…‹è¼‰å…¥è³‡æ–™
- [ ] å¢åŠ æ›´å¤š LIFESTYLE_TRIGGERS
- [ ] åŠ å…¥å°è©±æ­·å²æŒä¹…åŒ–

### 7.2 ä¸­æœŸï¼ˆ1-2 æœˆï¼‰

- [ ] ç”¨æˆ¶åå¥½å­¸ç¿’ï¼ˆæ¨™ç±¤ç³»çµ±ï¼‰
- [ ] å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡æœ€ä½³åŒ–
- [ ] A/B æ¸¬è©¦ä¸åŒè©±è¡“æ•ˆæœ
- [ ] è½‰æ›ç‡è¿½è¹¤

### 7.3 é•·æœŸ

- [ ] èªéŸ³å°è©±æ”¯æ´
- [ ] åœ–ç‰‡è¾¨è­˜ï¼ˆçœ‹æˆ¿ç…§ç‰‡ï¼‰
- [ ] è‡ªå‹•ç”¢ç”Ÿçœ‹æˆ¿å ±å‘Š
- [ ] è·¨å¹³å°æ•´åˆï¼ˆLINEã€Messengerï¼‰

---

## ğŸ“ é™„éŒ„

### A. ç’°å¢ƒè®Šæ•¸

```bash
# .env
OPENAI_API_KEY=sk-xxxxx
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJxxxxx
```

### B. è³‡æ–™åº« Schemaï¼ˆç¤¾å€ç‰†ï¼‰

```sql
-- ç¤¾å€è³‡æ–™è¡¨
CREATE TABLE communities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  address TEXT,
  score DECIMAL(2,1) DEFAULT 4.0,
  review_count INTEGER DEFAULT 0,
  story_vibe TEXT,
  two_good TEXT[],
  one_fair TEXT[],
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç¤¾å€è©•è«–è¡¨
CREATE TABLE community_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  community_id UUID REFERENCES communities(id),
  user_id UUID REFERENCES auth.users(id),
  rating INTEGER CHECK (rating BETWEEN 1 AND 5),
  content TEXT,
  topic TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### C. ç›¸é—œæ–‡ä»¶

- [COMMUNITY_WALL_INTEGRATION.md](./COMMUNITY_WALL_INTEGRATION.md) - ç¤¾å€ç‰†æ•´åˆæ–‡ä»¶
- [äº”ä»½å°ˆå®¶æ„è¦‹åŸæ–‡](éœ€å¦å¤–æä¾›)

---

*æ–‡ä»¶ç‰ˆæœ¬ï¼šv1.0*  
*æœ€å¾Œæ›´æ–°ï¼š2024/11/30*
