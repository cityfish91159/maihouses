<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chat Demo（Workers 代理）</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC","PingFang TC",sans-serif;background:#f5f8ff;margin:0;padding:24px;color:#0a1f3f}
    .wrap{max-width:820px;margin:0 auto;background:#fff;border:1px solid #e6ecf5;border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    textarea{width:100%;min-height:90px;padding:10px;border-radius:10px;border:1px solid #dbe4f2;outline:none}
    button{margin-top:10px;padding:10px 14px;border-radius:10px;border:1px solid #cfe0ff;background:#1749d7;color:#fff;font-weight:700;cursor:pointer}
    pre{white-space:pre-wrap;background:#f6f9ff;border:1px solid #e3ecff;border-radius:12px;padding:12px;margin-top:12px;min-height:80px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input[type=url]{flex:1;min-width:320px;padding:8px;border-radius:8px;border:1px solid #dbe4f2}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Chat Demo（Cloudflare Workers 代理）</h2>
    <div class="row">
      <label for="endpoint">API</label>
      <input id="endpoint" type="url" placeholder="https://<your-worker>.workers.dev/api/chat"/>
      <button id="useDemo">填入示例</button>
    </div>
    <textarea id="q" placeholder="輸入訊息…"></textarea>
    <button id="send">送出</button>
    <pre id="ans"></pre>
  </div>
  <script>
    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const preset = params.get('api') || '';
    $('#endpoint').value = preset;
    $('#useDemo').onclick = () => {
      const u = prompt('輸入你的 Workers API，例如 https://mai-ai-proxy.yourname.workers.dev/api/chat');
      if (u) $('#endpoint').value = u.trim();
    };

    $('#send').onclick = async () => {
      const API = $('#endpoint').value.trim();
      if(!API){ alert('請先填 API URL'); return; }
      const ans = $('#ans');
      ans.textContent = '';
      const q = $('#q').value.trim();
      const resp = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: [{ role: 'user', content: q || 'Hello' }] })
      });
      if(!resp.body){ ans.textContent = '無串流回應'; return; }
      const reader = resp.body.getReader();
      const dec = new TextDecoder();
      while(true){
        const { done, value } = await reader.read();
        if(done) break;
        const chunk = dec.decode(value);
        chunk.trim().split('\n').forEach(line => {
          if(!line.startsWith('data:')) return;
          const json = line.slice(5).trim();
          if(json==='[DONE]') return;
          try{
            const obj = JSON.parse(json);
            const piece = obj.choices?.[0]?.delta?.content || '';
            if(piece) ans.textContent += piece;
          }catch(e){ /* ignore */ }
        });
      }
    };
  </script>
</body>
</html>
