<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ğŸ‚ è›‹ç³•é  v13.1 - å…¨APIæ•´åˆ</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #0b1220;
  --panel: #0f1b2e;
  --text: #e9f0ff;
  --brand: #2be38a;
  --border: #1b2a45;
  --btn: #20314f;
  --warning: #ff9500;
}

html, body {
  width: 100%;
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  overflow: hidden;
  position: fixed;
}

.container {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  padding: 12px;
  gap: 12px;
}

header {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

h1 {
  font-size: 20px;
  font-weight: 600;
}

.badge {
  padding: 4px 8px;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: #0d1a30;
  color: #cde1ff;
  font-size: 11px;
}

.main {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  flex: 1;
  min-height: 0;
}

@media (min-width: 900px) {
  .main {
    grid-template-columns: 360px 1fr;
  }
}

.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.btn {
  background: var(--btn);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 8px;
  padding: 12px 16px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  min-height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.2s;
  touch-action: manipulation;
}

.btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.btn:active:not(:disabled) {
  transform: translateY(0);
  opacity: 0.9;
}

.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.btn.primary {
  background: var(--brand);
  border-color: #0b3c25;
  color: #072412;
}

.btn-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}

.preview {
  position: relative;
  background: #0a0f1a;
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 400px;
}

#canvas {
  max-width: 100%;
  max-height: 100%;
  display: block;
  object-fit: contain;
}

.control-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.control-group label {
  font-size: 13px;
  color: #b7c7e6;
  font-weight: 500;
}

.control-group input[type="range"] {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  background: var(--border);
  border-radius: 3px;
  outline: none;
}

.control-group input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--brand);
  cursor: pointer;
}

.control-group select {
  background: var(--btn);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px;
  font-size: 14px;
}

#info {
  font-size: 13px;
  color: #7a92c0;
  padding: 10px;
  background: rgba(27, 42, 69, 0.3);
  border-radius: 8px;
  min-height: 40px;
  display: flex;
  align-items: center;
}

.loading {
  position: fixed;
  inset: 0;
  background: rgba(8, 12, 20, 0.95);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading.show {
  display: flex;
}

.loading-content {
  text-align: center;
  padding: 24px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  min-width: 280px;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
  margin: 16px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--brand), #20a96f);
  width: 0%;
  transition: width 0.3s;
}

hr {
  border: none;
  border-top: 1px solid var(--border);
  margin: 8px 0;
}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>ğŸ‚ è›‹ç³•é </h1>
    <span class="badge">v13.1 å…¨API</span>
    <span class="badge">iOSå„ªåŒ–</span>
  </header>

  <div class="main">
    <div class="panel">
      <label class="btn primary" style="cursor: pointer;">
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        ğŸ“‚ ä¸Šå‚³åœ–ç‰‡
      </label>

      <div class="btn-grid">
        <button class="btn" id="btnGenerate">ğŸ¨ AIç”Ÿåœ–</button>
        <button class="btn" id="btnDetect">ğŸ” AIåµæ¸¬</button>
        <button class="btn" id="btnAnalyze">ğŸ§  AIåˆ†æ</button>
        <button class="btn" id="btnVisualize">ğŸ“Š è¦–è¦ºåŒ–</button>
      </div>

      <hr>

      <div class="control-group">
        <label>é€è¦–æ¨¡å¼</label>
        <select id="xrayMode">
          <option value="neutral">ğŸ¯ æ¨™æº–é€è¦–</option>
          <option value="clahe">ğŸ”¬ CLAHEå°æ¯”</option>
          <option value="adaptive">ğŸ§  è‡ªé©æ‡‰</option>
          <option value="gain-fast">âš¡ å¿«é€Ÿå¢ç›Š</option>
          <option value="gradient">ğŸŒˆ æ¢¯åº¦ç†±åœ–</option>
        </select>
      </div>

      <div class="control-group">
        <label>é€è¦–å¼·åº¦: <span id="xrayK_v">4.5</span></label>
        <input type="range" id="xrayK" min="0" max="12" step="0.1" value="4.5">
      </div>

      <div class="control-group">
        <label>éŠ³åŒ–: <span id="usmK_v">1.0</span></label>
        <input type="range" id="usmK" min="0" max="3" step="0.1" value="1.0">
      </div>

      <div class="control-group">
        <label>é‚Šç·£: <span id="edge_v">0.4</span></label>
        <input type="range" id="edge" min="0" max="1" step="0.05" value="0.4">
      </div>

      <button class="btn" id="btnApply">âœ¨ å¥—ç”¨è™•ç†</button>

      <hr>

      <div class="btn-grid">
        <button class="btn" id="btnDL">ï¿½ï¿½ ä¸‹è¼‰</button>
        <button class="btn" id="btnReset">âš™ï¸ é‡ç½®</button>
      </div>

      <div id="info">â³ è«‹ä¸Šå‚³åœ–ç‰‡é–‹å§‹</div>
    </div>

    <div class="panel">
      <div class="preview">
        <canvas id="canvas"></canvas>
      </div>
      <div style="font-size: 12px; color: #6a7fa0; text-align: center; margin-top: 8px;">
        ğŸ’¡ è™•ç†å¾Œçš„åœ–ç‰‡æœƒç›´æ¥é¡¯ç¤ºåœ¨ä¸Šæ–¹
      </div>
    </div>
  </div>
</div>

<div class="loading" id="loading">
  <div class="loading-content">
    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">â³ è™•ç†ä¸­...</div>
    <div id="loadingText" style="font-size: 13px; color: #8aa2d2; margin-bottom: 12px;"></div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <button class="btn" id="btnCancel">â¹ï¸ å–æ¶ˆ</button>
  </div>
</div>

<script>
'use strict';

const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const MAX_CANVAS_SIDE = isIOS ? 4096 : 32767;
const MAX_PIXELS = isIOS ? 16777216 : 268435456;

const $ = id => document.getElementById(id);

const state = {
  loaded: false,
  processing: false,
  bitmap: null,
  originalBitmap: null,
  w: 0,
  h: 0,
  currentUrl: null,
  detections: null,
  cancelController: null
};

function setInfo(text) {
  $('info').textContent = text;
}

function showLoading(show, text = '') {
  const loading = $('loading');
  loading.classList.toggle('show', show);
  state.processing = show;
  
  if (show && text) {
    $('loadingText').textContent = text;
    $('progressFill').style.width = '0%';
  }
  
  document.querySelectorAll('.btn:not(#btnCancel)').forEach(btn => {
    btn.disabled = show;
  });
}

function setProgress(pct, text) {
  $('progressFill').style.width = pct + '%';
  if (text) $('loadingText').textContent = text;
}

async function apiCall(url, body, timeout = 60000) {
  state.cancelController = new AbortController();
  const timeoutId = setTimeout(() => state.cancelController.abort(), timeout);
  
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      signal: state.cancelController.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      throw new Error(`APIéŒ¯èª¤ (${response.status})`);
    }
    
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') {
      throw new Error('è«‹æ±‚å·²å–æ¶ˆ');
    }
    throw error;
  }
}

function drawToCanvas(bitmap) {
  const canvas = $('canvas');
  let w = bitmap.width;
  let h = bitmap.height;
  
  if (w * h > MAX_PIXELS) {
    const scale = Math.sqrt(MAX_PIXELS / (w * h));
    w = Math.floor(w * scale);
    h = Math.floor(h * scale);
  }
  
  w = Math.min(w, MAX_CANVAS_SIDE);
  h = Math.min(h, MAX_CANVAS_SIDE);
  
  canvas.width = w;
  canvas.height = h;
  
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, w, h);
  ctx.drawImage(bitmap, 0, 0, w, h);
  
  state.w = w;
  state.h = h;
  state.bitmap = bitmap;
  state.currentUrl = canvas.toDataURL('image/jpeg', 0.85);
}

$('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  showLoading(true, 'è¼‰å…¥åœ–ç‰‡ä¸­...');
  
  try {
    setProgress(30, 'è§£æåœ–ç‰‡...');
    
    const bitmap = await createImageBitmap(file, { imageOrientation: 'from-image' });
    
    setProgress(70, 'ç¹ªè£½Canvas...');
    
    drawToCanvas(bitmap);
    
    state.originalBitmap = bitmap;
    state.loaded = true;
    
    setProgress(100, 'å®Œæˆ');
    setInfo(`âœ… å·²è¼‰å…¥ ${state.w}Ã—${state.h} px`);
    
    $('fileInput').value = '';
    
    showLoading(false);
    
  } catch (error) {
    console.error('è¼‰å…¥å¤±æ•—:', error);
    setInfo('âŒ è¼‰å…¥å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

$('btnGenerate').addEventListener('click', async () => {
  if (state.processing) return;
  
  const prompt = window.prompt('è«‹è¼¸å…¥åœ–ç‰‡æè¿°:', 'a delicious chocolate cake');
  if (!prompt) return;
  
  showLoading(true, 'AI ç”Ÿåœ–ä¸­...');
  
  try {
    setProgress(20, 'å‘¼å« Replicate API...');
    
    const result = await apiCall('/api/replicate-generate', {
      prompt: prompt,
      model: 'sdxl',
      num_outputs: 1
    }, 120000);
    
    if (!result.output || !result.output[0]) {
      throw new Error('ç”Ÿåœ–å¤±æ•—');
    }
    
    setProgress(70, 'è¼‰å…¥åœ–ç‰‡...');
    
    const img = new Image();
    img.crossOrigin = 'anonymous';
    
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = result.output[0];
    });
    
    const bitmap = await createImageBitmap(img);
    drawToCanvas(bitmap);
    
    state.originalBitmap = bitmap;
    state.loaded = true;
    
    setProgress(100, 'å®Œæˆ');
    setInfo(`âœ… AI ç”Ÿæˆå®Œæˆ ${state.w}Ã—${state.h} px`);
    
    showLoading(false);
    
  } catch (error) {
    console.error('ç”Ÿåœ–å¤±æ•—:', error);
    setInfo('âŒ ç”Ÿåœ–å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

$('btnDetect').addEventListener('click', async () => {
  if (!state.loaded || state.processing) return;
  
  showLoading(true, 'AI åµæ¸¬ä¸­...');
  
  try {
    setProgress(30, 'å‘¼å« Detect API...');
    
    const result = await apiCall('/api/replicate-detect', {
      image: state.currentUrl,
      labels: ['cake', 'frosting', 'decoration'],
      mode: 'cake'
    });
    
    // è§£æ Replicate è¼¸å‡ºæ ¼å¼
    let detectedBoxes = [];
    if (result.output) {
      // Replicate GroundingDINO è¼¸å‡ºæ ¼å¼: { "boxes": [[x1,y1,x2,y2], ...], "labels": [...], "scores": [...] }
      if (result.output.boxes && result.output.labels && result.output.scores) {
        detectedBoxes = result.output.boxes.map((box, i) => [
          box[0], box[1], box[2], box[3],
          result.output.labels[i],
          result.output.scores[i]
        ]);
      }
    }
    
    state.detections = { detected_boxes: detectedBoxes };
    
    setProgress(100, 'å®Œæˆ');
    
    const count = detectedBoxes.length;
    setInfo(`âœ… åµæ¸¬åˆ° ${count} å€‹ç‰©ä»¶`);
    
    showLoading(false);
    
  } catch (error) {
    console.error('åµæ¸¬å¤±æ•—:', error);
    setInfo('âŒ åµæ¸¬å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

$('btnAnalyze').addEventListener('click', async () => {
  if (!state.loaded || state.processing) return;
  
  showLoading(true, 'AI åˆ†æä¸­...');
  
  try {
    setProgress(30, 'å‘¼å« OpenAI API...');
    
    const result = await apiCall('/api/openai-proxy', {
      messages: [{
        role: 'user',
        content: [
          { type: 'text', text: 'è«‹åˆ†æé€™å¼µè›‹ç³•åœ–ç‰‡çš„ç‰¹å¾µå’Œè©•åƒ¹ã€‚' },
          { type: 'image_url', image_url: { url: state.currentUrl } }
        ]
      }],
      model: 'gpt-4o-mini',
      stream: false
    });
    
    if (!result.choices || !result.choices[0]) {
      throw new Error('åˆ†æå¤±æ•—');
    }
    
    const analysis = result.choices[0].message.content;
    
    setProgress(100, 'å®Œæˆ');
    
    alert('ï¿½ï¿½ AI åˆ†æçµæœ:\n\n' + analysis);
    
    setInfo('âœ… AI åˆ†æå®Œæˆ');
    
    showLoading(false);
    
  } catch (error) {
    console.error('åˆ†æå¤±æ•—:', error);
    setInfo('âŒ åˆ†æå¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

$('btnVisualize').addEventListener('click', async () => {
  if (!state.detections || state.processing) {
    alert('è«‹å…ˆåŸ·è¡Œ AI åµæ¸¬');
    return;
  }
  
  showLoading(true, 'ç”¢ç”Ÿè¦–è¦ºåŒ–...');
  
  try {
    setProgress(50, 'å‘¼å« Visualize API...');
    
    const boxes = (state.detections.detected_boxes || []).map(box => ({
      x: box[0], y: box[1],
      w: box[2] - box[0], h: box[3] - box[1],
      label: box[4] || 'object', score: box[5] || 0
    }));
    
    const response = await fetch('/api/visualize-detections', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: state.currentUrl, boxes: boxes, mode: 'cake' })
    });
    
    if (!response.ok) throw new Error('è¦–è¦ºåŒ–å¤±æ•—');
    
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'visualization.svg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    setTimeout(() => URL.revokeObjectURL(url), 100);
    
    setInfo('âœ… è¦–è¦ºåŒ–å·²ä¸‹è¼‰');
    
    showLoading(false);
    
  } catch (error) {
    console.error('è¦–è¦ºåŒ–å¤±æ•—:', error);
    setInfo('âŒ è¦–è¦ºåŒ–å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

$('btnApply').addEventListener('click', () => {
  if (!state.loaded || state.processing) return;
  
  showLoading(true, 'è™•ç†ä¸­...');
  
  try {
    const k = parseFloat($('xrayK').value);
    const usm = parseFloat($('usmK').value);
    const edge = parseFloat($('edge').value);
    
    setProgress(40, 'å¥—ç”¨æ•ˆæœ...');
    
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, state.w, state.h);
    const data = imageData.data;
    
    for (let i = 0; i < data.length; i += 4) {
      const avg = (data[i] + data[i+1] + data[i+2]) / 3;
      const diff = avg - 128;
      
      data[i] = Math.max(0, Math.min(255, data[i] + diff * k * 0.5 + edge * 30));
      data[i+1] = Math.max(0, Math.min(255, data[i+1] + diff * k * 0.5 + edge * 30));
      data[i+2] = Math.max(0, Math.min(255, data[i+2] + diff * k * 0.5 + edge * 30));
      
      if (usm > 0) {
        data[i] *= (1 + usm * 0.1);
        data[i+1] *= (1 + usm * 0.1);
        data[i+2] *= (1 + usm * 0.1);
      }
    }
    
    setProgress(80, 'æ¸²æŸ“çµæœ...');
    
    ctx.putImageData(imageData, 0, 0);
    state.currentUrl = canvas.toDataURL('image/jpeg', 0.85);
    
    setProgress(100, 'å®Œæˆ');
    setInfo('âœ… è™•ç†å®Œæˆ');
    
    showLoading(false);
    
  } catch (error) {
    console.error('è™•ç†å¤±æ•—:', error);
    setInfo('âŒ è™•ç†å¤±æ•—: ' + error.message);
    showLoading(false);
  }
});

$('btnDL').addEventListener('click', () => {
  if (!state.loaded) return;
  
  $('canvas').toBlob(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cake-result.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
  }, 'image/png', 0.95);
  
  setInfo('âœ… å·²ä¸‹è¼‰');
});

$('btnReset').addEventListener('click', () => {
  if (!state.originalBitmap) return;
  
  drawToCanvas(state.originalBitmap);
  setInfo('âš™ï¸ å·²é‡ç½®');
});

$('btnCancel').addEventListener('click', () => {
  if (state.cancelController) {
    state.cancelController.abort();
  }
  showLoading(false);
  setInfo('ğŸ›‘ å·²å–æ¶ˆ');
});

['xrayK', 'usmK', 'edge'].forEach(id => {
  $(id).addEventListener('input', (e) => {
    $(id + '_v').textContent = e.target.value;
  });
});

console.log('âœ… è›‹ç³•é  v13.1 åˆå§‹åŒ–å®Œæˆ');
console.log('iOS å„ªåŒ–: 4096pxé™åˆ¶, createImageBitmap, requestAnimationFrame');
console.log('å…¨ API æ”¯æ´: Replicate Generate/Detect, OpenAI Proxy, Visualize');
</script>
</body>
</html>
