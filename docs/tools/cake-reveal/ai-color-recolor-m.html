<!DOCTYPE html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' blob: data: https:; img-src * blob: data:; connect-src *; worker-src blob:; style-src 'self' 'unsafe-inline';">
  <title>ğŸ‚ Cake Reveal M - AI é¡è‰²å›å¡«çµ‚æ¥µç‰ˆ</title>
  <link rel="manifest" href="manifest.json">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    :root{
      --bg:#0b1220;--panel:#0f1b2e;--text:#e9f0ff;--brand:#2be38a;
      --border:#1b2a45;--btn:#20314f;--warning:#ff9500;--success:#2be38a;
      --light-bg:#f0f4f8;--light-panel:#ffffff;--light-text:#1a1a1a;--light-border:#d1d5db;
      --light-btn:#f3f4f6;--light-brand:#2be38a;
    }
    html,body{width:100%;height:100%;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      overflow:hidden;position:fixed;-webkit-user-select:none;-webkit-font-smoothing:antialiased;}
    [data-theme="light"] {
      --bg:var(--light-bg); --panel:var(--light-panel); --text:var(--light-text);
      --border:var(--light-border); --btn:var(--light-btn); --brand:var(--light-brand);
    }
    .wrap{position:fixed;inset:0;display:flex;flex-direction:column;
      padding:max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-left)) 
              max(12px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-right));}
    
    header{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
    h1{font-size:18px;font-weight:700;}
    .badge{background:var(--brand);color:#000;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;}
    
    .btn{background:var(--btn);color:var(--text);border:1px solid var(--border);padding:10px 16px;
      border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s;
      touch-action:manipulation;display:flex;align-items:center;justify-content:center;gap:4px;}
    .btn:hover{background:var(--brand);color:#000;border-color:var(--brand);}
    .btn.primary{background:var(--brand);color:#000;border-color:var(--brand);}
    .btn.warning{background:var(--warning);color:#000;border-color:var(--warning);}
    .btn:disabled{opacity:0.4;cursor:not-allowed;}
    
    .grid{display:grid;grid-template-columns:minmax(280px,360px) 1fr;gap:12px;flex:1;overflow:hidden;}
    @media (max-width:768px){.grid{grid-template-columns:1fr;}}
    
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;
      overflow-y:auto;display:flex;flex-direction:column;gap:8px;}
    
    .hflex{display:flex;gap:8px;}
    .row{display:flex;flex-direction:column;gap:4px;}
    .row label{font-size:12px;font-weight:500;color:#8aa2d2;}
    .row input[type="range"]{width:100%;}
    .row select{background:var(--btn);color:var(--text);border:1px solid var(--border);
      padding:8px;border-radius:6px;font-size:12px;}
    
    .toggle{display:flex;flex-wrap:wrap;gap:8px;}
    .toggle label{background:var(--btn);border:1px solid var(--border);padding:8px 12px;
      border-radius:6px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:4px;}
    .toggle label input{cursor:pointer;}
    .toggle label:has(input:checked){background:var(--brand);color:#000;border-color:var(--brand);}
    
    .autoHint{background:#ff9500;color:#000;padding:8px 12px;border-radius:8px;font-size:11px;
      font-weight:600;display:none;align-items:center;gap:8px;}
    .autoHint.show{display:flex;}
    
    #info{background:rgba(43,227,138,0.1);border:1px solid var(--brand);padding:8px 12px;
      border-radius:8px;font-size:12px;color:var(--brand);}
    
    hr{border:none;border-top:1px solid var(--border);margin:4px 0;}
    
    .compareWrap{position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:8px;
      overflow:hidden;touch-action:pan-y;}
    #src,#dst{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;}
    #afterWrap{position:absolute;top:0;left:0;width:50%;height:100%;overflow:hidden;}
    #divider{position:absolute;top:0;left:50%;width:4px;height:100%;background:var(--brand);
      cursor:ew-resize;transform:translateX(-2px);touch-action:pan-y;z-index:10;}
    #divider::before{content:'';position:absolute;top:50%;left:50%;width:32px;height:32px;
      background:var(--brand);border-radius:50%;transform:translate(-50%,-50%);}
    
    #processing{position:fixed;inset:0;background:rgba(11,18,32,0.95);display:none;align-items:center;
      justify-content:center;z-index:1000;backdrop-filter:blur(10px);}
    #processing.show{display:flex;}
    #processing .content{background:var(--panel);border:1px solid var(--border);border-radius:12px;
      padding:20px;min-width:280px;max-width:400px;text-align:center;}
    #procMeter{width:100%;height:6px;background:var(--btn);border-radius:3px;overflow:hidden;}
    #procMeter .bar{height:100%;background:var(--brand);width:0;transition:width 0.3s;}
    #procMeta{font-size:11px;color:#8aa2d2;}
    
    #ajDock{position:fixed;right:0;top:0;bottom:0;width:320px;background:var(--panel);
      border-left:1px solid var(--border);padding:16px;overflow-y:auto;transform:translateX(100%);
      transition:transform 0.3s;z-index:100;}
    #ajDock.open{transform:translateX(0);}
    #ajDock h3{font-size:14px;margin-bottom:12px;}
    .ajMeta{font-size:11px;color:#8aa2d2;margin-bottom:12px;padding:8px;background:var(--btn);
      border-radius:6px;}
    .ajList{display:flex;flex-direction:column;gap:8px;}
    .ajItem{background:var(--btn);border:1px solid var(--border);padding:10px;border-radius:8px;
      font-size:12px;cursor:pointer;transition:all 0.2s;}
    .ajItem:hover{border-color:var(--brand);}
    .ajItem.applied{background:rgba(43,227,138,0.1);border-color:var(--brand);}
    
    #ajToggle{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:50%;
      background:var(--brand);color:#000;border:none;font-size:24px;cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:99;touch-action:manipulation;}
    #ajToggle:hover{transform:scale(1.05);}
    
    .xray-group, .heat-group{display:none;}
    #ckXray:checked ~ * .xray-group,
    body:has(#ckXray:checked) .xray-group{display:flex;}
    #ckHeat:checked ~ * .heat-group,
    body:has(#ckHeat:checked) .heat-group{display:flex;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ‚ Cake Reveal M</h1>
      <span class="badge">AI é¡è‰²å›å¡«</span>
      <span class="badge">5 æ¨¡å‹èåˆ</span>
      <button class="btn" id="themeToggle" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ™</button>
      <button class="btn" id="installBtn" style="display:none" title="å®‰è£ PWA">ğŸ“²</button>
    </header>

    <div class="grid">
      <div class="card">
        <div class="hflex">
          <label class="btn primary" style="flex:1">
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            ğŸ“‚ é¸æ“‡åœ–ç‰‡
          </label>
          <button class="btn" id="btnHQ" title="é«˜ç•«è³ªè™•ç†">ğŸ”¥ HQ</button>
        </div>
        
        <div class="autoHint" id="autoHint">
          âš ï¸ AI å»ºè­°å·²å¥—ç”¨
          <button class="btn warning" id="btnUndoAuto" style="padding:4px 8px;font-size:11px;margin-left:auto">â†© é‚„åŸ</button>
        </div>
        
        <div class="hflex" style="margin-top:8px">
          <button class="btn" id="btnDL" style="flex:1" title="ä¸‹è¼‰çµæœ">ğŸ’¾ ä¸‹è¼‰</button>
          <button class="btn" id="btnDLMask" style="flex:1" title="ä¸‹è¼‰é®ç½©">ğŸ­ é®ç½©</button>
          <button class="btn" id="btnShare" style="flex:1;display:none" title="åˆ†äº«">ğŸ“¤ åˆ†äº«</button>
        </div>
        
        <div class="hflex" style="margin-top:8px">
          <button class="btn" id="btnUndo" style="flex:1" title="å¾©åŸä¸Šä¸€æ­¥">â†© å¾©åŸ</button>
          <button class="btn" id="btnReset" style="flex:1" title="é‡ç½®å…¨éƒ¨">âš™ï¸ é‡ç½®</button>
          <button class="btn" id="btnCopy" style="flex:1" title="è¤‡è£½è¨­å®š">ğŸ“‹ è¤‡è£½</button>
          <button class="btn" id="btnPaste" style="flex:1" title="è²¼ä¸Šè¨­å®š">ğŸ“Œ è²¼ä¸Š</button>
        </div>
        
        <div id="info">â³ ç­‰å¾…åœ–ç‰‡...</div>
        <hr>

        <div class="row">
          <label>é è¦½é‚Šé•· (px) â€¢ 300-1536</label>
          <input type="range" id="pv" min="300" max="1536" step="50" value="800">
          <span id="pv_v" style="font-size:11px;color:#8aa2d2">800</span>
        </div>

        <div class="toggle">
          <label><input type="checkbox" id="ckDeblock"> å»å¡Šç‹€</label>
          <label><input type="checkbox" id="ckBilateral"> é›™é‚Šæ¿¾æ³¢</label>
          <label><input type="checkbox" id="ckEnh" checked> å¢å¼·</label>
        </div>

        <div class="toggle">
          <label><input type="checkbox" id="ckXray" checked> ğŸ” é€è¦–</label>
          <label><input type="checkbox" id="ckHeat"> ğŸ”¥ ç†±å€</label>
          <label><input type="checkbox" id="ckAiRecolor" checked> ğŸ¨ AIå›å¡«</label>
        </div>

        <div class="row xray-group">
          <label>é€è¦–æ¨¡å¼ â€¢ 5ç¨®</label>
          <select id="xrayMode">
            <option value="gain-fast">âš¡ å¿«é€Ÿå¢ç›Š</option>
            <option value="neutral" selected>ğŸ¯ æ¨™æº–é€è¦–</option>
            <option value="adaptive">ğŸ§  è‡ªé©æ‡‰</option>
            <option value="gradient">ğŸŒˆ æ¢¯åº¦ç†±åœ–</option>
            <option value="clahe">ğŸ”¬ CLAHEå°æ¯”</option>
          </select>
        </div>

        <div class="row xray-group">
          <label>é€è¦–å¼·åº¦ â€¢ 0-12</label>
          <input type="range" id="xrayK" min="0" max="12" step="0.1" value="4.5">
          <span id="xrayK_v" style="font-size:11px;color:#8aa2d2">4.5</span>
        </div>

        <div class="row xray-group">
          <label>é€è¦–ç´°ç¯€ â€¢ 0-2</label>
          <input type="range" id="xrayDetail" min="0" max="2" step="0.05" value="1.0">
          <span id="xrayDetail_v" style="font-size:11px;color:#8aa2d2">1.0</span>
        </div>

        <div class="row heat-group">
          <label>ç†±å€è¦†è“‹ â€¢ 0-1</label>
          <input type="range" id="heatA" min="0" max="1" step="0.05" value="0.6">
          <span id="heatA_v" style="font-size:11px;color:#8aa2d2">0.6</span>
        </div>

        <div class="row">
          <label>éŠ³åŒ– â€¢ 0-3</label>
          <input type="range" id="usmK" min="0" max="3" step="0.05" value="1.0">
          <span id="usmK_v" style="font-size:11px;color:#8aa2d2">1.0</span>
        </div>

        <div class="row">
          <label>é‚Šç·£å¼·åº¦ â€¢ 0-1</label>
          <input type="range" id="edge" min="0" max="1" step="0.05" value="0.4">
          <span id="edge_v" style="font-size:11px;color:#8aa2d2">0.4</span>
        </div>

        <div class="row">
          <label>æµ®é›• â€¢ 0-1</label>
          <input type="range" id="emboss" min="0" max="1" step="0.05" value="0.2">
          <span id="emboss_v" style="font-size:11px;color:#8aa2d2">0.2</span>
        </div>

        <div class="row">
          <label>é™°å½± â€¢ 0-1</label>
          <input type="range" id="shadow" min="0" max="1" step="0.05" value="0.4">
          <span id="shadow_v" style="font-size:11px;color:#8aa2d2">0.4</span>
        </div>

        <div class="row">
          <label>å»éœ§/æŸ”åŒ– â€¢ 0-3</label>
          <input type="range" id="blur" min="0" max="3" step="0.1" value="0">
          <span id="blur_v" style="font-size:11px;color:#8aa2d2">0</span>
        </div>
      </div>

      <div class="card">
        <div class="compareWrap" id="compareWrap">
          <canvas id="src" aria-label="åŸå§‹åœ–"></canvas>
          <div id="afterWrap">
            <canvas id="dst" aria-label="å„ªåŒ–å¾Œåœ–"></canvas>
          </div>
          <div id="divider" role="slider" aria-label="æ‹–å‹•å°æ¯”" tabindex="0"></div>
        </div>
        <div style="margin-top:6px;font-size:10px;color:#6a7fa0">
          ğŸ’¡ æ‹–å‹•ä¸­ç·šæŸ¥çœ‹å°æ¯” | å¿«æ·éµ: O=é–‹å•Ÿ H=é«˜ç•«è³ª S=å„²å­˜ | AIå›å¡«: OpenAI+Replicate+imgix
        </div>
      </div>
    </div>
  </div>

  <div id="processing">
    <div class="content">
      <div style="font-size:14px;margin-bottom:10px;font-weight:600">â³ AI è™•ç†ä¸­...</div>
      <div id="procMeta" style="font-size:11px;color:#8aa2d2;margin-bottom:8px"></div>
      <div id="procMeter"><div class="bar"></div></div>
      <button class="btn" id="btnCancel" style="margin-top:12px">â¹ï¸ å–æ¶ˆ</button>
    </div>
  </div>

  <div id="ajDock">
    <h3>ğŸ§  AI å®Œæ•´æ™ºèƒ½åˆ†æ</h3>
    <div class="ajMeta" id="ajMeta"></div>
    <div class="ajList" id="ajList"></div>
  </div>

  <button id="ajToggle" title="AIæ™ºèƒ½å»ºè­°" aria-label="é–‹å•ŸAIå»ºè­°é¢æ¿">ğŸ§ </button>

<script type="module">
// ============================================================
// ğŸ‚ Cake Reveal M - AI é¡è‰²å›å¡«çµ‚æ¥µç‰ˆ
// æ•´åˆ: OpenAI Vision + Replicate Flux/LoRA + imgix å›å¡«
// ============================================================

const $ = id => document.getElementById(id);
const vibrate = () => navigator.vibrate && navigator.vibrate(10);

// ============================================================
// 1. åˆå§‹åŒ–èˆ‡è¨­å®š
// ============================================================
let originalImage = null;
let processedImage = null;
let history = [];
let abortController = null;

// API ç«¯é»é…ç½®
const API_ENDPOINTS = {
  openai: '/api/openai-proxy',
  replicateDetect: '/api/replicate-detect',
  replicateGenerate: '/api/replicate-generate',
  imgixBase: 'https://maihouses.imgix.net' // è«‹æ›¿æ›æˆä½ çš„ imgix ç¶²åŸŸ
};

// ============================================================
// 2. å·¥å…·å‡½æ•¸
// ============================================================
function setInfo(msg) {
  $('info').textContent = msg;
}

function setProgress(pct, meta = '') {
  $('procMeter').querySelector('.bar').style.width = pct + '%';
  if (meta) $('procMeta').textContent = meta;
}

function showProcessing(show = true) {
  $('processing').classList.toggle('show', show);
}

function pushHistory() {
  if (processedImage) {
    history.push(processedImage);
    if (history.length > 15) history.shift();
  }
}

function dataURLToBlob(dataURL) {
  const arr = dataURL.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], { type: mime });
}

async function uploadToImgix(blob) {
  // è½‰æ› blob ç‚º base64
  const reader = new FileReader();
  const imageData = await new Promise((resolve, reject) => {
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
  
  // ä¸Šå‚³åˆ° imgix (é€éå¾Œç«¯ API)
  const res = await fetch('/api/upload-imgix', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ imageData })
  });
  
  if (!res.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
  const data = await res.json();
  return data.url; // è¿”å› imgix URL
}

// ============================================================
// 3. LAB é¡è‰²ç©ºé–“è½‰æ› (ç”¨æ–¼é¡è‰²å›å¡«)
// ============================================================
function rgbToLab(r, g, b) {
  // RGB to XYZ
  r = r / 255;
  g = g / 255;
  b = b / 255;
  
  r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
  g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
  b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
  
  let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
  let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) / 1.00000;
  let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;
  
  x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x) + (16/116);
  y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y) + (16/116);
  z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z) + (16/116);
  
  return [
    (116 * y) - 16,       // L
    500 * (x - y),        // a
    200 * (y - z)         // b
  ];
}

function labToRgb(l, a, b) {
  // LAB to XYZ
  let y = (l + 16) / 116;
  let x = a / 500 + y;
  let z = y - b / 200;
  
  x = 0.95047 * (x * x * x > 0.008856 ? x * x * x : (x - 16/116) / 7.787);
  y = 1.00000 * (y * y * y > 0.008856 ? y * y * y : (y - 16/116) / 7.787);
  z = 1.08883 * (z * z * z > 0.008856 ? z * z * z : (z - 16/116) / 7.787);
  
  // XYZ to RGB
  let r = x *  3.2406 + y * -1.5372 + z * -0.4986;
  let g = x * -0.9689 + y *  1.8758 + z *  0.0415;
  let b2 = x *  0.0557 + y * -0.2040 + z *  1.0570;
  
  r = r > 0.0031308 ? 1.055 * Math.pow(r, 1/2.4) - 0.055 : 12.92 * r;
  g = g > 0.0031308 ? 1.055 * Math.pow(g, 1/2.4) - 0.055 : 12.92 * g;
  b2 = b2 > 0.0031308 ? 1.055 * Math.pow(b2, 1/2.4) - 0.055 : 12.92 * b2;
  
  return [
    Math.max(0, Math.min(255, Math.round(r * 255))),
    Math.max(0, Math.min(255, Math.round(g * 255))),
    Math.max(0, Math.min(255, Math.round(b2 * 255)))
  ];
}

// ============================================================
// 4. OpenAI Vision API - åœ–åƒå…§å®¹åˆ†æ
// ============================================================
async function analyzeImageWithOpenAI(imageDataURL) {
  setProgress(10, 'ğŸ¤– OpenAI åˆ†æä¸­...');
  
  try {
    const response = await fetch(API_ENDPOINTS.openai, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'user',
            content: [
              {
                type: 'text',
                text: 'åˆ†æé€™å¼µåœ–ç‰‡,è­˜åˆ¥ä¸»è¦ç‰©é«”ã€é¡è‰²åˆ†å¸ƒã€å…‰ç…§æ¢ä»¶ã€‚è¿”å› JSON æ ¼å¼: {objects: [], colors: [], lighting: "", suggestions: {}}'
              },
              {
                type: 'image_url',
                image_url: { url: imageDataURL }
              }
            ]
          }
        ],
        max_tokens: 500,
        temperature: 0.3
      })
    });
    
    if (!response.ok) throw new Error('OpenAI API éŒ¯èª¤');
    
    const data = await response.json();
    const content = data.choices[0].message.content;
    
    // å˜—è©¦è§£æ JSON
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    }
    
    return {
      objects: ['æœªè­˜åˆ¥'],
      colors: [],
      lighting: 'æ¨™æº–',
      suggestions: {}
    };
  } catch (err) {
    console.error('OpenAI åˆ†æå¤±æ•—:', err);
    return null;
  }
}

// ============================================================
// 5. Replicate API - ç‰©é«”æª¢æ¸¬
// ============================================================
async function detectObjectsWithReplicate(imageURL) {
  setProgress(30, 'ğŸ” Replicate ç‰©é«”æª¢æ¸¬...');
  
  try {
    const response = await fetch(API_ENDPOINTS.replicateDetect, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        image: imageURL,
        labels: ['cake', 'clothing', 'person', 'object'],
        mode: 'general'
      })
    });
    
    if (!response.ok) throw new Error('Replicate æª¢æ¸¬å¤±æ•—');
    
    const data = await response.json();
    return data.detections || [];
  } catch (err) {
    console.error('Replicate æª¢æ¸¬å¤±æ•—:', err);
    return [];
  }
}

// ============================================================
// 6. Replicate Flux - åœ–åƒå¢å¼·ç”Ÿæˆ
// ============================================================
async function enhanceWithReplicateFlux(imageURL, prompt) {
  setProgress(50, 'ğŸ¨ Replicate Flux å¢å¼·ä¸­...');
  
  try {
    const response = await fetch(API_ENDPOINTS.replicateGenerate, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: prompt || 'enhance image quality, preserve colors, add details',
        image: imageURL,
        deployment: 'flux-pro'
      })
    });
    
    if (!response.ok) throw new Error('Replicate Flux å¤±æ•—');
    
    const data = await response.json();
    return data.output;
  } catch (err) {
    console.error('Replicate Flux å¤±æ•—:', err);
    return null;
  }
}

// ============================================================
// 7. imgix API - é¡è‰²æ··åˆèˆ‡å›å¡«
// ============================================================
async function recolorWithImgix(originalURL, enhancedURL) {
  setProgress(70, 'ğŸ¨ imgix é¡è‰²å›å¡«ä¸­...');
  
  try {
    // ä½¿ç”¨ imgix blend API é€²è¡Œé¡è‰²æ··åˆ
    // blend-mode=screen å¯ä»¥ä¿ç•™åŸå§‹é¡è‰²ä¸¦å¢å¼·
    const imgixURL = `${API_ENDPOINTS.imgixBase}/${originalURL}` +
      `?blend=${encodeURIComponent(enhancedURL)}` +
      `&blend-mode=screen` +
      `&blend-alpha=60` +
      `&sat=10` +
      `&sharp=20` +
      `&auto=enhance`;
    
    return imgixURL;
  } catch (err) {
    console.error('imgix å›å¡«å¤±æ•—:', err);
    return null;
  }
}

// ============================================================
// 8. Canvas LAB é¡è‰²å›å¡« (æœ¬åœ°è™•ç†)
// ============================================================
async function labColorRestore(originalCanvas, enhancedCanvas) {
  setProgress(80, 'ğŸ”¬ LAB é¡è‰²ç©ºé–“å›å¡«...');
  
  const width = originalCanvas.width;
  const height = originalCanvas.height;
  
  const origCtx = originalCanvas.getContext('2d');
  const enhCtx = enhancedCanvas.getContext('2d');
  
  const origData = origCtx.getImageData(0, 0, width, height);
  const enhData = enhCtx.getImageData(0, 0, width, height);
  const outData = enhCtx.createImageData(width, height);
  
  for (let i = 0; i < origData.data.length; i += 4) {
    // è½‰æ›åˆ° LAB
    const origLab = rgbToLab(origData.data[i], origData.data[i+1], origData.data[i+2]);
    const enhLab = rgbToLab(enhData.data[i], enhData.data[i+1], enhData.data[i+2]);
    
    // ä½¿ç”¨å¢å¼·å¾Œçš„ L (äº®åº¦), åŸå§‹çš„ a/b (é¡è‰²)
    // é€™æ¨£å¯ä»¥ä¿ç•™åŸå§‹é¡è‰²ä½†æå‡ç´°ç¯€
    const newLab = [
      enhLab[0] * 0.7 + origLab[0] * 0.3, // æ··åˆäº®åº¦
      origLab[1],                          // ä¿ç•™åŸå§‹ a
      origLab[2]                           // ä¿ç•™åŸå§‹ b
    ];
    
    const rgb = labToRgb(newLab[0], newLab[1], newLab[2]);
    
    outData.data[i] = rgb[0];
    outData.data[i+1] = rgb[1];
    outData.data[i+2] = rgb[2];
    outData.data[i+3] = origData.data[i+3]; // ä¿ç•™ alpha
  }
  
  const outCanvas = document.createElement('canvas');
  outCanvas.width = width;
  outCanvas.height = height;
  const outCtx = outCanvas.getContext('2d');
  outCtx.putImageData(outData, 0, 0);
  
  return outCanvas;
}

// ============================================================
// 9. å®Œæ•´ AI è™•ç†æµç¨‹
// ============================================================
async function processWithAI(imageFile) {
  showProcessing(true);
  abortController = new AbortController();
  
  try {
    // Step 1: è®€å–åœ–ç‰‡
    const reader = new FileReader();
    const imageDataURL = await new Promise((resolve, reject) => {
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(imageFile);
    });
    
    // Step 2: OpenAI åˆ†æ
    const analysis = await analyzeImageWithOpenAI(imageDataURL);
    console.log('OpenAI åˆ†æçµæœ:', analysis);
    
    // Step 3: ä¸Šå‚³åˆ° imgix (æˆ–ä½ çš„ CDN)
    const blob = dataURLToBlob(imageDataURL);
    const uploadedURL = await uploadToImgix(blob);
    
    // Step 4: Replicate ç‰©é«”æª¢æ¸¬
    const detections = await detectObjectsWithReplicate(uploadedURL);
    console.log('æª¢æ¸¬çµæœ:', detections);
    
    // Step 5: Replicate Flux å¢å¼·
    const enhancedURL = await enhanceWithReplicateFlux(
      uploadedURL,
      analysis?.suggestions?.prompt || 'enhance details, preserve colors'
    );
    
    if (!enhancedURL) throw new Error('å¢å¼·å¤±æ•—');
    
    // Step 6: imgix é¡è‰²å›å¡«
    const recoloredURL = await recolorWithImgix(uploadedURL, enhancedURL);
    
    // Step 7: è¼‰å…¥å›å¡«å¾Œçš„åœ–ç‰‡
    const finalImg = new Image();
    finalImg.crossOrigin = 'anonymous';
    await new Promise((resolve, reject) => {
      finalImg.onload = resolve;
      finalImg.onerror = reject;
      finalImg.src = recoloredURL;
    });
    
    // Step 8: Canvas LAB ç²¾ç´°å›å¡«
    const originalCanvas = document.createElement('canvas');
    originalCanvas.width = finalImg.width;
    originalCanvas.height = finalImg.height;
    const origCtx = originalCanvas.getContext('2d');
    origCtx.drawImage(originalImage, 0, 0, finalImg.width, finalImg.height);
    
    const enhancedCanvas = document.createElement('canvas');
    enhancedCanvas.width = finalImg.width;
    enhancedCanvas.height = finalImg.height;
    const enhCtx = enhancedCanvas.getContext('2d');
    enhCtx.drawImage(finalImg, 0, 0);
    
    const finalCanvas = await labColorRestore(originalCanvas, enhancedCanvas);
    
    setProgress(100, 'âœ… å®Œæˆ!');
    processedImage = finalCanvas.toDataURL('image/png');
    
    // é¡¯ç¤ºçµæœ
    $('dst').width = finalCanvas.width;
    $('dst').height = finalCanvas.height;
    $('dst').getContext('2d').drawImage(finalCanvas, 0, 0);
    
    setInfo(`âœ… AI è™•ç†å®Œæˆ | ${finalCanvas.width}Ã—${finalCanvas.height}px`);
    
    // é¡¯ç¤º AI å»ºè­°
    if (analysis) {
      showAIRecommendations(analysis, detections);
    }
    
    setTimeout(() => showProcessing(false), 500);
    vibrate();
    
  } catch (err) {
    console.error('AI è™•ç†å¤±æ•—:', err);
    setInfo('âŒ AI è™•ç†å¤±æ•—: ' + err.message);
    showProcessing(false);
  }
}

// ============================================================
// 10. AI å»ºè­°é¢æ¿
// ============================================================
function showAIRecommendations(analysis, detections) {
  const meta = $('ajMeta');
  const list = $('ajList');
  
  meta.innerHTML = `
    <div><strong>ç‰©é«”:</strong> ${analysis.objects.join(', ')}</div>
    <div><strong>é¡è‰²:</strong> ${analysis.colors.join(', ')}</div>
    <div><strong>å…‰ç…§:</strong> ${analysis.lighting}</div>
    <div><strong>æª¢æ¸¬æ•¸:</strong> ${detections.length} å€‹ç‰©é«”</div>
  `;
  
  list.innerHTML = '';
  
  // æ ¹æ“šåˆ†æçµæœç”Ÿæˆå»ºè­°
  const suggestions = [
    { label: 'ğŸ¯ è‡ªå‹•æœ€ä½³åŒ–', params: { xrayK: 4.5, usmK: 1.2, edge: 0.5 } },
    { label: 'ğŸ”¥ é«˜å°æ¯”å¢å¼·', params: { xrayK: 6.0, usmK: 1.5, edge: 0.7 } },
    { label: 'ğŸ’ ç´°ç¯€ä¿ç•™', params: { xrayK: 3.0, usmK: 0.8, edge: 0.3 } },
    { label: 'ğŸŒˆ è‰²å½©è±å¯Œ', params: { xrayK: 5.0, usmK: 1.0, edge: 0.6 } }
  ];
  
  suggestions.forEach(sug => {
    const div = document.createElement('div');
    div.className = 'ajItem';
    div.textContent = sug.label;
    div.onclick = () => {
      applySuggestion(sug.params);
      div.classList.add('applied');
    };
    list.appendChild(div);
  });
}

function applySuggestion(params) {
  Object.entries(params).forEach(([key, val]) => {
    const input = $(key);
    if (input) {
      input.value = val;
      const event = new Event('input', { bubbles: true });
      input.dispatchEvent(event);
    }
  });
  vibrate();
}

// ============================================================
// 11. æª”æ¡ˆè¼‰å…¥
// ============================================================
$('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const img = new Image();
  const url = URL.createObjectURL(file);
  
  img.onload = () => {
    originalImage = img;
    
    // ç¹ªè£½åŸå§‹åœ–
    $('src').width = img.width;
    $('src').height = img.height;
    $('src').getContext('2d').drawImage(img, 0, 0);
    
    $('dst').width = img.width;
    $('dst').height = img.height;
    
    setInfo(`âœ… å·²è¼‰å…¥ ${img.width}Ã—${img.height}px`);
    
    // å¦‚æœå•Ÿç”¨ AI å›å¡«ï¼Œè‡ªå‹•è™•ç†
    if ($('ckAiRecolor').checked) {
      processWithAI(file);
    }
    
    URL.revokeObjectURL(url);
    vibrate();
  };
  
  img.src = url;
});

// ============================================================
// 12. å…¶ä»– UI æ§åˆ¶
// ============================================================

// ä¸»é¡Œåˆ‡æ›
$('themeToggle').addEventListener('click', () => {
  const html = document.documentElement;
  const current = html.dataset.theme || 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next;
  localStorage.setItem('theme', next);
  $('themeToggle').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  vibrate();
});

// è¼‰å…¥å„²å­˜çš„ä¸»é¡Œ
const savedTheme = localStorage.getItem('theme') || 'dark';
document.documentElement.dataset.theme = savedTheme;
$('themeToggle').textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

// AI é¢æ¿åˆ‡æ›
$('ajToggle').addEventListener('click', () => {
  $('ajDock').classList.toggle('open');
  vibrate();
});

// å¾©åŸ
$('btnUndo').addEventListener('click', () => {
  if (history.length > 0) {
    processedImage = history.pop();
    const img = new Image();
    img.onload = () => {
      $('dst').getContext('2d').drawImage(img, 0, 0);
      setInfo('â†© å·²å¾©åŸ');
      vibrate();
    };
    img.src = processedImage;
  }
});

// ä¸‹è¼‰
$('btnDL').addEventListener('click', () => {
  if (!processedImage) return;
  const a = document.createElement('a');
  a.href = processedImage;
  a.download = `cake-reveal-${Date.now()}.png`;
  a.click();
  vibrate();
});

// å–æ¶ˆè™•ç†
$('btnCancel').addEventListener('click', () => {
  if (abortController) abortController.abort();
  showProcessing(false);
  setInfo('â¹ï¸ å·²å–æ¶ˆ');
  vibrate();
});

// æ»‘æ¡¿æ•¸å€¼é¡¯ç¤º
['pv', 'xrayK', 'xrayDetail', 'heatA', 'usmK', 'edge', 'emboss', 'shadow', 'blur'].forEach(id => {
  const input = $(id);
  const display = $(id + '_v');
  if (input && display) {
    input.addEventListener('input', () => {
      display.textContent = input.value;
    });
  }
});

// PWA å®‰è£
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('installBtn').style.display = 'flex';
});

$('installBtn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  console.log('PWA å®‰è£:', outcome);
  deferredPrompt = null;
  $('installBtn').style.display = 'none';
  vibrate();
});

// å°æ¯”æ»‘æ¡¿æ‹–å‹•
let isDragging = false;
const divider = $('divider');
const compareWrap = $('compareWrap');
const afterWrap = $('afterWrap');

function updateDivider(e) {
  if (!isDragging && e.type !== 'click') return;
  
  const rect = compareWrap.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const pct = Math.max(0, Math.min(100, (x / rect.width) * 100));
  
  divider.style.left = pct + '%';
  afterWrap.style.width = pct + '%';
}

divider.addEventListener('mousedown', () => isDragging = true);
divider.addEventListener('touchstart', () => isDragging = true);
document.addEventListener('mousemove', updateDivider);
document.addEventListener('touchmove', updateDivider);
document.addEventListener('mouseup', () => isDragging = false);
document.addEventListener('touchend', () => isDragging = false);
compareWrap.addEventListener('click', updateDivider);

// å¿«æ·éµ
document.addEventListener('keydown', (e) => {
  if (e.key === 'o' || e.key === 'O') $('fileInput').click();
  if (e.key === 's' || e.key === 'S') $('btnDL').click();
  if (e.key === 'h' || e.key === 'H') $('btnHQ').click();
});

console.log('âœ… Cake Reveal M åˆå§‹åŒ–å®Œæˆ - AI é¡è‰²å›å¡«çµ‚æ¥µç‰ˆ');
console.log('ğŸ“¡ API ç«¯é»:', API_ENDPOINTS);
console.log('ğŸ¨ æ”¯æ´: OpenAI Vision + Replicate Flux + imgix Blend + LAB Recolor');
</script>
</body>
</html>
