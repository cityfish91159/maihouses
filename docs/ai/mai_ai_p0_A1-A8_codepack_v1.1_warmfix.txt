=== README (v1.1 warmfix) ===
é‚æˆ¿å­ï½œAIå°è©± P0 A1â€“A8 ä»£ç¢¼åŒ…ï¼ˆ2025-11-11 12:40, v1.1ã€Œwarmfixã€ï¼‰

æ›´æ–°é‡é»ï¼ˆç›¸å° v1.0ï¼‰ï¼š
- A1 å®‰éœæ¨¡å¼ï¼šæ–‡æ¡ˆæ›´æº«æš–ã€åŠ å…¥å¿«é€Ÿé è¨­ï¼›LLM ç³»çµ±æç¤ºè‡ªå‹•åˆ‡åˆ°ã€ŒZen æ¨¡å¼ã€
- A2 å›è¨ªæš–å•Ÿæ¢ï¼šè®€å– lastMood èˆ‡ tagsï¼Œå›è¨ªæ–‡æ¡ˆæ›´å€‹äººåŒ–
- A3 å¿ƒæƒ…è† å›Šï¼šæ–‡æ¡ˆå£èªåŒ–ï¼ˆä»Šå¤©é‚„ä¸éŒ¯ï¼æœ‰é»ç´¯ï¼æƒ³æ”¾ç©ºï¼‰ä¸¦æŠŠæƒ…ç·’å¯«å…¥ Profile.lastMood
- A4 æ”¶è—å‚™è¨»ï¼šåŠ å…¥ã€Œé™ªä¼´å¼ã€å¾®æ–‡æ¡ˆï¼ˆè¼¸å…¥æ™‚é¡¯ç¤ºã€Œæ…¢æ…¢å¯«ï¼Œæˆ‘åœ¨ã€ï¼‰
- A5 ç¦®è²Œæ”¹å¯«å™¨ï¼šæ–°å¢ã€Œå°è±¡/ç›®çš„ã€é¸æ“‡ï¼Œç”Ÿæˆæ›´è²¼æƒ…å¢ƒï¼›æ¡ç”¨å¾Œé¡¯ç¤ºã€Œå¸Œæœ›é †åˆ© ğŸ¤ã€
- A6 ELI5ï¼šé¦–æ¬¡é‡åˆ°é—œéµè¡“èªæœƒä¸»å‹•å»ºè­°ï¼ˆæ¯æ—¥ä¸€æ¬¡ï¼‰
- A7 é ç®— Liteï¼šæ–°å¢æœˆæ”¶å…¥ï¼ˆå¯é¸ï¼‰ã€è² æ“”ç‡æç¤ºèˆ‡æš–æ€§å»ºè­°
- A8 çœ‹å±‹ä¸‰å•ï¼šè¼¸å‡ºå« #tagsï¼Œä¸¦è‡ªå‹•å¯«å…¥ Profile.tagsï¼ˆä¾› A2 ä½¿ç”¨ï¼‰
- ai.tsï¼šä¾ Quiet/Mood/Profile çµ„åˆå‹•æ…‹ System Promptï¼ˆZen/Tone/Tagsï¼‰

æ€éº¼ç”¨ï¼š
1) é€æª”è¦†è“‹åˆ°ä½ çš„ Vite + React + TS å°ˆæ¡ˆã€‚
2) å¾Œç«¯ä»éœ€æä¾› /api/openai-proxy è½‰ç™¼ã€‚
3) è‹¥ä½ å·²æœ‰è‡ªè¨‚æ¨£å¼ï¼Œåƒ…ç§»æ¤é‚è¼¯èˆ‡ props å³å¯ã€‚

â€”

=== src/analytics/track.ts ===
// ç°¡æ˜“åŸ‹é»ï¼ˆäº‹ä»¶å‘½åæ›´è²¼è¿‘ç”¨æˆ¶èªæ„ï¼‰
export function track(event: string, payload?: Record<string, any>) {
  try {
    // eslint-disable-next-line no-console
    console.debug("[track]", event, payload || {});
  } catch {}
}
export const Events = {
  QuietOn: "user.needs_quiet_space",
  QuietOff: "user.back_to_explore",
  QuietAutoOff: "user.quiet_space_timeout",
  QuietTurnUsed: "user.quiet_space_turn_used",
  WarmbarView: "ui.warmbar_view",
  WarmbarContinue: "ui.warmbar_click_continue",
  WarmbarDismiss: "ui.warmbar_click_dismiss",
  MoodPick: "user.feeling_set",
  NoteSaved: "user.reflects_on_viewing",
  DebriefGen: "user.debrief_mna_generated",
  DebriefSave: "user.debrief_saved",
  BudgetCopy: "user.seeks_budget_clarity",
  ELI5Open: "user.needs_plain_explain",
  RewriteGen: "user.needs_polite_message_generated",
  RewriteAdopt: "user.polite_message_adopted",
};

=== src/stores/profileStore.ts ===
export type UserMilestones = {
  birthday?: string;      // YYYY-MM-DD
  move_in_date?: string;  // YYYY-MM-DD
};
export type UserProfile = {
  tags: string[];
  milestones?: UserMilestones;
  lastSeenAt?: number;
  lastMood?: "neutral" | "stress" | "rest";
};

const STORAGE_KEY = "mai-user-profile-v1";
const FIRST_SEEN_KEY = "mai-first-seen-ts";
const WARM_DISMISS_KEY = "mai-warmbar-dismissed-date"; // YYYY-MM-DD

export function loadProfile(): UserProfile {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { tags: [] };
    return JSON.parse(raw) as UserProfile;
  } catch {
    return { tags: [] };
  }
}
export function saveProfile(p: UserProfile) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
}
export function upsertTags(newTags: string[]) {
  const p = loadProfile();
  const set = new Set([...(p.tags || []), ...newTags].filter(Boolean));
  p.tags = Array.from(set).slice(0, 8);
  saveProfile(p);
}
export function setMilestones(ms: UserMilestones) {
  const p = loadProfile();
  p.milestones = { ...(p.milestones || {}), ...ms };
  saveProfile(p);
}
export function setLastMood(mood: "neutral" | "stress" | "rest") {
  const p = loadProfile();
  p.lastMood = mood;
  saveProfile(p);
}
export function touchVisit() {
  const p = loadProfile();
  p.lastSeenAt = Date.now();
  saveProfile(p);
}
export function ensureFirstSeen(): { isFirstVisit: boolean } {
  const exist = localStorage.getItem(FIRST_SEEN_KEY);
  if (exist) return { isFirstVisit: false };
  localStorage.setItem(FIRST_SEEN_KEY, String(Date.now()));
  return { isFirstVisit: true };
}
export function dismissWarmbarToday() {
  localStorage.setItem(WARM_DISMISS_KEY, todayStr());
}
export function isWarmbarDismissedToday() {
  return localStorage.getItem(WARM_DISMISS_KEY) === todayStr();
}
export function getWarmTags(max = 3): string[] {
  const p = loadProfile();
  return (p.tags || []).slice(0, max);
}
function todayStr(): string {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}
function diffDays(a: Date, b: Date): number {
  const MS = 24 * 60 * 60 * 1000;
  const ad = new Date(a.getFullYear(), a.getMonth(), a.getDate()).getTime();
  const bd = new Date(b.getFullYear(), b.getMonth(), b.getDate()).getTime();
  return Math.round((ad - bd) / MS);
}
export function getMilestoneHint(ms?: UserMilestones): string | null {
  if (!ms) return null;
  const now = new Date();
  if (ms.birthday) {
    const hint = nearAnnual(ms.birthday, now, 7);
    if (hint) return hint;
  }
  if (ms.move_in_date) {
    const hint = nearAnnual(ms.move_in_date, now, 7, "æ¬å®¶");
    if (hint) return hint;
  }
  return null;
}
function nearAnnual(dateStr: string, now: Date, days = 7, label?: string): string | null {
  const [y, m, d] = dateStr.split("-").map((x) => Number(x));
  if (!y || !m || !d) return null;
  const thisYear = new Date(now.getFullYear(), m - 1, d);
  const delta = Math.abs(diffDays(thisYear, now));
  if (delta <= days) {
    if (label === "æ¬å®¶") return "æ¬å®¶ä¸€é€±å¹´ï¼";
    return "ç”Ÿæ—¥å¿«æ¨‚ï¼";
  }
  return null;
}

=== src/context/QuietModeContext.tsx ===
import React, { createContext, useCallback, useContext, useEffect, useMemo, useRef, useState } from "react";
import { Events, track } from "../analytics/track";

type QuietState = {
  isQuiet: boolean;
  reason?: string;         // e.g. "åªèŠå¤©"/"å£“åŠ›å¤§"
  untilTs?: number | null; // åˆ°æœŸæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
  remainingTurns?: number | null; // å‰©é¤˜å›åˆï¼ˆé è¨­ 10ï¼‰
};
type QuietAPI = {
  state: QuietState;
  startQuiet: (opts?: { minutes?: number; turns?: number; reason?: string }) => void;
  clearQuiet: () => void;
  decrementTurn: () => void;
  isActive: () => boolean;
};
const STORAGE_KEY = "mai-quiet-mode-v1";
const QuietModeContext = createContext<QuietAPI | null>(null);

function readStorage(): QuietState {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { isQuiet: false, untilTs: null, remainingTurns: null };
    const parsed = JSON.parse(raw) as QuietState;
    return parsed;
  } catch {
    return { isQuiet: false, untilTs: null, remainingTurns: null };
  }
}
function writeStorage(s: QuietState) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
}

export const QuietModeProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [state, setState] = useState<QuietState>(() => readStorage());
  const tickRef = useRef<number | null>(null);

  const isActive = useCallback(() => {
    if (!state.isQuiet) return false;
    const now = Date.now();
    if (state.untilTs && now > state.untilTs) return false;
    if (state.remainingTurns !== null && (state.remainingTurns ?? 0) <= 0) return false;
    return true;
  }, [state]);

  // è‡ªå‹•æ¸…ç†éæœŸ
  useEffect(() => {
    const now = Date.now();
    if (state.isQuiet && state.untilTs && now > state.untilTs) {
      setState({ isQuiet: false, untilTs: null, remainingTurns: null });
      writeStorage({ isQuiet: false, untilTs: null, remainingTurns: null });
    }
  }, [state]);

  // å¿ƒè·³æª¢æŸ¥ï¼ˆæ¯ 30 ç§’ç¢ºèªæ˜¯å¦éæœŸï¼‰
  useEffect(() => {
    if (tickRef.current) window.clearInterval(tickRef.current);
    tickRef.current = window.setInterval(() => {
      const now = Date.now();
      const saved = readStorage();
      if (saved.isQuiet && saved.untilTs && now > saved.untilTs) {
        setState({ isQuiet: false, untilTs: null, remainingTurns: null });
        writeStorage({ isQuiet: false, untilTs: null, remainingTurns: null });
      }
    }, 30000) as unknown as number;
    return () => {
      if (tickRef.current) window.clearInterval(tickRef.current);
    };
  }, []);

  const startQuiet = useCallback((opts?: { minutes?: number; turns?: number; reason?: string }) => {
    const minutes = opts?.minutes ?? null;
    const turns = opts?.turns ?? 10; // é è¨­ 10 å›åˆ
    const reason = opts?.reason;
    const untilTs = minutes ? Date.now() + minutes * 60_000 : null;
    const next: QuietState = {
      isQuiet: true,
      reason,
      untilTs,
      remainingTurns: turns,
    };
    setState(next);
    writeStorage(next);
    track(Events.QuietOn, { reason, minutes, turns });
  }, []);

  const clearQuiet = useCallback(() => {
    const next: QuietState = { isQuiet: false, untilTs: null, remainingTurns: null };
    setState(next);
    writeStorage(next);
    track(Events.QuietOff, {});
  }, []);

  const decrementTurn = useCallback(() => {
    setState(prev => {
      if (!prev.isQuiet) return prev;
      if (prev.remainingTurns === null) return prev;
      const left = Math.max(0, (prev.remainingTurns ?? 0) - 1);
      const next: QuietState = { ...prev, remainingTurns: left };
      writeStorage(next);
      if (left === 0) {
        const cleared: QuietState = { isQuiet: false, untilTs: null, remainingTurns: null };
        writeStorage(cleared);
        track(Events.QuietAutoOff, { reason: "turns_exhausted" });
        return cleared;
      }
      return next;
    });
  }, []);

  const value = useMemo<QuietAPI>(() => ({
    state,
    startQuiet,
    clearQuiet,
    decrementTurn,
    isActive,
  }), [state, startQuiet, clearQuiet, decrementTurn, isActive]);

  return (
    <QuietModeContext.Provider value={value}>
      {children}
    </QuietModeContext.Provider>
  );
};
export function useQuietMode() {
  const ctx = useContext(QuietModeContext);
  if (!ctx) throw new Error("useQuietMode must be used within QuietModeProvider");
  return ctx;
}
export function isQuietActiveFromStorage(): boolean {
  try {
    const raw = localStorage.getItem("mai-quiet-mode-v1");
    if (!raw) return false;
    const s = JSON.parse(raw) as QuietState;
    const now = Date.now();
    if (!s.isQuiet) return false;
    if (s.untilTs && now > s.untilTs) return false;
    if (s.remainingTurns !== null && (s.remainingTurns ?? 0) <= 0) return false;
    return true;
  } catch { return false; }
}

=== src/components/QuietBanner.tsx ===
import React from "react";
import { useQuietMode } from "../context/QuietModeContext";

const barStyle: React.CSSProperties = {
  width: "100%",
  background: "#0a2246",
  color: "white",
  fontSize: 14,
  lineHeight: "36px",
  height: 36,
  textAlign: "center",
  letterSpacing: "0.5px",
};
export const QuietBanner: React.FC = () => {
  const { state, clearQuiet, isActive } = useQuietMode();
  if (!isActive()) return null;

  const minutesLeft =
    state.untilTs ? Math.max(0, Math.ceil((state.untilTs - Date.now()) / 60000)) : null;
  const turnsLeft = state.remainingTurns ?? null;

  return (
    <div style={barStyle} role="status" aria-live="polite">
      <span>é‚é‚å®‰éœé™ªä½ èŠï¼Œä¸æ‰“æ“¾ ğŸ˜Š</span>
      {state.reason ? <span>ï½œ{state.reason}</span> : null}
      {minutesLeft !== null ? <span>ï½œå‰©é¤˜ {minutesLeft} åˆ†</span> : null}
      {turnsLeft !== null ? <span>ï½œå‰©é¤˜ {turnsLeft} å›åˆ</span> : null}
      <button
        onClick={clearQuiet}
        aria-label="è§£é™¤å®‰éœæ¨¡å¼"
        style={{ marginLeft: 12, padding: "2px 8px", borderRadius: 6, border: "1px solid #fff", background: "transparent", color: "#fff", cursor: "pointer" }}
      >
        è§£é™¤
      </button>
    </div>
  );
};

=== src/components/QuietModeToggle.tsx ===
import React, { useState } from "react";
import { useQuietMode } from "../context/QuietModeContext";

export const QuietModeToggle: React.FC = () => {
  const { startQuiet, clearQuiet, isActive } = useQuietMode();
  const [minutes, setMinutes] = useState<number | "">("");
  const [turns, setTurns] = useState<number>(10);
  const [reason, setReason] = useState<string>("åªèŠå¤©");

  if (isActive()) {
    return (
      <button
        onClick={clearQuiet}
        title="å®‰éœæ¨¡å¼å·²å•Ÿç”¨ï¼Œé»æ“Šè§£é™¤"
        className="btn-quiet on"
        style={{ padding: "6px 10px", borderRadius: 8, border: "1px solid #1749D7", background: "#1749D7", color: "#fff" }}
      >
        å®‰éœä¸­ï¼ˆè§£é™¤ï¼‰
      </button>
    );
  }

  const handleStart = () => {
    startQuiet({
      minutes: typeof minutes === "number" && minutes > 0 ? minutes : undefined,
      turns: turns > 0 ? turns : undefined,
      reason: reason || undefined,
    });
  };

  return (
    <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
      <button
        onClick={handleStart}
        title="å•Ÿç”¨å®‰éœæ¨¡å¼ï¼ˆé è¨­ 10 å›åˆï¼‰"
        className="btn-quiet off"
        style={{ padding: "6px 10px", borderRadius: 8, border: "1px solid #1749D7", background: "#fff", color: "#1749D7" }}
      >
        é–‹å•Ÿå®‰éœæ¨¡å¼
      </button>
      <button
        onClick={() => startQuiet({ minutes: 20, turns: 999, reason: "åªæƒ³èŠ 20 åˆ†é˜" })}
        style={{ padding: "4px 8px", borderRadius: 999, border: "1px dashed #1749D7", background: "#F5F8FF", color: "#1749D7" }}
      >
        åªæƒ³èŠ 20 åˆ†é˜
      </button>
      <button
        onClick={() => startQuiet({ minutes: undefined, turns: 999, reason: "ä»Šå¤©åˆ¥æ¨è–¦äº†" })}
        style={{ padding: "4px 8px", borderRadius: 999, border: "1px dashed #1749D7", background: "#F5F8FF", color: "#1749D7" }}
      >
        ä»Šå¤©åˆ¥æ¨è–¦äº†
      </button>
      <input
        type="number"
        min={0}
        placeholder="åˆ†é˜(å¯é¸)"
        value={typeof minutes === "number" ? minutes : ""}
        onChange={(e) => {
          const v = Number(e.target.value);
          setMinutes(Number.isFinite(v) ? v : "");
        }}
        style={{ width: 90, padding: "4px 6px", borderRadius: 6, border: "1px solid #ddd" }}
      />
      <input
        type="number"
        min={1}
        placeholder="å›åˆ(é è¨­10)"
        value={turns}
        onChange={(e) => {
          const v = Number(e.target.value);
          setTurns(Number.isFinite(v) && v > 0 ? v : 10);
        }}
        style={{ width: 90, padding: "4px 6px", borderRadius: 6, border: "1px solid #ddd" }}
      />
      <input
        type="text"
        placeholder="åŸå› (å¯é¸)"
        value={reason}
        onChange={(e) => setReason(e.target.value)}
        style={{ width: 120, padding: "4px 6px", borderRadius: 6, border: "1px solid #ddd" }}
      />
    </div>
  );
};

=== src/components/WarmWelcomeBar.tsx ===
import React, { useEffect, useMemo, useState } from "react";
import { getMilestoneHint, getWarmTags, ensureFirstSeen, isWarmbarDismissedToday, dismissWarmbarToday, loadProfile } from "../stores/profileStore";
import { Events, track } from "../analytics/track";

const barStyle: React.CSSProperties = {
  width: "100%",
  background: "#F5F8FF",
  color: "#0a2246",
  fontSize: 14,
  lineHeight: "34px",
  height: 34,
  textAlign: "center",
  letterSpacing: "0.3px",
  borderBottom: "1px solid #E6ECFF",
  display: "flex",
  alignItems: "center",
  justifyContent: "center",
  gap: 12,
};
const linkBtn: React.CSSProperties = {
  padding: "2px 10px",
  borderRadius: 999,
  border: "1px solid #1749D7",
  background: "#1749D7",
  color: "#fff",
  cursor: "pointer",
  lineHeight: "24px",
  height: 26,
};
const ghostBtn: React.CSSProperties = {
  padding: "2px 10px",
  borderRadius: 999,
  border: "1px solid #C9D5FF",
  background: "#fff",
  color: "#1749D7",
  cursor: "pointer",
  lineHeight: "24px",
  height: 26,
};

export const WarmWelcomeBar: React.FC = () => {
  const [shouldShow, setShouldShow] = useState(false);
  const profile = loadProfile();
  const tags = useMemo(() => getWarmTags(3), []);
  const milestone = useMemo(() => getMilestoneHint(profile.milestones), [profile.milestones]);

  useEffect(() => {
    const { isFirstVisit } = ensureFirstSeen();
    const hasContent = (tags && tags.length > 0) || !!milestone || !!profile.lastMood;
    const ok = !isFirstVisit && !isWarmbarDismissedToday() && hasContent;
    setShouldShow(ok);
    if (ok) track(Events.WarmbarView, { tags, milestone: !!milestone, lastMood: profile.lastMood });
  }, [tags, milestone, profile.lastMood]);

  if (!shouldShow) return null;

  const greetByMood = (m?: string) => {
    if (m === "stress") return "æœ€è¿‘è¾›è‹¦äº†";
    if (m === "rest") return "æ…¢æ…¢ä¾†å°±å¥½";
    return "å¥½ä¹…ä¸è¦‹";
  };

  const tagText = tags && tags.length > 0 ? `ä¸Šæ¬¡ä½ æåˆ°ã€Œ${tags.join("ãƒ»")}ã€` : null;
  const leftText = milestone ? milestone : (tagText ? `${greetByMood(profile.lastMood)}ï¼Œ${tagText}` : `${greetByMood(profile.lastMood)}ï¼Œé€™å¹¾å¤©éå¾—æ€éº¼æ¨£`);

  const onContinue = () => {
    track(Events.WarmbarContinue, { tags, milestone: !!milestone });
    const seed = milestone
      ? "æœ€è¿‘æœ‰é»ç´€å¿µæ—¥çš„æ„Ÿè¦ºï¼Œæƒ³è¼•é¬†èŠèŠã€‚"
      : (tags && tags.length > 0 ? `é‚„è¨˜å¾—æˆ‘å€‘èŠé ${tags.join("ã€")}ï¼Œä½ æœ‰æ–°æƒ³æ³•å—ï¼Ÿ` : "æƒ³è·Ÿä½ èŠèŠè¿‘æ³ï½");
    window.dispatchEvent(new CustomEvent("mai:chat:start", { detail: { text: seed } }));
  };
  const onDismissToday = () => {
    dismissWarmbarToday();
    setShouldShow(false);
    track(Events.WarmbarDismiss, {});
  };

  return (
    <div style={barStyle} role="status" aria-live="polite">
      <span>{leftText}</span>
      <button style={linkBtn} onClick={onContinue}>æ¥è‘—èŠ</button>
      <button style={ghostBtn} onClick={onDismissToday}>ä»Šå¤©ä¸å†é¡¯ç¤º</button>
    </div>
  );
};

=== src/context/MoodContext.tsx ===
import React, { createContext, useContext, useMemo, useState } from "react";
import { Events, track } from "../analytics/track";
import { setLastMood } from "../stores/profileStore";

export type Mood = "neutral" | "stress" | "rest";
type MoodAPI = {
  mood: Mood;
  setMood: (m: Mood) => void;
  tone: "warm" | "soothe" | "light";
  throttleLevel: 0 | 1 | 2; // 2=æœ€ç¯€æµ
};
const MoodContext = createContext<MoodAPI | null>(null);

export const MoodProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [mood, setMoodState] = useState<Mood>(() => {
    const raw = localStorage.getItem("mai-mood-v1");
    return (raw as Mood) || "neutral";
  });

  const setMood = (m: Mood) => {
    setMoodState(m);
    localStorage.setItem("mai-mood-v1", m);
    setLastMood(m);
    track(Events.MoodPick, { mood: m });
  };

  const tone: "warm" | "soothe" | "light" =
    mood === "stress" ? "soothe" : mood === "rest" ? "warm" : "light";

  const throttleLevel: 0 | 1 | 2 =
    mood === "stress" ? 2 : mood === "rest" ? 1 : 0;

  const value = useMemo<MoodAPI>(() => ({ mood, setMood, tone, throttleLevel }), [mood]);
  return <MoodContext.Provider value={value}>{children}</MoodContext.Provider>;
};
export function useMood() {
  const ctx = useContext(MoodContext);
  if (!ctx) throw new Error("useMood must be used within MoodProvider");
  return ctx;
}

=== src/components/MoodChips.tsx ===
import React from "react";
import { useMood } from "../context/MoodContext";

const chipStyle = (active: boolean): React.CSSProperties => ({
  padding: "6px 10px",
  borderRadius: 999,
  border: active ? "1px solid #1749D7" : "1px solid #ddd",
  background: active ? "#EAF1FF" : "#fff",
  color: "#0a2246",
  cursor: "pointer",
});

export const FloatingMoodChips: React.FC = () => {
  const { mood, setMood } = useMood();
  return (
    <div style={{ position: "fixed", right: 16, bottom: 16, background: "#fff", border: "1px solid #eee", borderRadius: 12, padding: 8, boxShadow: "0 6px 20px rgba(0,0,0,0.08)", zIndex: 40 }}>
      <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 6 }}>å¿ƒæƒ…</div>
      <div style={{ display: "flex", gap: 6 }}>
        <button onClick={() => setMood("neutral")} aria-label="ä»Šå¤©é‚„ä¸éŒ¯" style={chipStyle(mood === "neutral")}>ä»Šå¤©é‚„ä¸éŒ¯</button>
        <button onClick={() => setMood("stress")} aria-label="æœ‰é»ç´¯" style={chipStyle(mood === "stress")}>æœ‰é»ç´¯</button>
        <button onClick={() => setMood("rest")} aria-label="æƒ³æ”¾ç©º" style={chipStyle(mood === "rest")}>æƒ³æ”¾ç©º</button>
      </div>
    </div>
  );
};

=== src/services/ai.ts ===
import { isQuietActiveFromStorage } from "../context/QuietModeContext";
import { loadProfile } from "../stores/profileStore";

type ChatMessage = { role: "system" | "user" | "assistant"; content: string };

const SYS_DEFAULT =
  "ä½ æ˜¯é‚æˆ¿å­çš„åœ¨åœ°å¥½é„°å±…åŠ©ç†ï¼ˆæš±ç¨±ï¼šé‚é‚ï¼‰ã€‚èªæ°£æº«æš–ã€å°Šé‡ï¼Œå°ç£èªå¢ƒã€‚å›è¦†â‰¤2è¡Œï¼Œå…ˆåŒç†å†è³‡è¨Šï¼Œé¿å…æ¨éŠ·èªã€‚";
const SYS_ZEN =
  "ä½ æ˜¯é‚é‚ã€‚ä½¿ç”¨è€…å•Ÿç”¨å®‰éœæ¨¡å¼ï¼Œç¾åœ¨åªæƒ³è¢«é™ªä¼´ã€‚100% å‚¾è½èˆ‡åŒç†ï¼Œå›è¦† 1â€“2 å¥ï¼›åš´ç¦ä¸»å‹•æ¨è–¦ä»»ä½•æˆ¿æº/ç¤¾å€/å»£å‘Šã€‚";

function composeSystemPrompt(): string {
  const isZen = isQuietActiveFromStorage();
  const mood = (localStorage.getItem("mai-mood-v1") as "neutral" | "stress" | "rest") || "neutral";
  const profile = loadProfile();
  const tags = (profile.tags || []).slice(0, 5);

  const tone =
    mood === "stress"
      ? "åµæ¸¬åˆ°å°æ–¹å£“åŠ›è¼ƒå¤§ï¼šé™ä½è³‡è¨Šé‡ã€é¿å…æŒ‡ç¤ºèªã€ç”¨å®‰æ’«å£å»ã€‚"
      : mood === "rest"
      ? "å°æ–¹æƒ³æ”¾é¬†ï¼šå¯ä»¥è¼•é¬†ã€æº«æš–åœ°èŠå¤©ï¼Œä¸å¿…æ€¥è‘—æä¾›å»ºè­°ã€‚"
      : "ä¿æŒå‹å–„ã€æ¸…æ™°çš„èªæ°£ã€‚";

  const memory = tags.length ? `ä½¿ç”¨è€…åœ¨æ„ï¼š${tags.join("ã€")}ã€‚æœªè¢«è©¢å•æ™‚ä¸è¦ä¸»å‹•æ¨ä»»ä½•æ¸…å–®ï¼Œä½†å¯åœ¨ç›¸é—œè©±é¡Œå‡ºç¾æ™‚è¼•æŸ”æ‰¿æ¥ã€‚` : "";

  return [
    isZen ? SYS_ZEN : SYS_DEFAULT,
    tone,
    memory,
    "æ‰€æœ‰è¼¸å‡ºéœ€ç°¡æ½”ã€çœŸèª ï¼Œæ‹’çµ•éŠ·å”®è©±è¡“ã€‚",
  ].filter(Boolean).join("\n");
}

export async function postLLM(messages: ChatMessage[], options?: { temperature?: number; max_tokens?: number }) {
  const res = await fetch("/api/openai-proxy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      messages: [
        { role: "system", content: composeSystemPrompt() },
        ...messages
      ],
      temperature: options?.temperature ?? 0.7,
      max_tokens: options?.max_tokens ?? 300
    }),
  });
  if (!res.ok) {
    throw new Error(`LLM proxy error: ${res.status}`);
  }
  const data = await res.json();
  const text = data?.choices?.[0]?.message?.content ?? "";
  return text as string;
}

export async function politeRewrite(draft: string, opts?: { audience?: "owner" | "agent"; intent?: "view" | "detail" | "pet" | "price" }) {
  const who = opts?.audience === "owner" ? "å±‹ä¸»" : "ä»²ä»‹";
  const why = (() => {
    switch (opts?.intent) {
      case "view": return "é ç´„çœ‹æˆ¿";
      case "detail": return "è©¢å•ç‰©ä»¶ç´°ç¯€";
      case "pet": return "ç¢ºèªæ˜¯å¦å¯é¤Šå¯µç‰©";
      case "price": return "è©¢å•åƒ¹æ ¼èˆ‡è­°åƒ¹ç©ºé–“";
      default: return "ä¸€èˆ¬è©¢å•";
    }
  })();
  const prompt = `è«‹å°‡ä»¥ä¸‹è¨Šæ¯æ”¹å¯«æˆã€Œç¦®è²Œã€ç°¡çŸ­ã€å°Šé‡ã€çš„å…©å€‹ç‰ˆæœ¬ï¼ˆV1/V2ï¼‰ï¼Œæƒ…å¢ƒï¼šè¦ç™¼çµ¦ã€Œ${who}ã€ï¼Œç›®çš„ï¼šã€Œ${why}ã€ã€‚ç¶­æŒåŸæ„ï¼Œé¿å…å‘½ä»¤èªï¼š\n---\n${draft}\n---\næ ¼å¼ï¼š\nV1ï¼š...\nV2ï¼š...`;
  return postLLM([{ role: "user", content: prompt }], { max_tokens: 220 });
}

export async function empathicEcho(note: string) {
  const prompt = `ä»¥ä¸‹æ˜¯ä¸€æ®µå°ç‰©ä»¶çš„ä¸»è§€æ„Ÿå—ï¼Œè«‹ä»¥åŒç†çš„èªæ°£å›è²ï¼Œåƒ… 1â€“2 å¥ã€é¿å…å»ºè­°ï¼š\nã€Œ${note}ã€`;
  return postLLM([{ role: "user", content: prompt }], { max_tokens: 80 });
}

export async function eli5Term(termOrPara: string) {
  const prompt = `è«‹ç”¨ç™½è©±ã€éæ³•å¾‹æ„è¦‹çš„æ–¹å¼è§£é‡‹é€™æ®µåè©/æ¢æ¬¾ï¼Œåˆ—å‡ºã€Œé‡é»ã€èˆ‡ã€Œæ³¨æ„ã€å„1â€“2é»ï¼Œç¸½é•·â‰¤2è¡Œï¼š\n${termOrPara}`;
  return postLLM([{ role: "user", content: prompt }], { max_tokens: 120 });
}

export async function debriefToMNA(like: string, pain: string, next: string) {
  const prompt = `æˆ‘çœ‹å®Œä¸€é–“æˆ¿ï¼Œè«‹æŠŠé‡é»åˆ†æˆã€Œå¿…è¦(Must)ã€ã€ŒåŠ åˆ†(Nice)ã€ã€Œä¸è¦(Avoid)ã€å„2â€“3é»ï¼Œç¸½é•·â‰¤2è¡Œï¼›ä¸¦åœ¨æœ€å¾Œä¸€è¡Œè¼¸å‡º #tags: ä»¥é€—è™Ÿåˆ†éš” 3â€“5 å€‹é—œéµå­—ï¼ˆé¿å…äººå/å“ç‰Œï¼‰ã€‚\nå–œæ­¡ï¼š${like}\nå›°æ“¾ï¼š${pain}\nä¸‹ä¸€æ­¥ï¼š${next}`;
  return postLLM([{ role: "user", content: prompt }], { max_tokens: 160 });
}

=== src/components/ELI5Tooltip.tsx ===
import React, { useEffect, useState } from "react";
import { eli5Term } from "../services/ai";
import { Events, track } from "../analytics/track";

const KEYWORDS = ["æŒåˆ†", "ä½¿ç”¨åˆ†å€", "å…¬è¨­æ¯”", "åœ°ä¸Šæ¬Š", "éƒ½æ›´", "å®¹ç©ç‡"];

export const ELI5Tooltip: React.FC<{ text: string }> = ({ text }) => {
  const [open, setOpen] = useState(false);
  const [ans, setAns] = useState<string>("");
  const [loading, setLoading] = useState(false);

  const fetchAns = async () => {
    if (ans) return;
    setLoading(true);
    try {
      const out = await eli5Term(text);
      setAns(out);
      track(Events.ELI5Open, { term: text });
    } finally {
      setLoading(false);
    }
  };

  // æ¯æ—¥ä¸€æ¬¡çš„ã€Œä¸»å‹•å»ºè­°ã€ï¼šé‡åˆ°é—œéµè©è‡ªå‹•é–‹å•Ÿ
  useEffect(() => {
    const today = new Date().toISOString().slice(0,10);
    const k = `mai-eli5-suggest-${today}`;
    const shouldSuggest = KEYWORDS.some(w => text.includes(w)) && !localStorage.getItem(k);
    if (shouldSuggest) {
      localStorage.setItem(k, "1");
      setOpen(true);
      fetchAns();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const toggle = async () => {
    const next = !open;
    setOpen(next);
    if (next) await fetchAns();
  };

  return (
    <span style={{ display: "inline-flex", alignItems: "center", position: "relative" }}>
      <button aria-label="ç™½è©±è§£é‡‹" onClick={toggle} style={{ marginLeft: 6, width: 18, height: 18, borderRadius: 999, border: "1px solid #C9D5FF", background: "#F5F8FF", color: "#1749D7", fontSize: 12, cursor: "pointer" }}>?</button>
      {open && (
        <div style={{ position: "absolute", top: "120%", left: 0, background: "#fff", border: "1px solid #E6ECFF", borderRadius: 8, padding: 10, width: 280, boxShadow: "0 10px 24px rgba(0,0,0,0.08)", zIndex: 50 }}>
          <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 6 }}>ç™½è©±è§£é‡‹ï¼ˆåƒ…ä¾›åƒè€ƒï¼Œéæ³•å¾‹æ„è¦‹ï¼‰</div>
          <div style={{ whiteSpace: "pre-wrap" }}>{loading ? "ç”Ÿæˆä¸­â€¦" : ans}</div>
        </div>
      )}
    </span>
  );
};

=== src/components/BudgetLite.tsx ===
import React, { useMemo, useState } from "react";
import { Events, track } from "../analytics/track";

function calcMonthlyPayment(principal: number, annualRate: number, years: number) {
  const r = annualRate / 12 / 100;
  const n = years * 12;
  if (r === 0) return principal / n;
  return (principal * r) / (1 - Math.pow(1 + r, -n));
}

export const BudgetLite: React.FC = () => {
  const [total, setTotal] = useState<number>(1500);
  const [down, setDown] = useState<number>(30);
  const [rate, setRate] = useState<number>(2.25);
  const [years, setYears] = useState<number>(20);
  const [income, setIncome] = useState<number | "">("");

  const principal = useMemo(() => Math.max(0, total * (1 - down / 100)), [total, down]);
  const monthly = useMemo(() => Math.round(calcMonthlyPayment(principal * 10000, rate, years)), [principal, rate, years]); // å‡è¨­å–®ä½è¬å…ƒ
  const mgmt = 3000; // å¯èª¿

  const burden = useMemo(() => {
    if (typeof income !== "number" || income <= 0) return null;
    return Math.round((monthly + mgmt) / income * 100);
  }, [income, monthly]);

  const onCopy = () => {
    const text = `æ¦‚ç®—ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ï¼š\nç¸½åƒ¹${total}è¬ï¼Œé ­æœŸ${down}% â†’ è²¸æ¬¾ç´„${principal.toFixed(0)}è¬ï¼›${years}å¹´åˆ©ç‡${rate}% â†’ æœˆä»˜ç´„ ${monthly} å…ƒï¼›ç®¡ç†è²»ç´„ ${mgmt} å…ƒã€‚` + (burden !== null ? `\næœˆè² æ“”ç‡ç´„ ${burden}%ï¼ˆå«ç®¡ç†è²»ï¼‰ã€‚` : "");
    navigator.clipboard.writeText(text).then(() => track(Events.BudgetCopy, {}));
  };

  const warmTip = (() => {
    if (burden === null) return "é€™å€‹æ•¸å­—åƒ…ä¾›åƒè€ƒï¼Œåˆ¥çµ¦è‡ªå·±å¤ªå¤§å£“åŠ›ã€‚";
    if (burden >= 50) return "è² æ“”ç‡åé«˜äº†ï¼Œå…ˆåˆ¥æ€¥è‘—æ±ºå®šï¼›æˆ‘å€‘å¯ä»¥è¨è«–æ›´æœ‰å½ˆæ€§çš„åšæ³•ã€‚";
    if (burden >= 35) return "è² æ“”ç‡æœ‰é»é«˜ï¼Œå¯å†çœ‹çœ‹åœ°é»/å¹´é™çš„æ¬Šè¡¡ã€‚";
    return "çœ‹èµ·ä¾†åœ¨å¯æ¥å—ç¯„åœå…§ï¼Œä½†ä»å»ºè­°ä¿ç•™å½ˆæ€§ã€‚";
  })();

  return (
    <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 12, background: "#fff" }}>
      <div style={{ fontWeight: 600, marginBottom: 8 }}>é ç®—è¦åŠƒï¼ˆLiteï¼‰</div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(5,1fr)", gap: 8 }}>
        <label>ç¸½åƒ¹(è¬)<input type="number" value={total} onChange={e => setTotal(Number(e.target.value))} style={{ width: "100%", padding: 6, borderRadius: 8, border: "1px solid #ddd" }} /></label>
        <label>é ­æœŸ(%)<input type="number" value={down} onChange={e => setDown(Number(e.target.value))} style={{ width: "100%", padding: 6, borderRadius: 8, border: "1px solid #ddd" }} /></label>
        <label>åˆ©ç‡(%)<input type="number" value={rate} onChange={e => setRate(Number(e.target.value))} style={{ width: "100%", padding: 6, borderRadius: 8, border: "1px solid #ddd" }} /></label>
        <label>å¹´é™<input type="number" value={years} onChange={e => setYears(Number(e.target.value))} style={{ width: "100%", padding: 6, borderRadius: 8, border: "1px solid #ddd" }} /></label>
        <label>æœˆæ”¶å…¥(å¯é¸)<input type="number" value={typeof income === "number" ? income : ""} onChange={e => { const v = Number(e.target.value); setIncome(Number.isFinite(v) ? v : ""); }} style={{ width: "100%", padding: 6, borderRadius: 8, border: "1px solid #ddd" }} /></label>
      </div>
      <div style={{ marginTop: 10, fontSize: 14, color: "#0a2246" }}>
        æ¦‚ç®—ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ï¼šæœˆä»˜ç´„ <b>{monthly.toLocaleString()}</b> å…ƒï¼›è²¸æ¬¾æœ¬é‡‘ç´„ <b>{principal.toFixed(0)}</b> è¬ã€‚
        {burden !== null && <>ã€€ï½œã€€æœˆè² æ“”ç‡ç´„ <b>{burden}%</b>ï¼ˆå«ç®¡ç†è²»ï¼‰</>}
      </div>
      <div style={{ marginTop: 8, color: "#6b7280" }}>{warmTip}</div>
      <button onClick={onCopy} style={{ marginTop: 8, padding: "6px 10px", borderRadius: 8, border: "1px solid #1749D7", background: "#fff", color: "#1749D7" }}>è¤‡è£½æ¦‚ç®—æ¨¡æ¿</button>
    </div>
  );
};

=== src/stores/notesStore.ts ===
export type NoteItem = {
  id: string;
  createdAt: number;
  note: string;
  echo?: string;
};
const KEY = "mai-notes-v1";
function loadAll(): NoteItem[] {
  try {
    const raw = localStorage.getItem(KEY);
    if (!raw) return [];
    return JSON.parse(raw) as NoteItem[];
  } catch {
    return [];
  }
}
function saveAll(items: NoteItem[]) {
  localStorage.setItem(KEY, JSON.stringify(items));
}
export function addNote(note: string, echo?: string): NoteItem {
  const items = loadAll();
  const item: NoteItem = {
    id: Math.random().toString(36).slice(2),
    createdAt: Date.now(),
    note,
    echo,
  };
  items.unshift(item);
  saveAll(items);
  return item;
}
export function listNotes(): NoteItem[] { return loadAll(); }
export function clearNotes() { saveAll([]); }

=== src/components/NoteWithEcho.tsx ===
import React, { useState } from "react";
import { empathicEcho } from "../services/ai";
import { addNote } from "../stores/notesStore";
import { Events, track } from "../analytics/track";

export const NoteWithEcho: React.FC = () => {
  const [text, setText] = useState("");
  const [echo, setEcho] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [focused, setFocused] = useState(false);

  const handleSave = async () => {
    const v = text.trim();
    if (!v) return;
    setLoading(true);
    try {
      const echoText = await empathicEcho(v);
      setEcho(echoText);
      addNote(v, echoText);
      track(Events.NoteSaved, {});
    } catch (e) {
      addNote(v);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 12, background: "#fff" }}>
      <div style={{ fontWeight: 600, marginBottom: 6 }}>æ”¶è—å‚™è¨»ï¼ˆæ„Ÿå—ï¼‰</div>
      <textarea
        rows={3}
        placeholder="å¯«ä¸‹é€™é–“å¸¶çµ¦ä½ çš„æ„Ÿè¦ºâ€¦"
        value={text}
        onChange={(e) => setText(e.target.value)}
        onFocus={() => setFocused(true)}
        onBlur={() => setFocused(false)}
        style={{ width: "100%", padding: 8, borderRadius: 8, border: "1px solid #ddd" }}
      />
      {focused && <div style={{ fontSize: 12, color: "#6b7280", marginTop: 4 }}>æ…¢æ…¢å¯«ï¼Œæˆ‘åœ¨ã€‚</div>}
      <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
        <button onClick={handleSave} disabled={loading} style={{ padding: "8px 12px", borderRadius: 8, background: "#1749D7", color: "#fff", border: "1px solid #1749D7" }}>
          {loading ? "ç”Ÿæˆä¸­â€¦" : "å­˜å…¥ä¾¿æ¢ï¼ˆå«å›è²ï¼‰"}
        </button>
        {echo && <span style={{ color: "#6b7280" }}>AI å›è²ï¼š{echo}</span>}
      </div>
    </div>
  );
};

=== src/components/PoliteRewrite.tsx ===
import React, { useState } from "react";
import { politeRewrite } from "../services/ai";
import { Events, track } from "../analytics/track";

export const PoliteRewrite: React.FC<{ onAdopt?: (text: string) => void }> = ({ onAdopt }) => {
  const [draft, setDraft] = useState("");
  const [audience, setAudience] = useState<"owner" | "agent">("agent");
  const [intent, setIntent] = useState<"view" | "detail" | "pet" | "price">("detail");
  const [v1, setV1] = useState<string | null>(null);
  const [v2, setV2] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [sent, setSent] = useState(false);

  const handleRewrite = async () => {
    const d = draft.trim();
    if (!d) return;
    setLoading(true);
    try {
      const out = await politeRewrite(d, { audience, intent });
      const m = out.split(/\n+/).map(s => s.trim()).filter(Boolean);
      const a = m.find(x => /^V1/.test(x)) || "";
      const b = m.find(x => /^V2/.test(x)) || "";
      setV1(a.replace(/^V1[:ï¼š]\s?/, ""));
      setV2(b.replace(/^V2[:ï¼š]\s?/, ""));
      track(Events.RewriteGen, { audience, intent });
    } finally {
      setLoading(false);
    }
  };

  const adopt = (text: string) => {
    onAdopt?.(text);
    setSent(true);
    track(Events.RewriteAdopt, { audience, intent });
    setTimeout(() => setSent(false), 2500);
  };

  return (
    <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 12, background: "#fff" }}>
      <div style={{ fontWeight: 600, marginBottom: 6 }}>ç¦®è²Œæ”¹å¯«å°å¹«æ‰‹</div>
      <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 8 }}>
        <label>å°è±¡
          <select value={audience} onChange={e => setAudience(e.target.value as any)} style={{ marginLeft: 6, padding: 6, borderRadius: 8, border: "1px solid #ddd" }}>
            <option value="agent">ä»²ä»‹</option>
            <option value="owner">å±‹ä¸»</option>
          </select>
        </label>
        <label>ç›®çš„
          <select value={intent} onChange={e => setIntent(e.target.value as any)} style={{ marginLeft: 6, padding: 6, borderRadius: 8, border: "1px solid #ddd" }}>
            <option value="detail">è©¢å•ç´°ç¯€</option>
            <option value="view">é ç´„çœ‹æˆ¿</option>
            <option value="pet">å¯å¦é¤Šå¯µç‰©</option>
            <option value="price">åƒ¹æ ¼/è­°åƒ¹</option>
          </select>
        </label>
      </div>
      <textarea
        rows={3}
        placeholder="è²¼ä¸Šä½ æƒ³ç™¼çš„è¨Šæ¯ï¼ˆæˆ‘æœƒæ ¹æ“šå°è±¡/ç›®çš„å¹«ä½ æ½¤é£¾ï¼‰"
        value={draft}
        onChange={(e) => setDraft(e.target.value)}
        style={{ width: "100%", padding: 8, borderRadius: 8, border: "1px solid #ddd" }}
      />
      <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
        <button onClick={handleRewrite} disabled={loading} style={{ padding: "8px 12px", borderRadius: 8, background: "#1749D7", color: "#fff", border: "1px solid #1749D7" }}>
          {loading ? "ç”Ÿæˆä¸­â€¦" : "ç¦®è²Œæ”¹å¯«"}
        </button>
      </div>
      {(v1 || v2) && (
        <div style={{ marginTop: 10, display: "grid", gap: 8 }}>
          {v1 && (
            <div style={{ border: "1px solid #E6ECFF", borderRadius: 8, padding: 8 }}>
              <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 4 }}>ç‰ˆæœ¬ä¸€</div>
              <div style={{ marginBottom: 6 }}>{v1}</div>
              <button onClick={() => adopt(v1)} style={{ padding: "6px 10px", borderRadius: 8, border: "1px solid #1749D7", background: "#fff", color: "#1749D7" }}>æ¡ç”¨ï¼ˆè¤‡è£½/é€å‡ºï¼‰</button>
            </div>
          )}
          {v2 && (
            <div style={{ border: "1px solid #E6ECFF", borderRadius: 8, padding: 8 }}>
              <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 4 }}>ç‰ˆæœ¬äºŒ</div>
              <div style={{ marginBottom: 6 }}>{v2}</div>
              <button onClick={() => adopt(v2)} style={{ padding: "6px 10px", borderRadius: 8, border: "1px solid #1749D7", background: "#fff", color: "#1749D7" }}>æ¡ç”¨ï¼ˆè¤‡è£½/é€å‡ºï¼‰</button>
            </div>
          )}
          {sent && <div style={{ color: "#16a34a" }}>å·²æº–å‚™å¥½è¨Šæ¯ï¼Œç¥æºé€šé †åˆ© ğŸ¤</div>}
        </div>
      )}
    </div>
  );
};

=== src/components/DebriefMini.tsx ===
import React, { useState } from "react";
import { debriefToMNA } from "../services/ai";
import { addNote } from "../stores/notesStore";
import { upsertTags } from "../stores/profileStore";
import { Events, track } from "../analytics/track";

function parseTags(text: string): string[] {
  const m = text.split("\n").find(l => l.trim().startsWith("#tags"));
  if (!m) return [];
  const arr = m.replace(/^#tags\s*[:ï¼š]\s*/i, "").split(",").map(s => s.trim()).filter(Boolean);
  return arr.slice(0, 5);
}

export const DebriefMini: React.FC = () => {
  const [like, setLike] = useState("");
  const [pain, setPain] = useState("");
  const [next, setNext] = useState("");
  const [out, setOut] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleGen = async () => {
    setLoading(true);
    try {
      const text = await debriefToMNA(like, pain, next);
      setOut(text);
      const tags = parseTags(text);
      if (tags.length) upsertTags(tags);
      track(Events.DebriefGen, { tags });
    } finally {
      setLoading(false);
    }
  };

  const handleSave = () => {
    const md = `ã€çœ‹å±‹å°çµã€‘\nå–œæ­¡ï¼š${like}\nå›°æ“¾ï¼š${pain}\nä¸‹ä¸€æ­¥ï¼š${next}\n---\n${out ?? ""}`;
    addNote(md);
    track(Events.DebriefSave, {});
  };

  return (
    <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 12, background: "#fff" }}>
      <div style={{ fontWeight: 600, marginBottom: 6 }}>çœ‹å±‹å¾Œä¸‰å•ï¼ˆMini Debriefï¼‰</div>
      <div style={{ display: "grid", gap: 8 }}>
        <input value={like} onChange={e => setLike(e.target.value)} placeholder="ç¬¬ä¸€ç›´è¦ºå¦‚ä½•ï¼Ÿï¼ˆä¾‹ï¼šæ¡å…‰å¾ˆå¥½ï¼‰" style={{ padding: 8, borderRadius: 8, border: "1px solid #ddd" }} />
        <input value={pain} onChange={e => setPain(e.target.value)} placeholder="å“ªè£¡å¡å¡çš„ï¼Ÿï¼ˆä¾‹ï¼šå»šæˆ¿å¤ªå°ï¼‰" style={{ padding: 8, borderRadius: 8, border: "1px solid #ddd" }} />
        <input value={next} onChange={e => setNext(e.target.value)} placeholder="ä¸‹ä¸€æ­¥æƒ³åšä»€éº¼ï¼Ÿï¼ˆä¾‹ï¼šå†çœ‹ä¸€é–“å°æ¯”ï¼‰" style={{ padding: 8, borderRadius: 8, border: "1px solid #ddd" }} />
      </div>
      <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
        <button onClick={handleGen} disabled={loading} style={{ padding: "8px 12px", borderRadius: 8, background: "#1749D7", color: "#fff", border: "1px solid #1749D7" }}>
          {loading ? "æ•´ç†ä¸­â€¦" : "ç”Ÿæˆ Must/Nice/Avoid + #tags"}
        </button>
        {out && <button onClick={handleSave} style={{ padding: "8px 12px", borderRadius: 8, border: "1px solid #1749D7", background: "#fff", color: "#1749D7" }}>å­˜åˆ°ä¾¿æ¢</button>}
      </div>
      {out && <div style={{ marginTop: 10, whiteSpace: "pre-wrap", color: "#0a2246" }}>{out}</div>}
    </div>
  );
};

=== src/components/chat/ChatInput.tsx ===
import React, { useEffect, useRef, useState } from "react";
import { useQuietMode } from "../../context/QuietModeContext";
import { Events, track } from "../../analytics/track";

type Props = { onSend: (text: string) => Promise<void> | void; };

export const ChatInput: React.FC<Props> = ({ onSend }) => {
  const { isActive, decrementTurn } = useQuietMode();
  const [text, setText] = useState("");
  const inputRef = useRef<HTMLInputElement | null>(null);

  useEffect(() => {
    const handler = (e: Event) => {
      const ce = e as CustomEvent<{ text?: string }>;
      const seed = ce.detail?.text || "";
      if (seed) {
        setText(seed);
        inputRef.current?.focus();
        track("ui.warmbar_prefill", { from: "warmbar" });
      }
    };
    window.addEventListener("mai:chat:start", handler as EventListener);
    return () => window.removeEventListener("mai:chat:start", handler as EventListener);
  }, []);

  const handleSend = async () => {
    const msg = text.trim();
    if (!msg) return;
    setText("");
    try {
      await onSend(msg);
    } finally {
      if (isActive()) {
        decrementTurn();
        track(Events.QuietTurnUsed, {});
      }
    }
  };

  return (
    <div style={{ display: "flex", gap: 8 }}>
      <input
        ref={inputRef}
        value={text}
        onChange={(e) => setText(e.target.value)}
        placeholder={isActive() ? "å®‰éœæ¨¡å¼ï¼šåªèŠå¤©ï¼Œä¸æ¨å…§å®¹" : "è¼¸å…¥è¨Šæ¯â€¦"}
        style={{ flex: 1, padding: "10px 12px", borderRadius: 10, border: "1px solid #ddd" }}
        onKeyDown={(e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleSend();
          }
        }}
      />
      <button onClick={handleSend} style={{ padding: "8px 12px", borderRadius: 10, background: "#1749D7", color: "#fff", border: "1px solid #1749D7" }}>
        ç™¼é€
      </button>
    </div>
  );
};

=== src/components/index.ts ===
export * from "./QuietBanner";
export * from "./QuietModeToggle";
export * from "./WarmWelcomeBar";
export * from "./MoodChips";
export * from "./NoteWithEcho";
export * from "./PoliteRewrite";
export * from "./ELI5Tooltip";
export * from "./BudgetLite";
export * from "./DebriefMini";
