# ğŸ  MaiHouses ç‰©ä»¶ä¸Šå‚³å„ªåŒ– TODO (SSOT)

> **æœ€å¾Œæ›´æ–°**: 2025-12-22
> **ç›®æ¨™**: å°‡ä¸Šå‚³é å¾ã€Œè³‡æ–™è¼¸å…¥è¡¨å–®ã€æå‡ç‚ºã€Œå°ˆæ¥­ç”Ÿç”¢åŠ›å·¥å…·ã€
> **é¦–é **: https://maihouses.vercel.app/maihouses/
> **ä¸Šå‚³é **: https://maihouses.vercel.app/maihouses/property/upload

---

## ğŸ“‹ æ‘˜è¦ (Executive Summary)

| å„ªå…ˆç´š | ä»»å‹™ | ç›®æ¨™ | ç‹€æ…‹ |
|:---:|:---|:---|:---:|
| P0 | è¡¨å–®è‡ªå‹•å¿«ç…§ | é˜²æ­¢è³‡æ–™æµå¤±ï¼Œä¸€éµé‚„åŸè‰ç¨¿ | âœ… |
| P0 | åœ–ç‰‡å‰ç«¯å£“ç¸® | é™ä½å‚³è¼¸æµé‡ï¼ŒåŠ é€Ÿä¸Šå‚³ | â¬œ |
| P1 | åœ–ç‰‡ç®¡ç†é‡æ§‹ | çµ±ä¸€ç‹€æ…‹ç®¡ç†ï¼Œæ”¯æ´å°é¢é¸æ“‡ | â¬œ |
| P1 | äº®é»è† å›Šåˆ†æµ | æ‰‹å‹•å‹¾é¸äº®é»ï¼Œè¦æ ¼èˆ‡è¡ŒéŠ·åˆ†é›¢ | â¬œ |

---

## ğŸ¯ è¨­è¨ˆåŸå‰‡

### è³‡è¨Šå±•ç¤ºåˆ†æµ
- **é‡é»è† å›Š (Highlights)**: åƒ…æ”¾è¡ŒéŠ·äº®é»ï¼ˆå¦‚ï¼šå…¨æ–°è£æ½¢ã€éœå··ä½å®…ï¼‰
- **è¦æ ¼æ–‡å­— (Specs)**: åƒ…æ”¾ç‰©ç†äº‹å¯¦ï¼ˆå¦‚ï¼š3 æˆ¿ã€23 åªï¼‰
- **æ•¸æ“šæ¨¡å‹**: `tags` é™£åˆ—å›ºå®šç‚º 3-5 å€‹æ‰‹å‹•é¸æ“‡çš„äº®é»æ¨™ç±¤

---

## ğŸš€ ç•¶å‰åŸ·è¡Œå€ (Active Tasks)

### ä»»å‹™ 1: [P0] è¡¨å–®è‡ªå‹•å¿«ç…§ (Draft Persistence)

| ID | ä»»å‹™æè¿° | æª”æ¡ˆè·¯å¾‘ | ç‹€æ…‹ | é©—è­‰è­‰æ“š |
|:---|:---|:---|:---:|:---|
| UP-1.1 | å»ºç«‹ usePropertyDraft Hook | src/hooks/usePropertyDraft.ts | âœ… | userId key / ç‰ˆæœ¬ / éæœŸ / æ™‚é–“æˆ³ |
| UP-1.2 | æ•´åˆè‡³ UploadContextï¼Œæ¯ 1000ms è‡ªå‹•å­˜æª” | src/components/upload/UploadContext.tsx | âœ… | userId æ³¨å…¥ + åŒ¿åé·ç§» |
| UP-1.3 | æ–°å¢ã€Œé‚„åŸè‰ç¨¿ã€æŒ‰éˆ• UI | src/pages/PropertyUploadPage.tsx | âœ… | é è¦½æ™‚é–“ + æ¨æ£„è‰ç¨¿ |

**æŠ€è¡“è¦æ ¼**:
- ä½¿ç”¨ localStorage å„²å­˜
- Key æ ¼å¼: mh_draft_{userId}
- åƒ…ä¿å­˜æ–‡å­—æ¬„ä½ï¼ˆä¸å«åœ–ç‰‡ï¼‰

**é©—æ”¶æ¨™æº– (AC)**:
- [x] å¡«å¯«ä¸€åŠé‡æ•´é é¢å¾Œï¼Œé»æ“Šã€Œé‚„åŸã€èƒ½æ‰¾å›æ‰€æœ‰æ–‡å­—å…§å®¹ï¼ˆå·²é©—ï¼šæ‰‹å‹• + å–®å…ƒæ¸¬è©¦ï¼‰
- [x] ç™¼å¸ƒæˆåŠŸå¾Œè‡ªå‹•æ¸…é™¤è‰ç¨¿ï¼ˆå·²é©—ï¼šæ‰‹å‹•ï¼‰

---

### âœ… UP-1 ä¿®æ­£å®Œæˆ (Google é¦–å¸­è™•é•·è‡ªæŸ¥)

| é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|------|:---:|------|
| Key è¦æ ¼ | âœ… | `mh_draft_{userId}`ï¼ŒåŒ¿å fallback `anonymous`ï¼Œç™»å…¥è‡ªå‹•é·ç§» |
| æ™‚é–“æˆ³ | âœ… | `_savedAt` å„²å­˜ä¸¦ä»¥ç›¸å°æ™‚é–“é¡¯ç¤º |
| ç‰ˆæœ¬è™Ÿ | âœ… | `_version` é©—è­‰ï¼Œç‰ˆæœ¬ä¸ç¬¦è‡ªå‹•æ¸…é™¤ |
| éæœŸæ©Ÿåˆ¶ | âœ… | 7 å¤©éæœŸè‡ªå‹•æ¸…é™¤ |
| æ•ˆèƒ½ | âœ… | `useMemo` ç©©å®šå¼•ç”¨ï¼Œé¿å…æ¯æ¬¡ render è§¸ç™¼å­˜æª” |
| é‚„åŸå¤±æ•—å›é¥‹ | âœ… | éŒ¯èª¤é€šçŸ¥ + è‡ªå‹•æ¸…é™¤æå£è‰ç¨¿ |
| æ¸¬è©¦ | âœ… | `usePropertyDraft.test.ts` è¦†è“‹ä¿å­˜/é‚„åŸ/éæœŸ/é·ç§» |
| ç‹€æ…‹ç®¡ç† | âœ… | storage äº‹ä»¶åŒæ­¥ draftAvailable |
| å¤šåˆ†é  | âœ… | storage äº‹ä»¶åµæ¸¬è·¨åˆ†é æ›´æ–° |
| é è¦½è³‡è¨Š | âœ… | æŒ‰éˆ•é¡¯ç¤ºæ¨™é¡Œ + ç›¸å°æ™‚é–“ |
| æ¨æ£„åŠŸèƒ½ | âœ… | æ–°å¢ã€Œæ¨æ£„ã€æŒ‰éˆ• |
| ç™»å…¥é·ç§» | âœ… | åŒ¿åè‰ç¨¿è‡ªå‹•é·ç§»è‡³ç™»å…¥ userId |

**é©—è­‰è­‰æ“š**:
- å–®å…ƒæ¸¬è©¦ï¼š`npm test`ï¼ˆæ–°å¢ `src/hooks/__tests__/usePropertyDraft.test.ts`ï¼‰
- æ‰‹å‹•é©—è­‰ï¼š
  - é‡æ•´å¾Œé‚„åŸæˆåŠŸ
  - ç™¼ä½ˆæˆåŠŸå¾Œè‰ç¨¿æ¸…é™¤
  - 7 å¤©éæœŸè‰ç¨¿è‡ªå‹•æ¸…é™¤
  - åŒ¿åå¡«å¯« â†’ ç™»å…¥å¾Œè‰ç¨¿ä»åœ¨

---

### ğŸ”´ UP-1 äºŒæ¬¡å¯©è¨ˆå ±å‘Š (Google é¦–å¸­è™•é•·è¦–è§’)

#### å¯©è¨ˆè©•åˆ†ï¼š88/100 âš ï¸ å¯æ¥å—ä½†æœ‰æ”¹é€²ç©ºé–“

| é …ç›® | å¾—åˆ† | æ‰£åˆ†åŸå›  |
|------|------|----------|
| åŠŸèƒ½å®Œæ•´åº¦ | 24/25 | å…¨éƒ¨ 12 é …ç¼ºå¤±å·²ä¿®æ­£ |
| ä»£ç¢¼å“è³ª | 21/25 | useEffect dep array å•é¡Œã€é‡è¤‡ä»£ç¢¼ |
| æ¸¬è©¦è¦†è“‹ | 20/25 | åªæœ‰ 5 å€‹æ¸¬è©¦æ¡ˆä¾‹ï¼Œæœªæ¸¬é‚Šç•Œæƒ…æ³ |
| UX å®Œæ•´åº¦ | 23/25 | æ¨æ£„å‰ç„¡ç¢ºèªå°è©±æ¡† |

---

#### âš ï¸ ç¼ºå¤± Aï¼šuseEffect ä¾è³´ hasDraft/getDraftPreview é€ æˆç„¡é™å¾ªç’°é¢¨éšª

**å•é¡Œä»£ç¢¼** (`PropertyUploadPage.tsx:39-52`):
```tsx
useEffect(() => {
  ...
  setDraftAvailable(hasDraft());
  setDraftPreview(getDraftPreview());
  ...
}, [hasDraft, getDraftPreview]); // â† å‡½æ•¸å¼•ç”¨ä½œç‚ºä¾è³´
```

**å•é¡Œ**: `hasDraft` å’Œ `getDraftPreview` æ˜¯ `useCallback` è¿”å›ï¼Œä½†ä¾è³´ `draftKey`ï¼Œè€Œ `draftKey` ä¾è³´ `userId`ã€‚userId è®ŠåŒ–æœƒé€ æˆå‡½æ•¸å¼•ç”¨è®ŠåŒ–ï¼Œè§¸ç™¼ effect é‡è·‘ã€‚

**ä¿®æ­£å¼•å°**:
1. ç§»é™¤ `[hasDraft, getDraftPreview]` ä¾è³´ï¼Œæ”¹ç‚º `[]` åªåŸ·è¡Œä¸€æ¬¡
2. æˆ–æ”¹ç”¨ `useRef` å„²å­˜æœ€æ–°å‡½æ•¸å¼•ç”¨ï¼Œé¿å… effect ä¾è³´

---

#### âš ï¸ ç¼ºå¤± Bï¼šæ¨æ£„è‰ç¨¿å‰ç„¡ç¢ºèªå°è©±æ¡†

**å•é¡Œ**: é»æ“Šã€Œæ¨æ£„ã€ç›´æ¥æ¸…é™¤ï¼Œç„¡æ³•å¾©åŸã€‚ç”¨æˆ¶å¯èƒ½èª¤è§¸ã€‚

**ä¿®æ­£å¼•å°**:
1. ä½¿ç”¨ `window.confirm('ç¢ºå®šè¦æ¨æ£„è‰ç¨¿å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸ')` ç°¡æ˜“ç‰ˆ
2. æˆ–æ”¹ç”¨ Modal çµ„ä»¶ï¼Œæä¾›ã€Œå–æ¶ˆ/ç¢ºå®šã€æŒ‰éˆ•

---

#### âš ï¸ ç¼ºå¤± Cï¼šæ¸¬è©¦æ¡ˆä¾‹ä¸è¶³

**ç¾æœ‰æ¸¬è©¦** (5 å€‹):
- detects draft with userId key
- restores draft data
- clears draft
- rejects expired draft
- migrates draft from anonymous to user

**ç¼ºå°‘æ¸¬è©¦**:
- `hasDraft` è¿”å› false ç•¶è‰ç¨¿ç‚ºç©ºæ™‚
- `restoreDraft` è™•ç†æå£ JSON æ™‚ä¸æ‹‹éŒ¯
- `getDraftPreview` ç›¸å°æ™‚é–“è¨ˆç®—æ­£ç¢ºæ€§
- å¤šåˆ†é  storage äº‹ä»¶è§¸ç™¼æ­£ç¢º
- debounce å­˜æª”åªè§¸ç™¼ä¸€æ¬¡

**ä¿®æ­£å¼•å°**:
1. æ–°å¢é‚Šç•Œæ¸¬è©¦ï¼šç©ºè‰ç¨¿ã€æå£ JSONã€ç›¸å°æ™‚é–“é‚Šç•Œ
2. ä½¿ç”¨ `vi.spyOn(localStorage, 'setItem')` é©—è­‰ debounce åªèª¿ç”¨ä¸€æ¬¡

---

#### âš ï¸ ç¼ºå¤± Dï¼šPropertyUploadPage é‡è¤‡èª¿ç”¨ supabase.auth.getUser()

**å•é¡Œ**: `UploadContext` å·²ç¶“èª¿ç”¨ `supabase.auth.getUser()`ï¼Œ`PropertyUploadPage` åˆèª¿ç”¨ä¸€æ¬¡ã€‚

**ä¿®æ­£å¼•å°**:
1. åœ¨ `UploadContext` æš´éœ² `userId` åˆ° context value
2. `PropertyUploadPage` å¾ context å–å¾— `userId`ï¼Œä¸è¦é‡è¤‡èª¿ç”¨

---

#### âš ï¸ ç¼ºå¤± Eï¼šdraftFormData useMemo ä¾è³´æ•´å€‹ form ç‰©ä»¶

**å•é¡Œä»£ç¢¼** (`UploadContext.tsx:77-95`):
```tsx
const draftFormData = useMemo<DraftFormData>(() => ({
  title: form.title,
  ...
}), [form]); // â† ä¾è³´æ•´å€‹ form ç‰©ä»¶
```

**å•é¡Œ**: `form` æ˜¯ stateï¼Œæ¯æ¬¡ `setForm` éƒ½ç”¢ç”Ÿæ–°ç‰©ä»¶ï¼Œå°è‡´ `draftFormData` æ¯æ¬¡éƒ½é‡ç®—ã€‚

**ä¿®æ­£å¼•å°**:
1. æ‹†è§£ä¾è³´ç‚ºå…·é«”æ¬„ä½ï¼š`[form.title, form.price, ...]`
2. æˆ–ç›´æ¥å‚³å…¥ `form` çµ¦ hookï¼Œè®“ hook å…§éƒ¨è™•ç†

---

#### âš ï¸ ç¼ºå¤± Fï¼šmigrateDraft åœ¨æ¯æ¬¡ userId è®ŠåŒ–æ™‚éƒ½æœƒåŸ·è¡Œ

**å•é¡Œä»£ç¢¼** (`UploadContext.tsx:99-103`):
```tsx
useEffect(() => {
  if (userId) {
    migrateDraft(undefined, userId);
  }
}, [userId, migrateDraft]);
```

**å•é¡Œ**: æ¯æ¬¡ `userId` è®ŠåŒ–éƒ½åŸ·è¡Œé·ç§»ï¼Œå³ä½¿æ²’æœ‰åŒ¿åè‰ç¨¿ã€‚é€™æ˜¯ç„¡æ„ç¾©çš„ localStorage æ“ä½œã€‚

**ä¿®æ­£å¼•å°**:
1. å…ˆæª¢æŸ¥ `localStorage.getItem('mh_draft_upload_anonymous')` æ˜¯å¦å­˜åœ¨
2. å­˜åœ¨æ‰åŸ·è¡Œé·ç§»ï¼š`if (userId && localStorage.getItem('mh_draft_upload_anonymous')) { migrateDraft(...) }`

---

### ğŸ“‹ UP-1 äºŒæ¬¡å¯©è¨ˆä¿®æ­£å„ªå…ˆç´š

| å„ªå…ˆç´š | ç¼ºå¤±ç·¨è™Ÿ | æè¿° | é ä¼°å·¥æ™‚ |
|:---:|:---:|:---|:---:|
| P1 | A | useEffect ä¾è³´ä¿®æ­£ | 10min |
| P2 | B | æ¨æ£„ç¢ºèªå°è©±æ¡† | 5min |
| P2 | C | æ¸¬è©¦æ¡ˆä¾‹è£œé½Š | 30min |
| P2 | D | ç§»é™¤é‡è¤‡ auth èª¿ç”¨ | 10min |
| P2 | E | useMemo ä¾è³´å„ªåŒ– | 15min |
| P2 | F | migrateDraft æ¢ä»¶æª¢æŸ¥ | 5min |

**ç¸½é ä¼°å·¥æ™‚**: P1 (10min) + P2 (65min) = 75 åˆ†é˜

---

### ä»»å‹™ 2: [P0] åœ–ç‰‡å‰ç«¯é è™•ç† (Client-side Compression)

| ID | ä»»å‹™æè¿° | æª”æ¡ˆè·¯å¾‘ | ç‹€æ…‹ | é©—è­‰è­‰æ“š |
|:---|:---|:---|:---:|:---|
| UP-2.1 | å®‰è£ browser-image-compression | package.json | â¬œ | |
| UP-2.2 | å»ºç«‹ optimizePropertyImage æœå‹™ | src/services/imageService.ts | â¬œ | |
| UP-2.3 | æ•´åˆè‡³ handleFileSelect æµç¨‹ | src/components/upload/UploadContext.tsx | â¬œ | |

**æŠ€è¡“è¦æ ¼**:
- æœ€å¤§å¯¬é«˜: 2048px
- æª”æ¡ˆä¸Šé™: 1.5MB
- ç•«è³ª: 0.85
- è‡ªå‹•ä¿®æ­£ EXIF æ—‹è½‰å•é¡Œ

**é©—æ”¶æ¨™æº– (AC)**:
- [ ] ä¸Šå‚³ 5MB ç…§ç‰‡æ™‚ï¼Œå¯¦éš›å‚³è¼¸æµé‡ < 2MB
- [ ] æ‰‹æ©Ÿæ‹æ”çš„ç…§ç‰‡æ–¹å‘æ­£ç¢ºé¡¯ç¤º

---

### ä»»å‹™ 3: [P1] åœ–ç‰‡ç®¡ç†é‡æ§‹ (Single Truth Management)

| ID | ä»»å‹™æè¿° | æª”æ¡ˆè·¯å¾‘ | ç‹€æ…‹ | é©—è­‰è­‰æ“š |
|:---|:---|:---|:---:|:---|
| UP-3.1 | å®šç¾© ManagedImage ä»‹é¢ | src/types/upload.ts | â¬œ | |
| UP-3.2 | é‡æ§‹ UploadContext ç‹€æ…‹ç®¡ç† | src/components/upload/UploadContext.tsx | â¬œ | |
| UP-3.3 | å¯¦ä½œã€Œè¨­ç‚ºå°é¢ã€åŠŸèƒ½ | src/components/upload/ImagePreview.tsx | â¬œ | |
| UP-3.4 | ç¢ºä¿ç™¼å¸ƒæ™‚ images[0] ç‚ºå°é¢ | src/components/upload/UploadContext.tsx | â¬œ | |

**æŠ€è¡“è¦æ ¼**:
- ManagedImage { id, file, preview, isCover, status }
- status: pending | optimizing | ready

**é©—æ”¶æ¨™æº– (AC)**:
- [ ] é»æ“Šä»»ä¸€å¼µåœ–ç‚ºå°é¢å¾Œï¼Œç™¼å¸ƒå¾Œ images[0] ç‚ºè©²å¼µåœ–
- [ ] åˆªé™¤åœ–ç‰‡æ™‚ï¼ŒFile èˆ‡ preview URL åŒæ­¥æ¸…é™¤
- [ ] é è¦½åœ–é¡¯ç¤ºå„ªåŒ–ç‹€æ…‹ (pending â†’ ready)

---

### ä»»å‹™ 4: [P1] äº®é»è† å›Šèˆ‡è¦æ ¼åˆ†æµ

| ID | ä»»å‹™æè¿° | æª”æ¡ˆè·¯å¾‘ | ç‹€æ…‹ | é©—è­‰è­‰æ“š |
|:---|:---|:---|:---:|:---|
| UP-4.1 | ä¸Šå‚³é ï¼šäº®é»æ¨™ç±¤æ”¹ç‚ºæ‰‹å‹•å‹¾é¸ | src/components/upload/HighlightPicker.tsx | â¬œ | |
| UP-4.2 | é¦–é å¡ç‰‡ï¼šåƒ…æ¸²æŸ“ tags å‰å…©ä½ | src/features/home/PropertyCard.tsx | â¬œ | |
| UP-4.3 | åˆ—è¡¨é ï¼šç§»é™¤é‡è¤‡è¦æ ¼è† å›Š | public/js/property-renderer.js | â¬œ | |
| UP-4.4 | è©³æƒ…é ï¼šäº®é»èˆ‡è¦æ ¼åˆ†å€é¡¯ç¤º | src/pages/PropertyDetailPage.tsx | â¬œ | |

**é è¨­äº®é»é¸é …**:
- å…¨æ–°è£æ½¢ã€è¿‘æ·é‹ã€éœå··ä½å®…ã€æ™¯è§€å„ªç¾
- é«˜æ¨“å±¤ã€é‚Šé–“æ¡å…‰ã€è»Šä½å……è¶³ã€å­¸å€å®…

**é©—æ”¶æ¨™æº– (AC)**:
- [ ] å¡ç‰‡ä¸Šä¸å†å‡ºç¾ã€Œ23åªã€ã€ã€Œ3æˆ¿ã€é‡è¤‡è† å›Š
- [ ] æ‰€æœ‰é é¢äº®é»é †åºèˆ‡ä¸Šå‚³æ™‚ä¸€è‡´
- [ ] æˆ¿ä»²å¯è‡ªè¨‚æœ€å¤š 5 å€‹äº®é»æ¨™ç±¤

---

## âœ… å·²å®Œæˆéšæ®µ (Milestones)

### ï¿½ï¿½ KC-5: æ¸¬è©¦è£œå¼· (2025-12-22) âœ…
- âœ… KC-5.1~5.4: 228 tests passed | Commit: 69701d2

### ğŸ§© KC-4: AI è† å›Šç”Ÿæˆ (2025-12-22) âœ… 97/100
- âœ… KC-4.1~4.3: API + æ•´åˆ + é™ç´š | Commit: f49ee59

### ğŸ§© KC-3: åˆ—è¡¨é è† å›Šæ¸²æŸ“ (2025-12-22) âœ…
- âœ… KC-3.1~3.3: å¤§å¡/æ°´å¹³å¡ tags æ¸²æŸ“

### ğŸ  P11: æˆ¿æºåˆ—è¡¨é å‡ç´š (2025-12-19) âœ…
- âœ… S1-S4, M1-M3, L1: DOM Diffing, Ring Buffer, XSS é˜²è­·
