# 🏠 社區牆 + 信息流 專案工單 (P7 重點執行)

> **專案狀態**: 🟢 P6 已完成 / 🔵 P7 規劃確認
> **最後更新**: 2025-12-13
> **審計等級**: Google L7+ (嚴格安全與架構標準)

---

## 📋 歷史存檔 (P0 - P6 已完成)

> **狀態摘要**: 基礎架構、權限系統、信息流 React 化、Mock 資料分離均已完成並通過嚴格審計。

<details open>
<summary>點擊查看 P0-P6 完成清單與審計紀錄</summary>

### ✅ P0 - P6 核心里程碑

| 階段 | 狀態 | 核心產出 | 審計結果 |
|------|------|----------|----------|
| **P0 基礎建設** | ✅ | 資料庫視圖 (View), API 容錯機制, 環境變數控制 | 通過 |
| **P1 提示/權限** | ✅ | 全域提示 (Toast), 身分驗證 Hook, 角色守衛 | 通過 |
| **P2 資料 Hook** | ✅ | useFeedData (樂觀更新 UI) | 通過 |
| **P3 版面佈局** | ✅ | 全域頁首 (GlobalHeader), 角色導航與標示 | 通過 |
| **P4 發文系統** | ✅ | 無頭元件 Hook (Headless), 驗證邏輯, UI 整合 | 通過 |
| **P5 住戶端 UI** | ✅ | React 頁面重構, Tailwind 樣式, 國際化 (i18n) | 通過 |
| **P6 房仲端 UI** | ✅ | React 頁面重構, Mock 資料模組化分離 | 通過 |
| **P6 嚴格審計** | ✅ | B1-B8 扣分項全數修復 (型別/日誌/常數/防呆) | **完美 (無缺失)** |

### 🔴 P6 嚴格審計 (B1-B8) 修復紀錄 (2025-12-13)
- [x] **B1 (型別安全)**: 移除 `useConsumer.ts` 中所有不安全的 `as any` 斷言。
- [x] **B2 (日誌清理)**: 移除生產環境中的 `console.error`。
- [x] **B3 (去硬編碼)**: 消除所有 `'test-uuid'` 硬編碼字串，改用常數。
- [x] **B5 (圖片防呆)**: 實作圖片載入失敗的替代畫面 (Fallback) 與網格佈局。
- [x] **B1-B8 驗證**: 通過所有 TypeScript 檢查、建置與單元測試。

</details>

---

## 🚀 P7: 私密牆權限體系 (深度規劃)

> **目標**: 實作 Google L7 等級的權限控制體系，確保「私密牆」不僅是介面隱藏，而是具備資料層級的安全防護與優質的轉化體驗。

### 🌟 架構師建議 (優化方案)

我已針對原始需求加入以下架構建議，以確保系統的擴充性與轉化率：

1.  **權限與角色分離 (Capability-Based Control)**
    *   **問題**: 如果直接在程式碼寫死 `if (user.role === 'resident')`，未來新增「管委會」或「VIP」角色時會難以維護。
    *   **建議**: 改用「能力 (Capability)」來判斷，例如 `CAN_VIEW_PRIVATE_WALL`。
    *   **做法**: 建立一個設定檔，將「角色」對應到「能力」。未來業務邏輯變更時，只需修改設定檔，不用改程式碼。

2.  **軟性攔截策略 (Teaser Strategy)**
    *   **概念**: 不要直接阻擋未授權用戶（例如顯示 403 錯誤），這會降低參與感。
    *   **體驗**:讓訪客或未驗證住戶能看到「私密牆」的存在，但內容呈現「模糊化」，並在上方顯示「驗證身分以解鎖」的按鈕。
    *   **效益**: 利用「錯失恐懼 (FOMO)」心理，有效提升註冊與住戶驗證的轉化率。

3.  **設計級安全 (Security by Design)**
    *   **重點**: 前端 Hook 層 (`useFeedData`) 必須在偵測到無權限時，主動拒絕發送 API 請求或只回傳假資料。
    *   **防護**: 不能只依賴 UI 隱藏（避免有心人士透過瀏覽器開發工具讀取隱藏資料）。

---

### 📅 P7 執行清單 (與工單細節)

#### 🔵 下階段 1: 核心權限基礎建設
> 建立可擴展的權限系統，而非散落的邏輯。

- [ ] **P7-1: 定義權限架構** `src/types/permissions.ts`
    - 定義權限清單: `查看私密牆`, `發佈私密貼文`, `查看房仲數據`。
    - 定義角色對照表 (矩陣): 設定哪些角色擁有上述權限。
- [ ] **P7-2: 實作權限 Hook** `src/hooks/usePermission.ts`
    - 實作 `hasPermission()` 檢查邏輯。
    - 整合現有的 `useAuth` 身分資料。

#### 🟡 下階段 2: 路由與組件守衛
> 在介面層統一攔截邏輯。

- [ ] **P7-3: 開發守衛組件** `src/components/auth/Guard.tsx`
    - 開發 `<RequirePermission>` 組件。
    - 支援自定義替代畫面（例如顯示「鎖定畫面」而非一片空白）。
- [ ] **P7-4: 整合住戶端分頁** `src/pages/Feed/Consumer.tsx`
    - 將「私密牆」分頁內容包裹在守衛組件中。

#### 🟠 下階段 3: 私密牆鎖定體驗 (UI/UX)
> 打造高質感的「未授權」體驗。

- [ ] **P7-5: 開發鎖定畫面組件** `src/components/Feed/PrivateWallLocked.tsx`
    - **視覺**: 背景顯示模糊的假貼文 (骨架屏/模糊特效)。
    - **覆蓋層**: 中央顯示鎖頭圖示與引導文案（"僅限社區住戶查看"）。
    - **互動**:
        - 未登入者 -> 點擊彈出登入視窗。
        - 已登入未驗證者 -> 點擊提示「請進行住戶驗證」。

#### 🔴 下階段 4: 資料層安全與驗證
> 確保資料流安全，防止外洩。

- [ ] **P7-6: 資料層安全防護** `useFeedData.ts`
    - 當分頁為 `private` 且用戶無權限時，Hook 應直接回傳空陣列或鎖定狀態，嚴禁發送真實 API 請求。
- [ ] **P7-7: 模擬情境驗證** (測試計畫)
    - 需驗證以下四種情境：
        1.  **訪客**: 看得到分頁，內容鎖定，點擊跳登入。
        2.  **一般會員 (驗證中)**: 看得到分頁，內容鎖定，點擊提示驗證。
        3.  **認證住戶**: 完整瀏覽內容與發文功能。
        4.  **房仲**: 可瀏覽 (唯讀)，不可發文 (隱藏發文框)。

---

## 🧪 驗證標準 (驗收項目)

- [ ] **零資料外洩**: 使用者無法透過開發工具 (DevTools) 修改 CSS 來看到私密內容（確保內容根本沒有被渲染）。
- [ ] **擴充性**: 未來新增角色（如管委會）時，不需修改介面程式碼，僅需調整設定。
- [ ] **無障礙性**: 鎖定畫面需具備正確的 ARIA 標籤，讓螢幕閱讀器能正確朗讀。
- [ ] **測試覆蓋**: 針對權限 Hook 與守衛組件建立完整的單元測試。

---

## 📁 相關檔案索引

| 檔案 | 用途 |
|------|------|
| `src/types/permissions.ts` | **[新增]** 權限定義中心 |
| `src/hooks/usePermission.ts` | **[新增]** 權限檢查 Hook |
| `src/components/Feed/PrivateWallLocked.tsx` | **[新增]** 鎖定畫面 UI |
| `src/pages/Feed/Consumer.tsx` | 分頁切換與整合 |
| `src/hooks/useAuth.ts` | 現有的身分來源 |
