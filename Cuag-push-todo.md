# UAG-14: LINE é€šçŸ¥æ•´åˆ

## ä¹‹å‰åšéŽä»€éº¼

- Phase 1ï¼šDB Schemaï¼ˆline_bindingsã€audit_logsã€queueï¼‰
- Phase 2ï¼šAPIï¼ˆ/api/uag/send-messageã€Connect.tsxï¼‰
- Phase 3ï¼šå‰ç«¯ï¼ˆActionPanel æ–‡å­—ã€SendMessageModalï¼‰
- Phase 4ï¼šUI Feedbackï¼ˆé€šçŸ¥ç‹€æ…‹ã€é˜²é‡è¤‡ï¼‰

---

## Phase 5 é€²åº¦ï¼ˆ4 ä¿® + 8 æ¸¬ï¼‰

| # | é …ç›® | ç‹€æ…‹ |
|---|------|------|
| ä¿®1 | Session Key ä¸ä¸€è‡´ | â³ |
| ä¿®2 | Chat Page å¼·åˆ¶ç™»å…¥ | â³ |
| ä¿®3 | LINE è¨Šæ¯ç¼ºç‰©ä»¶é€£çµ | â³ |
| ä¿®4 | Connect Token æœªå¸¶ç‰©ä»¶ | â³ |
| æ¸¬1 | ç«™å…§è¨Šæ¯ 100% æˆåŠŸ | â³ |
| æ¸¬2 | æœ‰ç¶å®š LINE æ¸¬è©¦ | â³ |
| æ¸¬3 | å°éŽ– OA æ¸¬è©¦ | â³ |
| æ¸¬4 | é€£æŒ‰ 3 æ¬¡ä¸é‡è¤‡ç™¼ | â³ |
| æ¸¬5 | ActionPanel æ–‡å­—ç¢ºèª | â³ |
| æ¸¬6 | æ‰‹å‹•æ¸¬è©¦æœ‰ç¶å®š | â³ |
| æ¸¬7 | æ‰‹å‹•æ¸¬è©¦æœªç¶å®š | â³ |
| æ¸¬8 | æ‰‹å‹•æ¸¬è©¦è·¨è£ç½® | â³ |

---

## 12 é …ç›®é‡é»žèªªæ˜Ž

### ä¿®1ï¼šSession Key ä¸ä¸€è‡´ ðŸ”´
- **å•é¡Œ**ï¼šConnect.tsx ç”¨ `sessionStorage` + `maihouses_consumer_session`ï¼ŒuseChat.ts è®€ `localStorage` + `uag_session`
- **æª”æ¡ˆ**ï¼š`src/pages/Chat/Connect.tsx` L21, L72
- **ä¿®æ³•**ï¼šæ”¹ç”¨ `localStorage` + `uag_session`

### ä¿®2ï¼šChat Page å¼·åˆ¶ç™»å…¥ ðŸ”´
- **å•é¡Œ**ï¼š`isAuthenticated` æª¢æŸ¥è®“åŒ¿å Consumer æ°¸é è¢«æ“‹
- **æª”æ¡ˆ**ï¼š`src/pages/Chat/index.tsx` L43-56
- **ä¿®æ³•**ï¼šåŠ ä¸Š `sessionId` åˆ¤æ–·ï¼Œæœ‰ session å°±æ”¾è¡Œ

### ä¿®3ï¼šLINE è¨Šæ¯ç¼ºç‰©ä»¶é€£çµ ðŸŸ 
- **å•é¡Œ**ï¼šLINE è¨Šæ¯æ²’æœ‰ç‰©ä»¶é é¢é€£çµ
- **æª”æ¡ˆ**ï¼š`api/uag/send-message.ts` buildLineMessage
- **ä¿®æ³•**ï¼šåŠ ä¸Š `ç‰©ä»¶è©³æƒ…ï¼š${propertyUrl}`

### ä¿®4ï¼šConnect Token æœªå¸¶ç‰©ä»¶ ðŸŸ¡
- **å•é¡Œ**ï¼šToken åªæœ‰ conversationId + sessionId
- **æª”æ¡ˆ**ï¼š`api/uag/send-message.ts`ã€`Connect.tsx`
- **ä¿®æ³•**ï¼špayload åŠ å…¥ `propertyId`

---

### æ¸¬1ï¼šç«™å…§è¨Šæ¯ 100% æˆåŠŸ
- **é©—è­‰**ï¼šLINE å¤±æ•—æ™‚ï¼Œç«™å…§è¨Šæ¯ä»æ­£å¸¸ç™¼é€

### æ¸¬2ï¼šæœ‰ç¶å®š LINE æ¸¬è©¦
- **é©—è­‰**ï¼šæ”¶åˆ° LINE é€šçŸ¥ â†’ é»žé€£çµ â†’ é€²æ­£ç¢ºèŠå¤©å®¤

### æ¸¬3ï¼šå°éŽ– OA æ¸¬è©¦
- **é©—è­‰**ï¼šwebhook unfollow å¾Œï¼ŒAssetMonitor é¡¯ç¤ºã€ŒLINE ç„¡æ³•é€é”ã€

### æ¸¬4ï¼šé€£æŒ‰ 3 æ¬¡ä¸é‡è¤‡ç™¼
- **é©—è­‰**ï¼šX-Line-Retry-Key å†ªç­‰æ€§ï¼Œåªç™¼ä¸€å‰‡ LINE

### æ¸¬5ï¼šActionPanel æ–‡å­—ç¢ºèª
- **é©—è­‰**ï¼šL144, L177, L179 ä¸‰è™•ã€Œç°¡è¨Šã€å·²æ”¹ã€ŒLINEã€

### æ¸¬6ï¼šæ‰‹å‹•æ¸¬è©¦æœ‰ç¶å®š
- **é©—è­‰**ï¼šç™¼é€ â†’ æ”¶ LINE â†’ é»žé€£çµ â†’ é€²èŠå¤©å®¤ â†’ èƒ½å°è©±

### æ¸¬7ï¼šæ‰‹å‹•æ¸¬è©¦æœªç¶å®š
- **é©—è­‰**ï¼šåªç™¼ç«™å…§è¨Šæ¯ï¼ŒAssetMonitor é¡¯ç¤ºã€Œåƒ…ç«™å…§ä¿¡ã€

### æ¸¬8ï¼šæ‰‹å‹•æ¸¬è©¦è·¨è£ç½®
- **é©—è­‰**ï¼šLINE å…§å»ºç€è¦½å™¨é»žé€£çµèƒ½æ­£ç¢ºé–‹å•ŸèŠå¤©å®¤

---

> æ›´æ–°ï¼š2026-01-08
