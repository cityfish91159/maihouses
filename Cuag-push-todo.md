# UAG-14: LINE é€šçŸ¥æ•´åˆ

## ä¹‹å‰åšéŽä»€éº¼

- Phase 1ï¼šDB Schemaï¼ˆline_bindingsã€audit_logsã€queueï¼‰
- Phase 2ï¼šAPIï¼ˆ/api/uag/send-messageã€Connect.tsxï¼‰
- Phase 3ï¼šå‰ç«¯ï¼ˆActionPanel æ–‡å­—ã€SendMessageModalï¼‰
- Phase 4ï¼šUI Feedbackï¼ˆé€šçŸ¥ç‹€æ…‹ã€é˜²é‡è¤‡ï¼‰

---

## Phase 5 é€²åº¦ï¼ˆ4 ä¿® + 8 æ¸¬ï¼‰

| # | é …ç›® | ç‹€æ…‹ |
|---|------|------|
| ä¿®1 | Session Key ä¸ä¸€è‡´ | âœ… å·²ä¿®æ­£ (localStorage uag_session) |
| è£œ1 | ç¡¬ç·¨ç¢¼é¡è‰²ä¿®å¾© | âœ… (AssetMonitor.tsx + UAG.module.css) |
| ä¿®2 | Chat Page å¼·åˆ¶ç™»å…¥ | âœ… å·²ä¿®æ­£ (æ”¯æ´ uag_session åŒ¿åç”¨æˆ¶) |
| è£œ2 | useConsumerSession Hook | âœ… å¯©æ ¸é€šéŽ (11 tests + useState/useCallback æ•ˆèƒ½å„ªåŒ–) |
| ä¿®3 | LINE è¨Šæ¯ç¼ºç‰©ä»¶é€£çµ | âœ… å·²ä¿®æ­£ (buildLineMessage åŠ å…¥ propertyUrl) |
| ä¿®4 | Connect Token æœªå¸¶ç‰©ä»¶ | âœ… å·²ä¿®æ­£ (ConnectTokenPayload åŠ å…¥ propertyId) |
| æ¸¬1 | ç«™å…§è¨Šæ¯ 100% æˆåŠŸ | â³ |
| æ¸¬2 | æœ‰ç¶å®š LINE æ¸¬è©¦ | â³ |
| æ¸¬3 | å°éŽ– OA æ¸¬è©¦ | â³ |
| æ¸¬4 | é€£æŒ‰ 3 æ¬¡ä¸é‡è¤‡ç™¼ | â³ |
| æ¸¬5 | ActionPanel æ–‡å­—ç¢ºèª | â³ |
| æ¸¬6 | æ‰‹å‹•æ¸¬è©¦æœ‰ç¶å®š | â³ |
| æ¸¬7 | æ‰‹å‹•æ¸¬è©¦æœªç¶å®š | â³ |
| æ¸¬8 | æ‰‹å‹•æ¸¬è©¦è·¨è£ç½® | â³ |

---

## 12 é …ç›®é‡é»žèªªæ˜Ž

### ä¿®1ï¼šSession Key ä¸ä¸€è‡´ ðŸ”´
- **å•é¡Œ**ï¼šConnect.tsx ç”¨ `sessionStorage` + `maihouses_consumer_session`ï¼ŒuseChat.ts è®€ `localStorage` + `uag_session`
- **æª”æ¡ˆ**ï¼š`src/pages/Chat/Connect.tsx` L21, L72
- **ä¿®æ³•**ï¼šæ”¹ç”¨ `localStorage` + `uag_session`

### ä¿®2ï¼šChat Page å¼·åˆ¶ç™»å…¥ ðŸ”´
- **å•é¡Œ**ï¼š`isAuthenticated` æª¢æŸ¥è®“åŒ¿å Consumer æ°¸é è¢«æ“‹
- **æª”æ¡ˆ**ï¼š`src/pages/Chat/index.tsx` L43-56
- **ä¿®æ³•**ï¼šåŠ ä¸Š `sessionId` åˆ¤æ–·ï¼Œæœ‰ session å°±æ”¾è¡Œ

### ä¿®3ï¼šLINE è¨Šæ¯ç¼ºç‰©ä»¶é€£çµ ðŸŸ 
- **å•é¡Œ**ï¼šLINE è¨Šæ¯æ²’æœ‰ç‰©ä»¶é é¢é€£çµ
- **æª”æ¡ˆ**ï¼š`api/uag/send-message.ts` buildLineMessage
- **ä¿®æ³•**ï¼šåŠ ä¸Š `ç‰©ä»¶è©³æƒ…ï¼š${propertyUrl}`

### ä¿®4ï¼šConnect Token æœªå¸¶ç‰©ä»¶ ðŸŸ¡
- **å•é¡Œ**ï¼šToken åªæœ‰ conversationId + sessionId
- **æª”æ¡ˆ**ï¼š`api/uag/send-message.ts`ã€`Connect.tsx`
- **ä¿®æ³•**ï¼špayload åŠ å…¥ `propertyId`

---

### æ¸¬1ï¼šç«™å…§è¨Šæ¯ 100% æˆåŠŸ
- **å‰ç½®æ¢ä»¶**ï¼šæ¨¡æ“¬ LINE ç™¼é€å¤±æ•—ï¼ˆå¯æš«æ™‚æ”¹éŒ¯ LINE_CHANNEL_ACCESS_TOKENï¼‰
- **æ­¥é©Ÿ**ï¼š
  1. æˆ¿ä»²ç™»å…¥ â†’ é€²å…¥ UAG é é¢
  2. è³¼è²·ä¸€å€‹æœ‰ LINE ç¶å®šçš„ Lead
  3. é»žæ“Š SendMessageModal ç™¼é€è¨Šæ¯
- **é æœŸçµæžœ**ï¼š
  - [ ] API å›žå‚³ `success: true`
  - [ ] `lineStatus: "pending"` æˆ– `"error"`
  - [ ] ç«™å…§è¨Šæ¯æ­£å¸¸é€²å…¥ `messages` è¡¨
  - [ ] Toast é¡¯ç¤ºã€Œè¨Šæ¯å·²ç™¼é€ã€ï¼ˆéžå¤±æ•—ï¼‰

### æ¸¬2ï¼šæœ‰ç¶å®š LINE æ¸¬è©¦
- **å‰ç½®æ¢ä»¶**ï¼šç¢ºèª `uag_line_bindings` æœ‰æ¸¬è©¦å¸³è™Ÿç¶å®š
- **æ­¥é©Ÿ**ï¼š
  1. æˆ¿ä»²ç™¼é€è¨Šæ¯çµ¦å·²ç¶å®š LINE çš„å®¢æˆ¶
  2. ç­‰å¾…æ‰‹æ©Ÿæ”¶åˆ° LINE æŽ¨æ’­
  3. åœ¨ LINE å…§é»žæ“Šé€£çµ
- **é æœŸçµæžœ**ï¼š
  - [ ] æ‰‹æ©Ÿæ”¶åˆ° LINE é€šçŸ¥
  - [ ] è¨Šæ¯åŒ…å«æˆ¿ä»²åç¨±
  - [ ] é»žé€£çµé€²å…¥æ­£ç¢ºçš„ Chat é é¢
  - [ ] Chat é é¢è¼‰å…¥æˆåŠŸï¼Œé¡¯ç¤ºå°è©±å…§å®¹

### æ¸¬3ï¼šå°éŽ– OA æ¸¬è©¦
- **å‰ç½®æ¢ä»¶**ï¼šç”¨æ¸¬è©¦å¸³è™Ÿå°éŽ–é‚æˆ¿å­å®˜æ–¹å¸³è™Ÿ
- **æ­¥é©Ÿ**ï¼š
  1. åœ¨ LINE ä¸­å°éŽ–å®˜æ–¹å¸³è™Ÿ
  2. ç­‰å¾… Webhook æ”¶åˆ° unfollow äº‹ä»¶
  3. æª¢æŸ¥ `uag_line_bindings` è¡¨
  4. å†æ¬¡ç™¼é€è¨Šæ¯çµ¦è©²ç”¨æˆ¶
- **é æœŸçµæžœ**ï¼š
  - [ ] `line_status` è®Šç‚º `'blocked'`
  - [ ] ç™¼é€è¨Šæ¯æ™‚ `lineStatus: "unreachable"`
  - [ ] Toast é¡¯ç¤ºã€ŒLINE ç„¡æ³•é€é”ã€

### æ¸¬4ï¼šé€£æŒ‰ 3 æ¬¡ä¸é‡è¤‡ç™¼
- **å‰ç½®æ¢ä»¶**ï¼šæœ‰ç¶å®šä¸”æœªå°éŽ–çš„æ¸¬è©¦å¸³è™Ÿ
- **æ­¥é©Ÿ**ï¼š
  1. å¿«é€Ÿé€£çºŒé»žæ“Šã€Œç™¼é€ã€æŒ‰éˆ• 3 æ¬¡
  2. æª¢æŸ¥ `uag_line_notification_queue` è¡¨
  3. æª¢æŸ¥æ‰‹æ©Ÿ LINE æ”¶åˆ°çš„è¨Šæ¯æ•¸é‡
- **é æœŸçµæžœ**ï¼š
  - [ ] Queue è¡¨åªæœ‰ 1 ç­†è¨˜éŒ„ï¼ˆ`message_id UNIQUE`ï¼‰
  - [ ] æ‰‹æ©Ÿåªæ”¶åˆ° 1 å‰‡ LINE è¨Šæ¯
  - [ ] ç™¼é€æŒ‰éˆ•æœ‰ `isSending` disabled ç‹€æ…‹

### æ¸¬5ï¼šActionPanel æ–‡å­—ç¢ºèª
- **æ­¥é©Ÿ**ï¼š
  1. ç™»å…¥æˆ¿ä»²å¸³è™Ÿ
  2. é€²å…¥ UAG é é¢
  3. æŸ¥çœ‹ Lead åˆ—è¡¨çš„ ActionPanel
- **é æœŸçµæžœ**ï¼š
  - [ ] L144: é¡¯ç¤ºã€Œç²å–è¯çµ¡æ¬Šé™ (LINE/ç«™å…§ä¿¡)ã€
  - [ ] L177: é¡¯ç¤ºã€ŒLINE/ç«™å…§ä¿¡è¯ç¹«ã€
  - [ ] L179: é¡¯ç¤ºã€Œé€éŽ LINE é€šçŸ¥å®¢æˆ¶ã€
  - [ ] **ä¸**å‡ºç¾ã€Œç°¡è¨Šã€å­—æ¨£

### æ¸¬6ï¼šæ‰‹å‹•æ¸¬è©¦æœ‰ç¶å®šï¼ˆå®Œæ•´æµç¨‹ï¼‰
- **å‰ç½®æ¢ä»¶**ï¼š
  - æˆ¿ä»²å¸³è™Ÿå·²ç™»å…¥
  - æ¸¬è©¦ session å·²ç¶å®š LINE
- **æ­¥é©Ÿ**ï¼š
  1. è³¼è²· Lead â†’ é–‹å•Ÿ SendMessageModal
  2. è¼¸å…¥è¨Šæ¯ã€Œæ¸¬è©¦è¨Šæ¯ - æœ‰ç¶å®šã€
  3. é»žæ“Šç™¼é€
  4. ç­‰å¾… LINE é€šçŸ¥
  5. åœ¨ LINE å…§é»žæ“Šé€£çµ
  6. åœ¨ Chat é é¢å›žè¦†è¨Šæ¯
- **é æœŸçµæžœ**ï¼š
  - [ ] Toast é¡¯ç¤ºã€Œå·²åŒæ™‚é€éŽ LINE é€šçŸ¥å®¢æˆ¶ã€
  - [ ] æ‰‹æ©Ÿ LINE æ”¶åˆ°é€šçŸ¥
  - [ ] é»žé€£çµé€²å…¥ Chat é é¢
  - [ ] å¯æ­£å¸¸å›žè¦†è¨Šæ¯ï¼ˆé›™å‘æºé€šï¼‰

### æ¸¬7ï¼šæ‰‹å‹•æ¸¬è©¦æœªç¶å®š
- **å‰ç½®æ¢ä»¶**ï¼š
  - Lead å°æ‡‰çš„ session ç„¡ LINE ç¶å®š
- **æ­¥é©Ÿ**ï¼š
  1. è³¼è²·æœªç¶å®š LINE çš„ Lead
  2. ç™¼é€è¨Šæ¯
- **é æœŸçµæžœ**ï¼š
  - [ ] Toast é¡¯ç¤ºã€Œå®¢æˆ¶æœªç¶å®š LINEï¼Œåƒ…ç™¼é€ç«™å…§è¨Šæ¯ã€
  - [ ] `notification_status` ç‚º `'no_line'`
  - [ ] ç«™å…§è¨Šæ¯æ­£å¸¸ç™¼é€
  - [ ] æ‰‹æ©Ÿ**ä¸æœƒ**æ”¶åˆ° LINE é€šçŸ¥

### æ¸¬8ï¼šæ‰‹å‹•æ¸¬è©¦è·¨è£ç½®
- **å‰ç½®æ¢ä»¶**ï¼šå·²å®Œæˆæ¸¬6
- **æ­¥é©Ÿ**ï¼š
  1. åœ¨æ‰‹æ©Ÿ LINE æ”¶åˆ°é€šçŸ¥
  2. ä½¿ç”¨ LINE å…§å»ºç€è¦½å™¨é–‹å•Ÿé€£çµ
  3. ç¢ºèª Chat é é¢æ­£å¸¸è¼‰å…¥
  4. å˜—è©¦åœ¨ LINE ç€è¦½å™¨å…§ç™¼é€è¨Šæ¯
- **é æœŸçµæžœ**ï¼š
  - [ ] LINE WebView æ­£ç¢ºé–‹å•Ÿ Chat é é¢
  - [ ] Session æ­£ç¢ºæ¢å¾©ï¼ˆç„¡éœ€ç™»å…¥ï¼‰
  - [ ] é é¢é¡¯ç¤ºæ­£ç¢ºçš„å°è©±å…§å®¹
  - [ ] å¯åœ¨ LINE ç€è¦½å™¨å…§æ­£å¸¸å°è©±

---

> æ›´æ–°ï¼š2026-01-09
