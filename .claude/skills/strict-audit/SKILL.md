---
name: strict-audit
description: 嚴格代碼審核流程，禁止捏造結果、跳過步驟、淺薄分析。每個發現必須有 file:line 證據。
---

# 嚴格審核 Skill

**觸發指令:** `/strict-audit` 或用戶明確要求「審核」「code review」「稽核」

---

## 🚨 絕對禁止行為

1. **禁止捏造審核結果** - 絕對不能給出沒有實際閱讀代碼的分數或評價
2. **禁止跳過步驟** - 必須完整執行 Phase 1-5，不能省略任何階段
3. **禁止淺薄分析** - 不能只看檔名或 import 就下結論
4. **禁止假裝完成** - 沒做完的 phase 不能標記為完成
5. **禁止給 100 分** - 除非代碼真的完美到極致（幾乎不可能）

---

## 強制執行流程（5 Phases）

### Phase 1: 完整盤點（INVENTORY）

**目標:** 建立審核範圍清單

**必須執行:**
1. 使用 `Glob` 找出所有待審核檔案
2. 使用 `Read` 讀取**每一個**檔案的完整內容
3. 輸出清單，格式：
   ```
   已讀取檔案清單:
   1. src/pages/TrustRoom.tsx (445 行)
   2. src/components/AgentTrustCard.tsx (277 行)
   ...
   ```

**檢查點:** 用戶確認「已讀清單正確」後才能進入 Phase 2

---

### Phase 2: 問題收集（COLLECT ISSUES）

**目標:** 逐檔找出所有問題

**必須執行:**
1. 逐個檔案深度閱讀
2. 每個問題**必須**包含：
   - 檔案路徑
   - 行號範圍
   - 問題描述
   - 嚴重性（P0/P1/P2）
   - 引用實際代碼片段（用 ``` 包裹）

**格式範例:**
```markdown
### 問題 #1: 硬編碼顏色未使用 design token

**檔案:** `src/components/AgentTrustCard.tsx`
**行號:** L243
**嚴重性:** P1

**問題代碼:**
```typescript
className="bg-[#06C755] hover:bg-[#05B04A]"
```

**說明:** LINE 品牌綠使用硬編碼 hex 值

**建議修復:** 抽為常數或保留（LINE 官方指定色）
```

**檢查點:** 至少要有 5 個以上有證據的問題，否則代表審核不夠深入

---

### Phase 3: 自動化檢查（AUTO CHECKS）

**目標:** 執行工具驗證

**必須執行:**
```bash
npm run typecheck
npm run lint
npm test
```

**輸出格式:**
```
自動化檢查結果:
✅ typecheck: 通過 (0 errors)
✅ lint: 通過 (0 warnings)
✅ test: 145/145 通過
```

**如果有錯誤:** 必須列出前 10 個錯誤的完整訊息

---

### Phase 4: 評分計算（SCORING）

**目標:** 基於 CODE_REVIEW_METHODOLOGY.md 7 維度評分

**評分維度:**
| 維度 | 權重 | 檢查項 |
|-----|------|-------|
| 功能正確性 | 25% | 邊界處理、錯誤處理、業務邏輯正確性 |
| 可讀性 | 20% | 命名、註解、函數長度、複雜度 |
| 測試覆蓋 | 15% | 測試檔案存在、邊界測試、mock 使用 |
| 安全性 | 15% | 輸入驗證、XSS/SQL Injection、密鑰洩漏 |
| 效能 | 10% | memo/useMemo、不必要 re-render、記憶體洩漏 |
| 設計一致性 | 10% | design tokens、SVG icon、文案風格 |
| 複雜度 | 5% | 嵌套層數、函數行數、認知負擔 |

**扣分規則:**
- P0 問題: 每個 -5 ~ -10 分
- P1 問題: 每個 -3 ~ -5 分
- P2 問題: 每個 -1 ~ -3 分

**評分範圍:**
- 95-100: 近乎完美（極少見）
- 85-94: 良好
- 75-84: 可接受
- 60-74: 需要重大改進
- <60: 建議重寫

**輸出格式:**
```
檔案: src/pages/TrustRoom.tsx
基礎分: 100

P0 問題:
- Toast 缺少 ARIA 屬性 (-10)

P1 問題:
- 文案用語不一致 (-5)
- 進度計算可讀性差 (-4)

P2 問題:
- 魔法數字未抽取 (-3)

最終: 100 - 10 - 5 - 4 - 3 = 78/100
```

---

### Phase 5: 報告輸出（REPORT）

**目標:** 生成結構化審核報告

**必須包含:**
1. 執行摘要（總分、通過狀態）
2. 自動化檢查結果
3. 逐檔評分和問題清單
4. 跨檔案問題總結
5. 總體建議（P0/P1/P2 分類）

**輸出位置:** 直接在對話框，除非用戶明確要求寫入檔案

---

## 使用範例

**用戶指令:**
```
/strict-audit 審核 src/pages/TrustRoom.tsx 和 src/components/AgentTrustCard.tsx
```

**AI 執行流程:**
1. Phase 1: Glob + Read 兩個檔案，輸出已讀清單
2. 等待用戶確認「清單正確」
3. Phase 2: 逐檔深度閱讀，收集問題（每個問題有 file:line + code snippet）
4. Phase 3: 執行 typecheck/lint/test
5. Phase 4: 計算加權評分
6. Phase 5: 輸出完整報告到對話框

---

## 自我檢查清單

在完成審核前，AI 必須確認：

- [ ] 我已經用 Read 工具讀取了**每一個**待審核檔案
- [ ] 每個問題都有 `file:line` 引用
- [ ] 每個問題都有實際代碼片段引用
- [ ] 我執行了 typecheck/lint/test 並看到了實際輸出
- [ ] 評分有明確的扣分依據
- [ ] 我沒有給任何檔案 100 分（除非它真的完美）
- [ ] 我沒有跳過任何 Phase
- [ ] 我沒有捏造任何結果

**如果有任何一項打勾為 false，該審核無效，必須重做。**

---

## 常見錯誤警示

### ❌ 錯誤示範 1: 沒讀代碼就給分
```
TrustRoom.tsx: 95/100 (很好，沒什麼問題)
```
→ **違規:** 沒有 file:line 引用，沒有實際問題列表

### ❌ 錯誤示範 2: 只看 import 就下結論
```
這個檔案 import 了 React，應該是 React 組件，看起來不錯
```
→ **違規:** 沒有讀取檔案內容，只看到 import

### ❌ 錯誤示範 3: 跳過 Phase
```
直接跳到評分，沒有先盤點檔案清單
```
→ **違規:** Phase 1 被跳過

### ✅ 正確示範
```
Phase 1 已讀清單:
1. src/pages/TrustRoom.tsx (445 行) ✓
2. src/components/AgentTrustCard.tsx (277 行) ✓

Phase 2 問題收集:
問題 #1: L243 硬編碼顏色
檔案: src/components/AgentTrustCard.tsx
```typescript
className="bg-[#06C755]"
```
建議: 抽為 LINE_BRAND_GREEN 常數
...
```

---

## 觸發條件

當用戶說出以下關鍵字時，自動載入此 Skill：
- 「審核」
- 「code review」
- 「稽核」
- 「檢查代碼」
- 「品質檢查」
- `/strict-audit`

---

**版本:** 1.0
**最後更新:** 2026-02-06
